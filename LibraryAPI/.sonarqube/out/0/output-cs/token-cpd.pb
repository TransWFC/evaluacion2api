ﬂE
NC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\UserService.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

class 
UserService 
{ 
private 
readonly 
IMongoCollection )
<) *
User* .
>. /
_users0 6
;6 7
public

 
UserService

 
(

 
MongoDBService

 )
mongoDBService

* 8
)

8 9
{ 	
_users 
= 
mongoDBService #
.# $
Users$ )
;) *
} 	
public 
async 
Task 
< 
User 
? 
>  "
GetUserByUserNameAsync! 7
(7 8
string8 >
username? G
)G H
{ 	
return 
await 
_users 
.  
Find  $
($ %
u% &
=>' )
u* +
.+ ,
Username, 4
==5 7
username8 @
&&A C
uD E
.E F
IsActiveF N
)N O
. 
FirstOrDefaultAsync $
($ %
)% &
;& '
} 	
public 
async 
Task 
< 
User 
? 
>  
CreateUserAsync! 0
(0 1
User1 5
user6 :
,: ;
string< B
passwordC K
)K L
{ 	
var 
existingUser 
= 
await $
_users% +
.+ ,
Find, 0
(0 1
u1 2
=>3 5
u6 7
.7 8
Username8 @
==A C
userD H
.H I
UsernameI Q
)Q R
. 
FirstOrDefaultAsync $
($ %
)% &
;& '
if 
( 
existingUser 
!= 
null  $
)$ %
{ 
return 
null 
; 
} 
user 
. 
PasswordHash 
= 
PasswordHasher  .
.. /
HashPassword/ ;
(; <
password< D
)D E
;E F
await 
_users 
. 
InsertOneAsync '
(' (
user( ,
), -
;- .
return   
user   
;   
}!! 	
public## 
async## 
Task## 
<## 
bool## 
>## 
UpdateUserAsync##  /
(##/ 0
string##0 6
userId##7 =
,##= >
User##? C
updatedUser##D O
,##O P
string##Q W
?##W X
newPassword##Y d
=##e f
null##g k
)##k l
{$$ 	
var%% 
update%% 
=%% 
Builders%% !
<%%! "
User%%" &
>%%& '
.%%' (
Update%%( .
.&& 
Set&& 
(&& 
u&& 
=>&& 
u&& 
.&& 
Email&& !
,&&! "
updatedUser&&# .
.&&. /
Email&&/ 4
)&&4 5
;&&5 6
if(( 
((( 
!(( 
string(( 
.(( 
IsNullOrEmpty(( %
(((% &
newPassword((& 1
)((1 2
)((2 3
{)) 
update** 
=** 
update** 
.**  
Set**  #
(**# $
u**$ %
=>**& (
u**) *
.*** +
PasswordHash**+ 7
,**7 8
PasswordHasher**9 G
.**G H
HashPassword**H T
(**T U
newPassword**U `
)**` a
)**a b
;**b c
}++ 
var-- 
result-- 
=-- 
await-- 
_users-- %
.--% &
UpdateOneAsync--& 4
(--4 5
u.. 
=>.. 
u.. 
... 
Id.. 
==.. 
userId.. #
,..# $
update// 
)// 
;// 
return11 
result11 
.11 
ModifiedCount11 '
>11( )
$num11* +
;11+ ,
}22 	
public44 
async44 
Task44 
<44 
bool44 
>44 
DeActivateUserAsync44  3
(443 4
string444 :
userId44; A
)44A B
{55 	
var66 
update66 
=66 
Builders66 !
<66! "
User66" &
>66& '
.66' (
Update66( .
.77 
Set77 
(77 
u77 
=>77 
u77 
.77 
IsActive77 $
,77$ %
false77& +
)77+ ,
;77, -
var99 
result99 
=99 
await99 
_users99 %
.99% &
UpdateOneAsync99& 4
(994 5
u:: 
=>:: 
u:: 
.:: 
Id:: 
==:: 
userId:: #
,::# $
update;; 
);; 
;;; 
return== 
result== 
.== 
ModifiedCount== '
>==( )
$num==* +
;==+ ,
}>> 	
publicAA 
asyncAA 
TaskAA 
<AA 
IEnumerableAA %
<AA% &
UserAA& *
>AA* +
>AA+ ,
GetUserByRoleAsyncAA- ?
(AA? @
stringAA@ F
roleAAG K
)AAK L
{BB 	
returnCC 
awaitCC 
_usersCC 
.CC  
FindCC  $
(CC$ %
uCC% &
=>CC' )
uCC* +
.CC+ ,
RoleCC, 0
==CC1 3
roleCC4 8
&&CC9 ;
uCC< =
.CC= >
IsActiveCC> F
)CCF G
.DD 
ToListAsyncDD 
(DD 
)DD 
;DD 
}EE 	
publicHH 
asyncHH 
TaskHH 
<HH 
IEnumerableHH %
<HH% &
UserHH& *
>HH* +
>HH+ ,
GetAllUsersAsyncHH- =
(HH= >
)HH> ?
{II 	
returnJJ 
awaitJJ 
_usersJJ 
.JJ  
FindJJ  $
(JJ$ %
uJJ% &
=>JJ' )
uJJ* +
.JJ+ ,
IsActiveJJ, 4
)JJ4 5
.KK 
ToListAsyncKK 
(KK 
)KK 
;KK 
}LL 	
publicOO 
asyncOO 
TaskOO 
<OO 
boolOO 
>OO 
UpdateUserRoleAsyncOO  3
(OO3 4
stringOO4 :
userIdOO; A
,OOA B
stringOOC I
newRoleOOJ Q
)OOQ R
{PP 	
varQQ 
allowedRolesQQ 
=QQ 
newQQ "
[QQ" #
]QQ# $
{QQ% &
$strQQ' 6
}QQ7 8
;QQ8 9
ifSS 
(SS 
!SS 
allowedRolesSS 
.SS 
ContainsSS &
(SS& '
newRoleSS' .
)SS. /
)SS/ 0
{TT 
returnUU 
falseUU 
;UU 
}VV 
varXX 
updateXX 
=XX 
BuildersXX !
<XX! "
UserXX" &
>XX& '
.XX' (
UpdateXX( .
.YY 
SetYY 
(YY 
uYY 
=>YY 
uYY 
.YY 
RoleYY  
,YY  !
newRoleYY" )
)YY) *
;YY* +
var[[ 
result[[ 
=[[ 
await[[ 
_users[[ %
.[[% &
UpdateOneAsync[[& 4
([[4 5
u\\ 
=>\\ 
u\\ 
.\\ 
Id\\ 
==\\ 
userId\\ #
,\\# $
update]] 
)]] 
;]] 
return__ 
result__ 
.__ 
ModifiedCount__ '
>__( )
$num__* +
;__+ ,
}`` 	
publiccc 
asynccc 
Taskcc 
<cc 
Usercc 
?cc 
>cc  
GetUserByIdAsynccc! 1
(cc1 2
stringcc2 8
userIdcc9 ?
)cc? @
{dd 	
returnee 
awaitee 
_usersee 
.ee  
Findee  $
(ee$ %
uee% &
=>ee' )
uee* +
.ee+ ,
Idee, .
==ee/ 1
userIdee2 8
&&ee9 ;
uee< =
.ee= >
IsActiveee> F
)eeF G
.ff 
FirstOrDefaultAsyncff $
(ff$ %
)ff% &
;ff& '
}gg 	
}hh 
}ii ú	
TC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\PasswordValidator.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

static 
class 
PasswordValidator )
{ 
private 
static 
readonly 
Regex  %
PasswordRegex& 3
=4 5
new6 9
Regex: ?
(? @
$str		 4
,		4 5
RegexOptions

 
.

 
Compiled

 !
)

! "
;

" #
public 
static 
bool 
IsValid "
(" #
string# )
?) *
password+ 3
)3 4
{ 	
if 
( 
string 
. 
IsNullOrWhiteSpace )
() *
password* 2
)2 3
)3 4
return 
false 
; 
return 
PasswordRegex  
.  !
IsMatch! (
(( )
password) 1
)1 2
;2 3
} 	
} 
} Ö'
QC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\PasswordHasher.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

class 
PasswordHasher 
{ 
private 
const 
int 
SaltSize "
=# $
$num% '
;' (
private 
const 
int 
HashSize "
=# $
$num% '
;' (
private		 
const		 
int		 

Iterations		 $
=		% &
$num		' .
;		. /
public 
static 
string 
HashPassword )
() *
string* 0
password1 9
)9 :
{ 	
using 
( 
var 
rng 
= !
RandomNumberGenerator 2
.2 3
Create3 9
(9 :
): ;
); <
{ 
byte 
[ 
] 
salt 
= 
new !
byte" &
[& '
SaltSize' /
]/ 0
;0 1
rng 
. 
GetBytes 
( 
salt !
)! "
;" #
using 
( 
var 
pbkdf2 !
=" #
new$ '
Rfc2898DeriveBytes( :
(: ;
password; C
,C D
saltE I
,I J

IterationsK U
,U V
HashAlgorithmNameW h
.h i
SHA256i o
)o p
)p q
{ 
byte 
[ 
] 
hash 
=  !
pbkdf2" (
.( )
GetBytes) 1
(1 2
HashSize2 :
): ;
;; <
byte 
[ 
] 
	hashBytes $
=% &
new' *
byte+ /
[/ 0
SaltSize0 8
+9 :
HashSize; C
]C D
;D E
Array 
. 
Copy 
( 
salt #
,# $
$num% &
,& '
	hashBytes( 1
,1 2
$num3 4
,4 5
SaltSize6 >
)> ?
;? @
Array 
. 
Copy 
( 
hash #
,# $
$num% &
,& '
	hashBytes( 1
,1 2
SaltSize3 ;
,; <
HashSize= E
)E F
;F G
return 
Convert "
." #
ToBase64String# 1
(1 2
	hashBytes2 ;
); <
;< =
} 
} 
} 	
public 
static 
bool 
VerifyPassword )
() *
string* 0
password1 9
,9 :
string; A
hashedPasswordB P
)P Q
{ 	
byte 
[ 
] 
	hashBytes 
= 
Convert &
.& '
FromBase64String' 7
(7 8
hashedPassword8 F
)F G
;G H
byte 
[ 
] 
salt 
= 
new 
byte "
[" #
SaltSize# +
]+ ,
;, -
Array!! 
.!! 
Copy!! 
(!! 
	hashBytes!!  
,!!  !
$num!!" #
,!!# $
salt!!% )
,!!) *
$num!!+ ,
,!!, -
SaltSize!!. 6
)!!6 7
;!!7 8
using"" 
("" 
var"" 
pbkdf2"" 
="" 
new""  #
Rfc2898DeriveBytes""$ 6
(""6 7
password""7 ?
,""? @
salt""A E
,""E F

Iterations""G Q
,""Q R
HashAlgorithmName""S d
.""d e
SHA256""e k
)""k l
)""l m
{## 
byte$$ 
[$$ 
]$$ 
hash$$ 
=$$ 
pbkdf2$$ $
.$$$ %
GetBytes$$% -
($$- .
HashSize$$. 6
)$$6 7
;$$7 8
for%% 
(%% 
int%% 
i%% 
=%% 
$num%% 
;%% 
i%%  !
<%%" #
HashSize%%$ ,
;%%, -
i%%. /
++%%/ 1
)%%1 2
{&& 
if'' 
('' 
	hashBytes'' !
[''! "
i''" #
+''$ %
SaltSize''& .
]''. /
!=''0 2
hash''3 7
[''7 8
i''8 9
]''9 :
)'': ;
{(( 
return)) 
false)) $
;))$ %
}** 
}++ 
return,, 
true,, 
;,, 
}-- 
}.. 	
}// 
}00 „ 
QC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\MongoDbService.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

class 
MongoDBService 
{ 
public		 
IMongoDatabase		 
	_database		 '
{		( )
get		* -
;		- .
}		/ 0
public 
MongoDBService 
( 
IConfiguration ,
configuration- :
): ;
{ 	
var 
client 
= 
new 
MongoClient (
(( )
configuration) 6
.6 7

GetSection7 A
(A B
$strB \
)\ ]
.] ^
Value^ c
)c d
;d e
	_database 
= 
client 
. 
GetDatabase *
(* +
configuration+ 8
.8 9

GetSection9 C
(C D
$strD Z
)Z [
.[ \
Value\ a
)a b
;b c
} 	
public 
IMongoCollection 
<  
User  $
>$ %
Users& +
=>, .
	_database/ 8
.8 9
GetCollection9 F
<F G
UserG K
>K L
(L M
$strM T
)T U
;U V
public 
IMongoCollection 
<  
LogEntry  (
>( )

LogEntries* 4
=>5 7
	_database8 A
.A B
GetCollectionB O
<O P
LogEntryP X
>X Y
(Y Z
$strZ f
)f g
;g h
public 
async 
Task 
CreateIndexesAsync ,
(, -
)- .
{ 	
var 
userBuilder 
= 
Builders &
<& '
User' +
>+ ,
., -
	IndexKeys- 6
;6 7
var 
userIndexes 
= 
new !
[! "
]" #
{ 
new 
CreateIndexModel $
<$ %
User% )
>) *
(* +
userBuilder+ 6
.6 7
	Ascending7 @
(@ A
uA B
=>C E
uF G
.G H
UsernameH P
)P Q
,Q R
newS V
CreateIndexOptionsW i
{j k
Uniquel r
=s t
trueu y
}z {
){ |
,| }
new 
CreateIndexModel $
<$ %
User% )
>) *
(* +
userBuilder+ 6
.6 7
	Ascending7 @
(@ A
uA B
=>C E
uF G
.G H
EmailH M
)M N
,N O
newP S
CreateIndexOptionsT f
{g h
Uniquei o
=p q
truer v
}w x
)x y
} 
; 
await 
Users 
. 
Indexes 
.  
CreateManyAsync  /
(/ 0
userIndexes0 ;
); <
;< =
var 

logBuilder 
= 
Builders %
<% &
LogEntry& .
>. /
./ 0
	IndexKeys0 9
;9 :
var 

logIndexes 
= 
new  
[  !
]! "
{   
new!! 
CreateIndexModel!! $
<!!$ %
LogEntry!!% -
>!!- .
(!!. /

logBuilder!!/ 9
.!!9 :
	Ascending!!: C
(!!C D
l!!D E
=>!!F H
l!!I J
.!!J K
	Timestamp!!K T
)!!T U
)!!U V
}"" 
;"" 
await## 

LogEntries## 
.## 
Indexes## $
.##$ %
CreateManyAsync##% 4
(##4 5

logIndexes##5 ?
)##? @
;##@ A
}$$ 	
}%% 
}&& π4
MC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\Logservice.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

class 

Logservice 
{		 
private

 
readonly

 
IMongoCollection

 )
<

) *
LogEntry

* 2
>

2 3
_logs

4 9
;

9 :
private 
readonly 
ILogger  
<  !

Logservice! +
>+ ,
_logger- 4
;4 5
private 
readonly  
IHttpContextAccessor - 
_httpContextAccessor. B
;B C
private 
static 
readonly 
EventId  '
GeneralLogEvent( 7
=8 9
new: =
(= >
$num> B
,B C
$strD M
)M N
;N O
private 
const 
string 
LogTemplate (
=) *
$str i
;i j
public 

Logservice 
( 
MongoDBService 
mongoDBService )
,) *
ILogger 
< 

Logservice 
> 
logger  &
,& ' 
IHttpContextAccessor  
httpContextAccessor! 4
)4 5
{ 	
_logs 
= 
mongoDBService "
." #

LogEntries# -
;- .
_logger 
= 
logger 
;  
_httpContextAccessor  
=! "
httpContextAccessor# 6
;6 7
} 	
public 
async 
Task 
LogAsync "
(" #
string# )
level* /
,/ 0
string1 7
message8 ?
,? @
	ExceptionA J
?J K
	exceptionL U
=V W
nullX \
,\ ]
CancellationToken^ o
ctp r
=s t
defaultu |
)| }
{ 	
var 
http 
=  
_httpContextAccessor +
.+ ,
HttpContext, 7
;7 8
var 
username 
= 
http 
?  
.  !
User! %
?% &
.& '
Identity' /
?/ 0
.0 1
Name1 5
;5 6
var   

controller   
=   
http   !
?  ! "
.  " #
Request  # *
?  * +
.  + ,
RouteValues  , 7
[  7 8
$str  8 D
]  D E
?  E F
.  F G
ToString  G O
(  O P
)  P Q
;  Q R
var!! 
action!! 
=!! 
http!! 
?!! 
.!! 
Request!! &
?!!& '
.!!' (
RouteValues!!( 3
[!!3 4
$str!!4 <
]!!< =
?!!= >
.!!> ?
ToString!!? G
(!!G H
)!!H I
;!!I J
var"" 
traceId"" 
="" 
http"" 
?"" 
.""  
TraceIdentifier""  /
;""/ 0
var$$ 
logEntry$$ 
=$$ 
new$$ 
LogEntry$$ '
{%% 
	Timestamp&& 
=&& 
DateTime&& $
.&&$ %
UtcNow&&% +
,&&+ ,
Level'' 
='' 
level'' 
,'' 
Message(( 
=(( 
message(( !
,((! "
	Exception)) 
=)) 
	exception)) %
?))% &
.))& '
ToString))' /
())/ 0
)))0 1
,))1 2
Username** 
=** 
username** #
,**# $

Controller++ 
=++ 

controller++ '
,++' (
Action,, 
=,, 
action,, 
}-- 
;-- 
await// 
_logs// 
.// 
InsertOneAsync// &
(//& '
logEntry//' /
,/// 0
cancellationToken//1 B
://B C
ct//D F
)//F G
;//G H
var22 
logLevel22 
=22 
MapLevel22 #
(22# $
level22$ )
)22) *
;22* +
_logger33 
.33 
Log33 
(33 
logLevel44 
,44 
GeneralLogEvent55 
,55  
	exception66 
,66 
LogTemplate77 
,77 
level88 
,88 
message99 
,99 
username:: 
,:: 

controller;; 
,;; 
action<< 
,<< 
traceId== 
)>> 
;>> 
}?? 	
privateAA 
staticAA 
LogLevelAA 
MapLevelAA  (
(AA( )
stringAA) /
?AA/ 0
levelAA1 6
)AA6 7
=>AA8 :
levelBB 
isBB 
nullBB 
?BB 
LogLevelBB $
.BB$ %
DebugBB% *
:BB+ ,
levelCC 
.CC 
EqualsCC 
(CC 
$strCC  
,CC  !
StringComparisonCC" 2
.CC2 3
OrdinalIgnoreCaseCC3 D
)CCD E
?CCF G
LogLevelCCH P
.CCP Q
ErrorCCQ V
:CCW X
levelDD 
.DD 
EqualsDD 
(DD 
$strDD "
,DD" #
StringComparisonDD$ 4
.DD4 5
OrdinalIgnoreCaseDD5 F
)DDF G
?DDH I
LogLevelDDJ R
.DDR S
WarningDDS Z
:DD[ \
levelEE 
.EE 
EqualsEE 
(EE 
$strEE &
,EE& '
StringComparisonEE( 8
.EE8 9
OrdinalIgnoreCaseEE9 J
)EEJ K
?EEL M
LogLevelEEN V
.EEV W
InformationEEW b
:EEc d
levelFF 
.FF 
EqualsFF 
(FF 
$strFF #
,FF# $
StringComparisonFF% 5
.FF5 6
OrdinalIgnoreCaseFF6 G
)FFG H
?FFI J
LogLevelFFK S
.FFS T
CriticalFFT \
:FF] ^
levelGG 
.GG 
EqualsGG 
(GG 
$strGG  
,GG  !
StringComparisonGG" 2
.GG2 3
OrdinalIgnoreCaseGG3 D
)GGD E
?GGF G
LogLevelGGH P
.GGP Q
TraceGGQ V
:GGW X
LogLevelHH 
.HH 
DebugHH 
;HH 
}II 
}JJ ⁄™
NC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\LoanService.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

class 
LoanService 
{ 
private		 
readonly		 
IMongoCollection		 )
<		) *
Loan		* .
>		. /
_loans		0 6
;		6 7
private

 
readonly

 
BookService

 $
_bookService

% 1
;

1 2
private 
readonly 
UserService $
_userService% 1
;1 2
private 
readonly 

Logservice #
_logService$ /
;/ 0
private 
const 
int 
MAX_LOAN_DAYS '
=( )
$num* ,
;, -
private 
const 
int %
MAX_ACTIVE_LOANS_PER_USER 3
=4 5
$num6 7
;7 8
private 
const 
string 
LogError %
=& '
$str( /
;/ 0
private 
const 
string 

LogWarning '
=( )
$str* 3
;3 4
private 
const 
string 
LogInfo $
=% &
$str' 4
;4 5
public 
LoanService 
( 
MongoDBService 
mongoDBService )
,) *
BookService 
bookService #
,# $
UserService 
userService #
,# $

Logservice 

logService !
)! "
{ 	
_loans 
= 
mongoDBService #
.# $
	_database$ -
.- .
GetCollection. ;
<; <
Loan< @
>@ A
(A B
$strB I
)I J
;J K
_bookService 
= 
bookService &
;& '
_userService 
= 
userService &
;& '
_logService 
= 

logService $
;$ %
} 	
public   
async   
Task   
<   
IEnumerable   %
<  % &
LoanResponseDTO  & 5
>  5 6
>  6 7
GetAllLoansAsync  8 H
(  H I
)  I J
{!! 	
await"" 
_logService"" 
."" 
LogAsync"" &
(""& '
LogInfo""' .
,"". /
$str""0 Q
)""Q R
;""R S
var$$ 
loans$$ 
=$$ 
await$$ 
_loans$$ $
.$$$ %
Find$$% )
($$) *
_$$* +
=>$$, .
true$$/ 3
)$$3 4
.%% 
SortByDescending%% !
(%%! "
l%%" #
=>%%$ &
l%%' (
.%%( )
	CreatedAt%%) 2
)%%2 3
.&& 
ToListAsync&& 
(&& 
)&& 
;&& 
return(( 
loans(( 
.(( 
Select(( 
(((  
MapToResponseDTO((  0
)((0 1
;((1 2
})) 	
public++ 
async++ 
Task++ 
<++ 
IEnumerable++ %
<++% &
LoanResponseDTO++& 5
>++5 6
>++6 7
GetLoansByUserAsync++8 K
(++K L
string++L R
username++S [
)++[ \
{,, 	
await-- 
_logService-- 
.-- 
LogAsync-- &
(--& '
LogInfo--' .
,--. /
$"--0 2
$str--2 U
{--U V
username--V ^
}--^ _
"--_ `
)--` a
;--a b
var// 
loans// 
=// 
await// 
_loans// $
.//$ %
Find//% )
(//) *
l//* +
=>//, .
l/// 0
.//0 1
Username//1 9
==//: <
username//= E
)//E F
.00 
SortByDescending00 !
(00! "
l00" #
=>00$ &
l00' (
.00( )
	CreatedAt00) 2
)002 3
.11 
ToListAsync11 
(11 
)11 
;11 
return33 
loans33 
.33 
Select33 
(33  
MapToResponseDTO33  0
)330 1
;331 2
}44 	
public66 
async66 
Task66 
<66 
IEnumerable66 %
<66% &
LoanResponseDTO66& 5
>665 6
>666 7%
GetActiveLoansByUserAsync668 Q
(66Q R
string66R X
username66Y a
)66a b
{77 	
await88 
_logService88 
.88 
LogAsync88 &
(88& '
LogInfo88' .
,88. /
$"880 2
$str882 ]
{88] ^
username88^ f
}88f g
"88g h
)88h i
;88i j
var:: 
loans:: 
=:: 
await:: 
_loans:: $
.::$ %
Find::% )
(::) *
l::* +
=>::, .
l::/ 0
.::0 1
Username::1 9
==::: <
username::= E
&&::F H
l::I J
.::J K
Status::K Q
==::R T

LoanStatus::U _
.::_ `
Active::` f
)::f g
.;; 
SortBy;; 
(;; 
l;; 
=>;; 
l;; 
.;; 
DueDate;; &
);;& '
.<< 
ToListAsync<< 
(<< 
)<< 
;<< 
return>> 
loans>> 
.>> 
Select>> 
(>>  
MapToResponseDTO>>  0
)>>0 1
;>>1 2
}?? 	
publicAA 
asyncAA 
TaskAA 
<AA 
IEnumerableAA %
<AA% &
LoanResponseDTOAA& 5
>AA5 6
>AA6 7 
GetOverdueLoansAsyncAA8 L
(AAL M
)AAM N
{BB 	
awaitCC 
_logServiceCC 
.CC 
LogAsyncCC &
(CC& '
LogInfoCC' .
,CC. /
$strCC0 P
)CCP Q
;CCQ R
varEE 
currentDateEE 
=EE 
DateTimeEE &
.EE& '
UtcNowEE' -
;EE- .
varFF 
loansFF 
=FF 
awaitFF 
_loansFF $
.FF$ %
FindFF% )
(FF) *
lFF* +
=>FF, .
lGG 
.GG 
StatusGG 
==GG 

LoanStatusGG &
.GG& '
ActiveGG' -
&&GG. 0
lHH 
.HH 
DueDateHH 
<HH 
currentDateHH '
)HH' (
.II 
SortByII 
(II 
lII 
=>II 
lII 
.II 
DueDateII &
)II& '
.JJ 
ToListAsyncJJ 
(JJ 
)JJ 
;JJ 
foreachMM 
(MM 
varMM 
loanMM 
inMM  
loansMM! &
.MM& '
WhereMM' ,
(MM, -
lMM- .
=>MM/ 1
lMM2 3
.MM3 4
StatusMM4 :
==MM; =

LoanStatusMM> H
.MMH I
ActiveMMI O
)MMO P
)MMP Q
{NN 
awaitOO !
UpdateLoanStatusAsyncOO +
(OO+ ,
loanOO, 0
.OO0 1
IdOO1 3
,OO3 4

LoanStatusOO5 ?
.OO? @
OverdueOO@ G
)OOG H
;OOH I
}PP 
returnRR 
loansRR 
.RR 
SelectRR 
(RR  
MapToResponseDTORR  0
)RR0 1
;RR1 2
}SS 	
publicVV 
asyncVV 
TaskVV 
<VV 
LoanResponseDTOVV !
?VV! "
>VV" #
GetLoanByIdAsyncVV$ 4
(VV4 5
stringVV5 ;
loanIdVV< B
)VVB C
{WW 
varXX 
loanXX 
=XX 
awaitXX 
_loansXX 
.XX  
FindXX  $
(XX$ %
lXX% &
=>XX' )
lXX* +
.XX+ ,
IdXX, .
==XX/ 1
loanIdXX2 8
)XX8 9
.XX9 :
FirstOrDefaultAsyncXX: M
(XXM N
)XXN O
;XXO P
ifYY 

(YY 
loanYY 
==YY 
nullYY 
)YY 
returnYY  
nullYY! %
;YY% &
return\\ 
new\\ 
LoanResponseDTO\\ "
{]] 	
Id^^ 
=^^ 
loan^^ 
.^^ 
Id^^ 
,^^ 
BookId__ 
=__ 
loan__ 
.__ 
BookId__  
,__  !
	BookTitle`` 
=`` 
loan`` 
.`` 
	BookTitle`` &
,``& '

BookAuthoraa 
=aa 
loanaa 
.aa 

BookAuthoraa (
,aa( )
Usernamebb 
=bb 
loanbb 
.bb 
Usernamebb $
,bb$ %
LoanDatecc 
=cc 
loancc 
.cc 
LoanDatecc $
,cc$ %
DueDatedd 
=dd 
loandd 
.dd 
DueDatedd "
,dd" #

ReturnDateee 
=ee 
loanee 
.ee 

ReturnDateee (
,ee( )
Statusff 
=ff 
loanff 
.ff 
Statusff  
,ff  !
Notesgg 
=gg 
loangg 
.gg 
Notesgg 
,gg 
ProcessedByhh 
=hh 
loanhh 
.hh 
ProcessedByhh *
}jj 	
;jj	 

}kk 
publicmm 

asyncmm 
Taskmm 
<mm 
LoanResponseDTOmm %
?mm% &
>mm& '
CreateLoanAsyncmm( 7
(mm7 8
LoanRequestDTOmm8 F
loanRequestmmG R
,mmR S
stringmmT Z
usernamemm[ c
,mmc d
stringmme k
processedBymml w
)mmw x
{nn 	
tryoo 
{pp 
awaitqq 
_logServiceqq !
.qq! "
LogAsyncqq" *
(qq* +
LogInfoqq+ 2
,qq2 3
$"rr 
$strrr A
{rrA B
loanRequestrrB M
.rrM N
BookIdrrN T
}rrT U
$strrrU c
{rrc d
usernamerrd l
}rrl m
"rrm n
)rrn o
;rro p
varuu 
validationResultuu $
=uu% &
awaituu' ,
ValidateLoanRequestuu- @
(uu@ A
loanRequestuuA L
,uuL M
usernameuuN V
)uuV W
;uuW X
ifvv 
(vv 
!vv 
validationResultvv %
.vv% &
IsValidvv& -
)vv- .
{ww 
awaitxx 
_logServicexx %
.xx% &
LogAsyncxx& .
(xx. /

LogWarningxx/ 9
,xx9 :
$"yy 
$stryy <
{yy< =
validationResultyy= M
.yyM N
ErrorMessageyyN Z
}yyZ [
"yy[ \
)yy\ ]
;yy] ^
returnzz 
nullzz 
;zz  
}{{ 
var~~ 
book~~ 
=~~ 
await~~  
_bookService~~! -
.~~- .
GetBookByIdAsync~~. >
(~~> ?
loanRequest~~? J
.~~J K
BookId~~K Q
)~~Q R
;~~R S
var 
user 
= 
await  
_userService! -
.- ."
GetUserByUserNameAsync. D
(D E
usernameE M
)M N
;N O
if
ÅÅ 
(
ÅÅ 
book
ÅÅ 
==
ÅÅ 
null
ÅÅ  
||
ÅÅ! #
user
ÅÅ$ (
==
ÅÅ) +
null
ÅÅ, 0
)
ÅÅ0 1
{
ÇÇ 
await
ÉÉ 
_logService
ÉÉ %
.
ÉÉ% &
LogAsync
ÉÉ& .
(
ÉÉ. /

LogWarning
ÉÉ/ 9
,
ÉÉ9 :
$str
ÑÑ H
)
ÑÑH I
;
ÑÑI J
return
ÖÖ 
null
ÖÖ 
;
ÖÖ  
}
ÜÜ 
var
ââ 
loan
ââ 
=
ââ 
new
ââ 
Loan
ââ #
{
ää 
BookId
ãã 
=
ãã 
loanRequest
ãã (
.
ãã( )
BookId
ãã) /
,
ãã/ 0
UserId
åå 
=
åå 
user
åå !
.
åå! "
Id
åå" $
,
åå$ %
Username
çç 
=
çç 
username
çç '
,
çç' (
	BookTitle
éé 
=
éé 
book
éé  $
.
éé$ %
Title
éé% *
,
éé* +

BookAuthor
èè 
=
èè  
book
èè! %
.
èè% &
Author
èè& ,
,
èè, -
LoanDate
êê 
=
êê 
DateTime
êê '
.
êê' (
UtcNow
êê( .
,
êê. /
DueDate
ëë 
=
ëë 
DateTime
ëë &
.
ëë& '
UtcNow
ëë' -
.
ëë- .
AddDays
ëë. 5
(
ëë5 6
Math
ëë6 :
.
ëë: ;
Min
ëë; >
(
ëë> ?
loanRequest
ëë? J
.
ëëJ K
LoanDays
ëëK S
,
ëëS T
MAX_LOAN_DAYS
ëëU b
)
ëëb c
)
ëëc d
,
ëëd e
Status
íí 
=
íí 

LoanStatus
íí '
.
íí' (
Active
íí( .
,
íí. /
Notes
ìì 
=
ìì 
loanRequest
ìì '
.
ìì' (
Notes
ìì( -
,
ìì- .
ProcessedBy
îî 
=
îî  !
processedBy
îî" -
,
îî- .
	CreatedAt
ïï 
=
ïï 
DateTime
ïï  (
.
ïï( )
UtcNow
ïï) /
,
ïï/ 0
	UpdatedAt
ññ 
=
ññ 
DateTime
ññ  (
.
ññ( )
UtcNow
ññ) /
}
óó 
;
óó 
await
öö 
_loans
öö 
.
öö 
InsertOneAsync
öö +
(
öö+ ,
loan
öö, 0
)
öö0 1
;
öö1 2
await
õõ 
_bookService
õõ "
.
õõ" #)
UpdateBookAvailabilityAsync
õõ# >
(
õõ> ?
book
õõ? C
.
õõC D
Id
õõD F
,
õõF G
-
õõH I
$num
õõI J
)
õõJ K
;
õõK L
await
ùù 
_logService
ùù !
.
ùù! "
LogAsync
ùù" *
(
ùù* +
LogInfo
ùù+ 2
,
ùù2 3
$"
ûû 
$str
ûû 4
{
ûû4 5
loan
ûû5 9
.
ûû9 :
Id
ûû: <
}
ûû< =
$str
ûû= K
{
ûûK L
username
ûûL T
}
ûûT U
"
ûûU V
)
ûûV W
;
ûûW X
return
†† 
MapToResponseDTO
†† '
(
††' (
loan
††( ,
)
††, -
;
††- .
}
°° 
catch
¢¢ 
(
¢¢ 
	Exception
¢¢ 
ex
¢¢ 
)
¢¢  
{
££ 
await
§§ 
_logService
§§ !
.
§§! "
LogAsync
§§" *
(
§§* +
LogError
§§+ 3
,
§§3 4
$"
•• 
$str
•• ;
{
••; <
username
••< D
}
••D E
"
••E F
,
••F G
ex
••H J
)
••J K
;
••K L
throw
¶¶ 
;
¶¶ 
}
ßß 
}
®® 	
public
™™ 
async
™™ 
Task
™™ 
<
™™ 
bool
™™ 
>
™™ 
DeleteLoanAsync
™™  /
(
™™/ 0
string
™™0 6
loanId
™™7 =
)
™™= >
{
´´ 	
try
¨¨ 
{
≠≠ 
await
ÆÆ 
_logService
ÆÆ !
.
ÆÆ! "
LogAsync
ÆÆ" *
(
ÆÆ* +
LogInfo
ÆÆ+ 2
,
ÆÆ2 3
$"
ÆÆ4 6
$str
ÆÆ6 K
{
ÆÆK L
loanId
ÆÆL R
}
ÆÆR S
"
ÆÆS T
)
ÆÆT U
;
ÆÆU V
var
∞∞ 
loan
∞∞ 
=
∞∞ 
await
∞∞  
_loans
∞∞! '
.
∞∞' (
Find
∞∞( ,
(
∞∞, -
l
∞∞- .
=>
∞∞/ 1
l
∞∞2 3
.
∞∞3 4
Id
∞∞4 6
==
∞∞7 9
loanId
∞∞: @
)
∞∞@ A
.
∞∞A B!
FirstOrDefaultAsync
∞∞B U
(
∞∞U V
)
∞∞V W
;
∞∞W X
if
±± 
(
±± 
loan
±± 
==
±± 
null
±±  
)
±±  !
{
≤≤ 
await
≥≥ 
_logService
≥≥ %
.
≥≥% &
LogAsync
≥≥& .
(
≥≥. /

LogWarning
≥≥/ 9
,
≥≥9 :
$"
≥≥; =
$str
≥≥= U
{
≥≥U V
loanId
≥≥V \
}
≥≥\ ]
"
≥≥] ^
)
≥≥^ _
;
≥≥_ `
return
¥¥ 
false
¥¥  
;
¥¥  !
}
µµ 
if
∏∏ 
(
∏∏ 
loan
∏∏ 
.
∏∏ 
Status
∏∏ 
==
∏∏  "

LoanStatus
∏∏# -
.
∏∏- .
Active
∏∏. 4
||
∏∏5 7
loan
∏∏8 <
.
∏∏< =
Status
∏∏= C
==
∏∏D F

LoanStatus
∏∏G Q
.
∏∏Q R
Overdue
∏∏R Y
)
∏∏Y Z
{
ππ 
var
∫∫ 
restored
∫∫  
=
∫∫! "
await
∫∫# (
_bookService
∫∫) 5
.
∫∫5 6)
UpdateBookAvailabilityAsync
∫∫6 Q
(
∫∫Q R
loan
∫∫R V
.
∫∫V W
BookId
∫∫W ]
,
∫∫] ^
$num
∫∫_ `
)
∫∫` a
;
∫∫a b
if
ªª 
(
ªª 
!
ªª 
restored
ªª !
)
ªª! "
{
ºº 
await
ææ 
_logService
ææ )
.
ææ) *
LogAsync
ææ* 2
(
ææ2 3

LogWarning
ææ3 =
,
ææ= >
$"
øø 
$str
øø \
{
øø\ ]
loan
øø] a
.
øøa b
BookId
øøb h
}
øøh i
$str
øøi 
{øø Ä
loanIdøøÄ Ü
}øøÜ á
"øøá à
)øøà â
;øøâ ä
}
¿¿ 
}
¡¡ 
var
√√ 
del
√√ 
=
√√ 
await
√√ 
_loans
√√  &
.
√√& '
DeleteOneAsync
√√' 5
(
√√5 6
l
√√6 7
=>
√√8 :
l
√√; <
.
√√< =
Id
√√= ?
==
√√@ B
loanId
√√C I
)
√√I J
;
√√J K
var
ƒƒ 
ok
ƒƒ 
=
ƒƒ 
del
ƒƒ 
.
ƒƒ 
DeletedCount
ƒƒ )
>
ƒƒ* +
$num
ƒƒ, -
;
ƒƒ- .
await
∆∆ 
_logService
∆∆ !
.
∆∆! "
LogAsync
∆∆" *
(
∆∆* +
ok
∆∆+ -
?
∆∆. /
LogInfo
∆∆0 7
:
∆∆8 9

LogWarning
∆∆: D
,
∆∆D E
ok
«« 
?
«« 
$"
«« 
$str
«« /
{
««/ 0
loanId
««0 6
}
««6 7
"
««7 8
:
««9 :
$"
««; =
$str
««= Y
{
««Y Z
loanId
««Z `
}
««` a
"
««a b
)
««b c
;
««c d
return
…… 
ok
…… 
;
…… 
}
   
catch
ÀÀ 
(
ÀÀ 
	Exception
ÀÀ 
ex
ÀÀ 
)
ÀÀ  
{
ÃÃ 
await
ÕÕ 
_logService
ÕÕ !
.
ÕÕ! "
LogAsync
ÕÕ" *
(
ÕÕ* +
LogError
ÕÕ+ 3
,
ÕÕ3 4
$"
ÕÕ5 7
$str
ÕÕ7 R
{
ÕÕR S
loanId
ÕÕS Y
}
ÕÕY Z
"
ÕÕZ [
,
ÕÕ[ \
ex
ÕÕ] _
)
ÕÕ_ `
;
ÕÕ` a
throw
ŒŒ 
;
ŒŒ 
}
œœ 
}
–– 	
public
““ 
async
““ 
Task
““ 
<
““ 
bool
““ 
>
““ 
UpdateLoanAsync
““  /
(
““/ 0
string
““0 6
loanId
““7 =
,
““= >
UpdateLoanDTO
““? L
dto
““M P
,
““P Q
string
““R X
processedBy
““Y d
)
““d e
{
”” 	
var
‘‘ 
loan
‘‘ 
=
‘‘ 
await
‘‘ 
_loans
‘‘ #
.
‘‘# $
Find
‘‘$ (
(
‘‘( )
l
‘‘) *
=>
‘‘+ -
l
‘‘. /
.
‘‘/ 0
Id
‘‘0 2
==
‘‘3 5
loanId
‘‘6 <
)
‘‘< =
.
‘‘= >!
FirstOrDefaultAsync
‘‘> Q
(
‘‘Q R
)
‘‘R S
;
‘‘S T
if
’’ 
(
’’ 
loan
’’ 
==
’’ 
null
’’ 
)
’’ 
return
’’ $
false
’’% *
;
’’* +
var
ÿÿ 
update
ÿÿ 
=
ÿÿ 
Builders
ÿÿ !
<
ÿÿ! "
Loan
ÿÿ" &
>
ÿÿ& '
.
ÿÿ' (
Update
ÿÿ( .
.
ŸŸ 
Set
ŸŸ 
(
ŸŸ 
l
ŸŸ 
=>
ŸŸ 
l
ŸŸ 
.
ŸŸ 
	UpdatedAt
ŸŸ %
,
ŸŸ% &
DateTime
ŸŸ' /
.
ŸŸ/ 0
UtcNow
ŸŸ0 6
)
ŸŸ6 7
;
ŸŸ7 8
if
€€ 
(
€€ 
dto
€€ 
.
€€ 
DueDate
€€ 
.
€€ 
HasValue
€€ $
)
€€$ %
update
‹‹ 
=
‹‹ 
update
‹‹ 
.
‹‹  
Set
‹‹  #
(
‹‹# $
l
‹‹$ %
=>
‹‹& (
l
‹‹) *
.
‹‹* +
DueDate
‹‹+ 2
,
‹‹2 3
dto
‹‹4 7
.
‹‹7 8
DueDate
‹‹8 ?
.
‹‹? @
Value
‹‹@ E
)
‹‹E F
;
‹‹F G
if
ﬁﬁ 
(
ﬁﬁ 
!
ﬁﬁ 
string
ﬁﬁ 
.
ﬁﬁ  
IsNullOrWhiteSpace
ﬁﬁ *
(
ﬁﬁ* +
dto
ﬁﬁ+ .
.
ﬁﬁ. /
Notes
ﬁﬁ/ 4
)
ﬁﬁ4 5
)
ﬁﬁ5 6
update
ﬂﬂ 
=
ﬂﬂ 
update
ﬂﬂ 
.
ﬂﬂ  
Set
ﬂﬂ  #
(
ﬂﬂ# $
l
ﬂﬂ$ %
=>
ﬂﬂ& (
l
ﬂﬂ) *
.
ﬂﬂ* +
Notes
ﬂﬂ+ 0
,
ﬂﬂ0 1
$"
ﬂﬂ2 4
{
ﬂﬂ4 5
loan
ﬂﬂ5 9
.
ﬂﬂ9 :
Notes
ﬂﬂ: ?
}
ﬂﬂ? @
$str
ﬂﬂ@ N
{
ﬂﬂN O
processedBy
ﬂﬂO Z
}
ﬂﬂZ [
$str
ﬂﬂ[ ]
{
ﬂﬂ] ^
dto
ﬂﬂ^ a
.
ﬂﬂa b
Notes
ﬂﬂb g
}
ﬂﬂg h
"
ﬂﬂh i
)
ﬂﬂi j
;
ﬂﬂj k
var
·· 
res
·· 
=
·· 
await
·· 
_loans
·· "
.
··" #
UpdateOneAsync
··# 1
(
··1 2
l
··2 3
=>
··4 6
l
··7 8
.
··8 9
Id
··9 ;
==
··< >
loanId
··? E
,
··E F
update
··G M
)
··M N
;
··N O
return
‚‚ 
res
‚‚ 
.
‚‚ 
ModifiedCount
‚‚ $
>
‚‚% &
$num
‚‚' (
;
‚‚( )
}
„„ 	
public
ÊÊ 
async
ÊÊ 
Task
ÊÊ 
<
ÊÊ 
bool
ÊÊ 
>
ÊÊ 
ReturnBookAsync
ÊÊ  /
(
ÊÊ/ 0
string
ÊÊ0 6
loanId
ÊÊ7 =
,
ÊÊ= >
ReturnBookDTO
ÊÊ? L
	returnDto
ÊÊM V
,
ÊÊV W
string
ÊÊX ^
processedBy
ÊÊ_ j
)
ÊÊj k
{
ÁÁ 	
try
ËË 
{
ÈÈ 
await
ÍÍ 
_logService
ÍÍ !
.
ÍÍ! "
LogAsync
ÍÍ" *
(
ÍÍ* +
LogInfo
ÍÍ+ 2
,
ÍÍ2 3
$"
ÎÎ 
$str
ÎÎ :
{
ÎÎ: ;
loanId
ÎÎ; A
}
ÎÎA B
$str
ÎÎB G
{
ÎÎG H
processedBy
ÎÎH S
}
ÎÎS T
"
ÎÎT U
)
ÎÎU V
;
ÎÎV W
var
ÌÌ 
loan
ÌÌ 
=
ÌÌ 
await
ÌÌ  
_loans
ÌÌ! '
.
ÌÌ' (
Find
ÌÌ( ,
(
ÌÌ, -
l
ÌÌ- .
=>
ÌÌ/ 1
l
ÌÌ2 3
.
ÌÌ3 4
Id
ÌÌ4 6
==
ÌÌ7 9
loanId
ÌÌ: @
)
ÌÌ@ A
.
ÌÌA B!
FirstOrDefaultAsync
ÌÌB U
(
ÌÌU V
)
ÌÌV W
;
ÌÌW X
if
ÓÓ 
(
ÓÓ 
loan
ÓÓ 
==
ÓÓ 
null
ÓÓ  
)
ÓÓ  !
{
ÔÔ 
await
 
_logService
 %
.
% &
LogAsync
& .
(
. /

LogWarning
/ 9
,
9 :
$"
; =
$str
= U
{
U V
loanId
V \
}
\ ]
"
] ^
)
^ _
;
_ `
return
ÒÒ 
false
ÒÒ  
;
ÒÒ  !
}
ÚÚ 
if
ÙÙ 
(
ÙÙ 
loan
ÙÙ 
.
ÙÙ 
Status
ÙÙ 
!=
ÙÙ  "

LoanStatus
ÙÙ# -
.
ÙÙ- .
Active
ÙÙ. 4
&&
ÙÙ5 7
loan
ÙÙ8 <
.
ÙÙ< =
Status
ÙÙ= C
!=
ÙÙD F

LoanStatus
ÙÙG Q
.
ÙÙQ R
Overdue
ÙÙR Y
)
ÙÙY Z
{
ıı 
await
ˆˆ 
_logService
ˆˆ %
.
ˆˆ% &
LogAsync
ˆˆ& .
(
ˆˆ. /

LogWarning
ˆˆ/ 9
,
ˆˆ9 :
$"
˜˜ 
$str
˜˜ K
{
˜˜K L
loanId
˜˜L R
}
˜˜R S
"
˜˜S T
)
˜˜T U
;
˜˜U V
return
¯¯ 
false
¯¯  
;
¯¯  !
}
˘˘ 
var
¸¸ 
update
¸¸ 
=
¸¸ 
Builders
¸¸ %
<
¸¸% &
Loan
¸¸& *
>
¸¸* +
.
¸¸+ ,
Update
¸¸, 2
.
˝˝ 
Set
˝˝ 
(
˝˝ 
l
˝˝ 
=>
˝˝ 
l
˝˝ 
.
˝˝  

ReturnDate
˝˝  *
,
˝˝* +
DateTime
˝˝, 4
.
˝˝4 5
UtcNow
˝˝5 ;
)
˝˝; <
.
˛˛ 
Set
˛˛ 
(
˛˛ 
l
˛˛ 
=>
˛˛ 
l
˛˛ 
.
˛˛  
Status
˛˛  &
,
˛˛& '
	returnDto
˛˛( 1
.
˛˛1 2
Status
˛˛2 8
)
˛˛8 9
.
ˇˇ 
Set
ˇˇ 
(
ˇˇ 
l
ˇˇ 
=>
ˇˇ 
l
ˇˇ 
.
ˇˇ  
Notes
ˇˇ  %
,
ˇˇ% &
$"
ˇˇ' )
{
ˇˇ) *
loan
ˇˇ* .
.
ˇˇ. /
Notes
ˇˇ/ 4
}
ˇˇ4 5
$str
ˇˇ5 A
{
ˇˇA B
	returnDto
ˇˇB K
.
ˇˇK L
Notes
ˇˇL Q
}
ˇˇQ R
"
ˇˇR S
)
ˇˇS T
.
ÄÄ 
Set
ÄÄ 
(
ÄÄ 
l
ÄÄ 
=>
ÄÄ 
l
ÄÄ 
.
ÄÄ  
	UpdatedAt
ÄÄ  )
,
ÄÄ) *
DateTime
ÄÄ+ 3
.
ÄÄ3 4
UtcNow
ÄÄ4 :
)
ÄÄ: ;
;
ÄÄ; <
var
ÇÇ 
result
ÇÇ 
=
ÇÇ 
await
ÇÇ "
_loans
ÇÇ# )
.
ÇÇ) *
UpdateOneAsync
ÇÇ* 8
(
ÇÇ8 9
l
ÇÇ9 :
=>
ÇÇ; =
l
ÇÇ> ?
.
ÇÇ? @
Id
ÇÇ@ B
==
ÇÇC E
loanId
ÇÇF L
,
ÇÇL M
update
ÇÇN T
)
ÇÇT U
;
ÇÇU V
if
ÑÑ 
(
ÑÑ 
result
ÑÑ 
.
ÑÑ 
ModifiedCount
ÑÑ (
>
ÑÑ) *
$num
ÑÑ+ ,
)
ÑÑ, -
{
ÖÖ 
if
áá 
(
áá 
	returnDto
áá !
.
áá! "
Status
áá" (
!=
áá) +

LoanStatus
áá, 6
.
áá6 7
Lost
áá7 ;
)
áá; <
{
àà 
await
ââ 
_bookService
ââ *
.
ââ* +)
UpdateBookAvailabilityAsync
ââ+ F
(
ââF G
loan
ââG K
.
ââK L
BookId
ââL R
,
ââR S
$num
ââT U
)
ââU V
;
ââV W
}
ää 
await
åå 
_logService
åå %
.
åå% &
LogAsync
åå& .
(
åå. /
LogInfo
åå/ 6
,
åå6 7
$"
çç 
$str
çç 7
{
çç7 8
loanId
çç8 >
}
çç> ?
"
çç? @
)
çç@ A
;
ççA B
return
éé 
true
éé 
;
éé  
}
èè 
return
ëë 
false
ëë 
;
ëë 
}
íí 
catch
ìì 
(
ìì 
	Exception
ìì 
ex
ìì 
)
ìì  
{
îî 
await
ïï 
_logService
ïï !
.
ïï! "
LogAsync
ïï" *
(
ïï* +
LogError
ïï+ 3
,
ïï3 4
$"
ññ 
$str
ññ @
{
ññ@ A
loanId
ññA G
}
ññG H
"
ññH I
,
ññI J
ex
ññK M
)
ññM N
;
ññN O
throw
óó 
;
óó 
}
òò 
}
ôô 	
public
úú 
async
úú 
Task
úú 
<
úú 
bool
úú 
>
úú #
UpdateLoanStatusAsync
úú  5
(
úú5 6
string
úú6 <
loanId
úú= C
,
úúC D

LoanStatus
úúE O
	newStatus
úúP Y
)
úúY Z
{
ùù 	
try
ûû 
{
üü 
var
†† 
update
†† 
=
†† 
Builders
†† %
<
††% &
Loan
††& *
>
††* +
.
††+ ,
Update
††, 2
.
°° 
Set
°° 
(
°° 
l
°° 
=>
°° 
l
°° 
.
°°  
Status
°°  &
,
°°& '
	newStatus
°°( 1
)
°°1 2
.
¢¢ 
Set
¢¢ 
(
¢¢ 
l
¢¢ 
=>
¢¢ 
l
¢¢ 
.
¢¢  
	UpdatedAt
¢¢  )
,
¢¢) *
DateTime
¢¢+ 3
.
¢¢3 4
UtcNow
¢¢4 :
)
¢¢: ;
;
¢¢; <
var
§§ 
result
§§ 
=
§§ 
await
§§ "
_loans
§§# )
.
§§) *
UpdateOneAsync
§§* 8
(
§§8 9
l
§§9 :
=>
§§; =
l
§§> ?
.
§§? @
Id
§§@ B
==
§§C E
loanId
§§F L
,
§§L M
update
§§N T
)
§§T U
;
§§U V
if
¶¶ 
(
¶¶ 
result
¶¶ 
.
¶¶ 
ModifiedCount
¶¶ (
>
¶¶) *
$num
¶¶+ ,
)
¶¶, -
{
ßß 
await
®® 
_logService
®® %
.
®®% &
LogAsync
®®& .
(
®®. /
LogInfo
®®/ 6
,
®®6 7
$"
©© 
$str
©© .
{
©©. /
loanId
©©/ 5
}
©©5 6
$str
©©6 E
{
©©E F
	newStatus
©©F O
}
©©O P
"
©©P Q
)
©©Q R
;
©©R S
}
™™ 
return
¨¨ 
result
¨¨ 
.
¨¨ 
ModifiedCount
¨¨ +
>
¨¨, -
$num
¨¨. /
;
¨¨/ 0
}
≠≠ 
catch
ÆÆ 
(
ÆÆ 
	Exception
ÆÆ 
ex
ÆÆ 
)
ÆÆ  
{
ØØ 
await
∞∞ 
_logService
∞∞ !
.
∞∞! "
LogAsync
∞∞" *
(
∞∞* +
LogError
∞∞+ 3
,
∞∞3 4
$"
±± 
$str
±± >
{
±±> ?
loanId
±±? E
}
±±E F
"
±±F G
,
±±G H
ex
±±I K
)
±±K L
;
±±L M
throw
≤≤ 
;
≤≤ 
}
≥≥ 
}
¥¥ 	
private
∂∂ 
async
∂∂ 
Task
∂∂ 
<
∂∂ 
(
∂∂ 
bool
∂∂  
IsValid
∂∂! (
,
∂∂( )
string
∂∂* 0
ErrorMessage
∂∂1 =
)
∂∂= >
>
∂∂> ?!
ValidateLoanRequest
∂∂@ S
(
∂∂S T
LoanRequestDTO
∑∑ 
loanRequest
∑∑ &
,
∑∑& '
string
∑∑( .
username
∑∑/ 7
)
∑∑7 8
{
∏∏ 	
var
∫∫ 
isBookAvailable
∫∫ 
=
∫∫  !
await
∫∫" '
_bookService
∫∫( 4
.
∫∫4 5"
IsBookAvailableAsync
∫∫5 I
(
∫∫I J
loanRequest
∫∫J U
.
∫∫U V
BookId
∫∫V \
)
∫∫\ ]
;
∫∫] ^
if
ªª 
(
ªª 
!
ªª 
isBookAvailable
ªª  
)
ªª  !
{
ºº 
return
ΩΩ 
(
ΩΩ 
false
ΩΩ 
,
ΩΩ 
$str
ΩΩ J
)
ΩΩJ K
;
ΩΩK L
}
ææ 
if
¡¡ 
(
¡¡ 
loanRequest
¡¡ 
.
¡¡ 
LoanDays
¡¡ $
<=
¡¡% '
$num
¡¡( )
||
¡¡* ,
loanRequest
¡¡- 8
.
¡¡8 9
LoanDays
¡¡9 A
>
¡¡B C
MAX_LOAN_DAYS
¡¡D Q
)
¡¡Q R
{
¬¬ 
return
√√ 
(
√√ 
false
√√ 
,
√√ 
$"
√√ !
$str
√√! L
{
√√L M
MAX_LOAN_DAYS
√√M Z
}
√√Z [
"
√√[ \
)
√√\ ]
;
√√] ^
}
ƒƒ 
var
«« 
activeLoansCount
««  
=
««! "
await
««# (
_loans
««) /
.
««/ 0!
CountDocumentsAsync
««0 C
(
««C D
l
««D E
=>
««F H
l
»» 
.
»» 
Username
»» 
==
»» 
username
»» &
&&
»»' )
l
»»* +
.
»»+ ,
Status
»», 2
==
»»3 5

LoanStatus
»»6 @
.
»»@ A
Active
»»A G
)
»»G H
;
»»H I
if
   
(
   
activeLoansCount
    
>=
  ! #'
MAX_ACTIVE_LOANS_PER_USER
  $ =
)
  = >
{
ÀÀ 
return
ÃÃ 
(
ÃÃ 
false
ÃÃ 
,
ÃÃ 
$"
ÃÃ !
$str
ÃÃ! 7
{
ÃÃ7 8'
MAX_ACTIVE_LOANS_PER_USER
ÃÃ8 Q
}
ÃÃQ R
$str
ÃÃR d
"
ÃÃd e
)
ÃÃe f
;
ÃÃf g
}
ÕÕ 
var
–– 
existingLoan
–– 
=
–– 
await
–– $
_loans
––% +
.
––+ ,
Find
––, 0
(
––0 1
l
––1 2
=>
––3 5
l
—— 
.
—— 
Username
—— 
==
—— 
username
—— &
&&
——' )
l
““ 
.
““ 
BookId
““ 
==
““ 
loanRequest
““ '
.
““' (
BookId
““( .
&&
““/ 1
l
”” 
.
”” 
Status
”” 
==
”” 

LoanStatus
”” &
.
””& '
Active
””' -
)
””- .
.
‘‘ !
FirstOrDefaultAsync
‘‘ $
(
‘‘$ %
)
‘‘% &
;
‘‘& '
if
÷÷ 
(
÷÷ 
existingLoan
÷÷ 
!=
÷÷ 
null
÷÷  $
)
÷÷$ %
{
◊◊ 
return
ÿÿ 
(
ÿÿ 
false
ÿÿ 
,
ÿÿ 
$str
ÿÿ @
)
ÿÿ@ A
;
ÿÿA B
}
ŸŸ 
return
€€ 
(
€€ 
true
€€ 
,
€€ 
string
€€  
.
€€  !
Empty
€€! &
)
€€& '
;
€€' (
}
‹‹ 	
private
ﬁﬁ 
static
ﬁﬁ 
LoanResponseDTO
ﬁﬁ &
MapToResponseDTO
ﬁﬁ' 7
(
ﬁﬁ7 8
Loan
ﬁﬁ8 <
loan
ﬁﬁ= A
)
ﬁﬁA B
{
ﬂﬂ 	
return
‡‡ 
new
‡‡ 
LoanResponseDTO
‡‡ &
{
·· 
Id
‚‚ 
=
‚‚ 
loan
‚‚ 
.
‚‚ 
Id
‚‚ 
,
‚‚ 
BookId
„„ 
=
„„ 
loan
„„ 
.
„„ 
BookId
„„ $
,
„„$ %
	BookTitle
‰‰ 
=
‰‰ 
loan
‰‰  
.
‰‰  !
	BookTitle
‰‰! *
,
‰‰* +

BookAuthor
ÂÂ 
=
ÂÂ 
loan
ÂÂ !
.
ÂÂ! "

BookAuthor
ÂÂ" ,
,
ÂÂ, -
Username
ÊÊ 
=
ÊÊ 
loan
ÊÊ 
.
ÊÊ  
Username
ÊÊ  (
,
ÊÊ( )
LoanDate
ÁÁ 
=
ÁÁ 
loan
ÁÁ 
.
ÁÁ  
LoanDate
ÁÁ  (
,
ÁÁ( )
DueDate
ËË 
=
ËË 
loan
ËË 
.
ËË 
DueDate
ËË &
,
ËË& '

ReturnDate
ÈÈ 
=
ÈÈ 
loan
ÈÈ !
.
ÈÈ! "

ReturnDate
ÈÈ" ,
,
ÈÈ, -
Status
ÍÍ 
=
ÍÍ 
loan
ÍÍ 
.
ÍÍ 
Status
ÍÍ $
,
ÍÍ$ %
Notes
ÎÎ 
=
ÎÎ 
loan
ÎÎ 
.
ÎÎ 
Notes
ÎÎ "
}
ÏÏ 
;
ÏÏ 
}
ÌÌ 	
public
ÔÔ 
async
ÔÔ 
Task
ÔÔ 
<
ÔÔ 
int
ÔÔ 
>
ÔÔ &
GetTotalActiveLoansAsync
ÔÔ 7
(
ÔÔ7 8
)
ÔÔ8 9
{
 	
return
ÒÒ 
(
ÒÒ 
int
ÒÒ 
)
ÒÒ 
await
ÒÒ 
_loans
ÒÒ $
.
ÒÒ$ %!
CountDocumentsAsync
ÒÒ% 8
(
ÒÒ8 9
l
ÒÒ9 :
=>
ÒÒ; =
l
ÒÒ> ?
.
ÒÒ? @
Status
ÒÒ@ F
==
ÒÒG I

LoanStatus
ÒÒJ T
.
ÒÒT U
Active
ÒÒU [
)
ÒÒ[ \
;
ÒÒ\ ]
}
ÚÚ 	
public
ÙÙ 
async
ÙÙ 
Task
ÙÙ 
<
ÙÙ 
int
ÙÙ 
>
ÙÙ '
GetTotalOverdueLoansAsync
ÙÙ 8
(
ÙÙ8 9
)
ÙÙ9 :
{
ıı 	
var
ˆˆ 
currentDate
ˆˆ 
=
ˆˆ 
DateTime
ˆˆ &
.
ˆˆ& '
UtcNow
ˆˆ' -
;
ˆˆ- .
return
˜˜ 
(
˜˜ 
int
˜˜ 
)
˜˜ 
await
˜˜ 
_loans
˜˜ $
.
˜˜$ %!
CountDocumentsAsync
˜˜% 8
(
˜˜8 9
l
˜˜9 :
=>
˜˜; =
l
¯¯ 
.
¯¯ 
Status
¯¯ 
==
¯¯ 

LoanStatus
¯¯ &
.
¯¯& '
Active
¯¯' -
&&
¯¯. 0
l
¯¯1 2
.
¯¯2 3
DueDate
¯¯3 :
<
¯¯; <
currentDate
¯¯= H
)
¯¯H I
;
¯¯I J
}
˘˘ 	
}
˙˙ 
}˚˚ ◊	
QC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\EmailValidator.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

static 
class 
EmailValidator &
{ 
private 
static 
readonly 
Regex  %

EmailRegex& 0
=1 2
new3 6
Regex7 <
(< =
$str )
,) *
RegexOptions		 
.		 
Compiled		 !
|		" #
RegexOptions		$ 0
.		0 1

IgnoreCase		1 ;
)		; <
;		< =
public 
static 
bool 
IsValid "
(" #
string# )
?) *
email+ 0
)0 1
{ 	
if 
( 
string 
. 
IsNullOrWhiteSpace )
() *
email* /
)/ 0
)0 1
return 
false 
; 
return 

EmailRegex 
. 
IsMatch %
(% &
email& +
)+ ,
;, -
} 	
} 
} Ñæ
NC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Services\BookService.cs
	namespace 	

LibraryApp
 
. 
Services 
{ 
public 

class 
BookService 
{ 
private		 
readonly		 
IMongoCollection		 )
<		) *
Book		* .
>		. /
_books		0 6
;		6 7
private

 
readonly

 

Logservice

 #
_logService

$ /
;

/ 0
private 
const 
string 
LogError %
=& '
$str( /
;/ 0
private 
const 
string 

LogWarning '
=( )
$str* 3
;3 4
private 
const 
string 
LogInfo $
=% &
$str' 4
;4 5
public 
BookService 
( 
MongoDBService )
mongoDBService* 8
,8 9

Logservice: D

logServiceE O
)O P
{ 	
_books 
= 
mongoDBService #
.# $
	_database$ -
.- .
GetCollection. ;
<; <
Book< @
>@ A
(A B
$strB I
)I J
;J K
_logService 
= 

logService $
;$ %
} 	
public 
async 
Task 
< 
IEnumerable %
<% &
Book& *
>* +
>+ ,
GetAllBooksAsync- =
(= >
)> ?
{ 	
await 
_logService 
. 
LogAsync &
(& '
LogInfo' .
,. /
$str0 Z
)Z [
;[ \
return 
await 
_books 
.  
Find  $
($ %
b% &
=>' )
b* +
.+ ,
IsActive, 4
)4 5
.5 6
ToListAsync6 A
(A B
)B C
;C D
} 	
public 
async 
Task 
< 
Book 
? 
>  
GetBookByIdAsync! 1
(1 2
string2 8
id9 ;
); <
{ 	
if 
( 
string 
. 
IsNullOrEmpty $
($ %
id% '
)' (
)( )
{ 
await   
_logService   !
.  ! "
LogAsync  " *
(  * +
LogInfo  + 2
,  2 3
$str  4 f
)  f g
;  g h
return!! 
null!! 
;!! 
}"" 
await$$ 
_logService$$ 
.$$ 
LogAsync$$ &
($$& '
LogInfo$$' .
,$$. /
$"$$0 2
$str$$2 L
{$$L M
id$$M O
}$$O P
"$$P Q
)$$Q R
;$$R S
return%% 
await%% 
_books%% 
.%%  
Find%%  $
(%%$ %
b%%% &
=>%%' )
b%%* +
.%%+ ,
Id%%, .
==%%/ 1
id%%2 4
&&%%5 7
b%%8 9
.%%9 :
IsActive%%: B
)%%B C
.%%C D
FirstOrDefaultAsync%%D W
(%%W X
)%%X Y
;%%Y Z
}&& 	
public(( 
async(( 
Task(( 
<(( 
IEnumerable(( %
<((% &
Book((& *
>((* +
>((+ ,
SearchBooksAsync((- =
(((= >
string((> D

searchTerm((E O
)((O P
{)) 	
if** 
(** 
string** 
.** 
IsNullOrEmpty** $
(**$ %

searchTerm**% /
)**/ 0
)**0 1
{++ 
return,, 
await,, 
GetAllBooksAsync,, -
(,,- .
),,. /
;,,/ 0
}-- 
await// 
_logService// 
.// 
LogAsync// &
(//& '
LogInfo//' .
,//. /
$"//0 2
$str//2 R
{//R S

searchTerm//S ]
}//] ^
"//^ _
)//_ `
;//` a
var11 
filter11 
=11 
Builders11 !
<11! "
Book11" &
>11& '
.11' (
Filter11( .
.11. /
And11/ 2
(112 3
Builders22 
<22 
Book22 
>22 
.22 
Filter22 %
.22% &
Eq22& (
(22( )
b22) *
=>22+ -
b22. /
.22/ 0
IsActive220 8
,228 9
true22: >
)22> ?
,22? @
Builders33 
<33 
Book33 
>33 
.33 
Filter33 %
.33% &
Or33& (
(33( )
Builders44 
<44 
Book44 !
>44! "
.44" #
Filter44# )
.44) *
Regex44* /
(44/ 0
b440 1
=>442 4
b445 6
.446 7
Title447 <
,44< =
new44> A
MongoDB44B I
.44I J
Bson44J N
.44N O!
BsonRegularExpression44O d
(44d e

searchTerm44e o
,44o p
$str44q t
)44t u
)44u v
,44v w
Builders55 
<55 
Book55 !
>55! "
.55" #
Filter55# )
.55) *
Regex55* /
(55/ 0
b550 1
=>552 4
b555 6
.556 7
Author557 =
,55= >
new55? B
MongoDB55C J
.55J K
Bson55K O
.55O P!
BsonRegularExpression55P e
(55e f

searchTerm55f p
,55p q
$str55r u
)55u v
)55v w
,55w x
Builders66 
<66 
Book66 !
>66! "
.66" #
Filter66# )
.66) *
Regex66* /
(66/ 0
b660 1
=>662 4
b665 6
.666 7
ISBN667 ;
,66; <
new66= @
MongoDB66A H
.66H I
Bson66I M
.66M N!
BsonRegularExpression66N c
(66c d

searchTerm66d n
,66n o
$str66p s
)66s t
)66t u
,66u v
Builders77 
<77 
Book77 !
>77! "
.77" #
Filter77# )
.77) *
Regex77* /
(77/ 0
b770 1
=>772 4
b775 6
.776 7
Category777 ?
,77? @
new77A D
MongoDB77E L
.77L M
Bson77M Q
.77Q R!
BsonRegularExpression77R g
(77g h

searchTerm77h r
,77r s
$str77t w
)77w x
)77x y
)88 
)99 
;99 
return;; 
await;; 
_books;; 
.;;  
Find;;  $
(;;$ %
filter;;% +
);;+ ,
.;;, -
ToListAsync;;- 8
(;;8 9
);;9 :
;;;: ;
}<< 	
public>> 
async>> 
Task>> 
<>> 
Book>> 
?>> 
>>>  
CreateBookAsync>>! 0
(>>0 1
BookDTO>>1 8
bookDto>>9 @
,>>@ A
string>>B H
	createdBy>>I R
)>>R S
{?? 	
try@@ 
{AA 
awaitBB 
_logServiceBB !
.BB! "
LogAsyncBB" *
(BB* +
LogInfoBB+ 2
,BB2 3
$"BB4 6
$strBB6 K
{BBK L
bookDtoBBL S
.BBS T
TitleBBT Y
}BBY Z
$strBBZ h
{BBh i
	createdByBBi r
}BBr s
"BBs t
)BBt u
;BBu v
ifEE 
(EE 
!EE 
stringEE 
.EE 
IsNullOrEmptyEE )
(EE) *
bookDtoEE* 1
.EE1 2
ISBNEE2 6
)EE6 7
)EE7 8
{FF 
varGG 
existingBookGG $
=GG% &
awaitGG' ,
_booksGG- 3
.GG3 4
FindGG4 8
(GG8 9
bGG9 :
=>GG; =
bGG> ?
.GG? @
ISBNGG@ D
==GGE G
bookDtoGGH O
.GGO P
ISBNGGP T
&&GGU W
bGGX Y
.GGY Z
IsActiveGGZ b
)GGb c
.HH 
FirstOrDefaultAsyncHH ,
(HH, -
)HH- .
;HH. /
ifII 
(II 
existingBookII $
!=II% '
nullII( ,
)II, -
{JJ 
awaitKK 
_logServiceKK )
.KK) *
LogAsyncKK* 2
(KK2 3

LogWarningKK3 =
,KK= >
$"KK? A
$strKKA l
{KKl m
bookDtoKKm t
.KKt u
ISBNKKu y
}KKy z
"KKz {
)KK{ |
;KK| }
returnLL 
nullLL #
;LL# $
}MM 
}NN 
varPP 
bookPP 
=PP 
newPP 
BookPP #
{QQ 
TitleRR 
=RR 
bookDtoRR #
.RR# $
TitleRR$ )
,RR) *
AuthorSS 
=SS 
bookDtoSS $
.SS$ %
AuthorSS% +
,SS+ ,
ISBNTT 
=TT 
bookDtoTT "
.TT" #
ISBNTT# '
,TT' (
	PublisherUU 
=UU 
bookDtoUU  '
.UU' (
	PublisherUU( 1
,UU1 2
PublicationYearVV #
=VV$ %
bookDtoVV& -
.VV- .
PublicationYearVV. =
,VV= >
CategoryWW 
=WW 
bookDtoWW &
.WW& '
CategoryWW' /
,WW/ 0
DescriptionXX 
=XX  !
bookDtoXX" )
.XX) *
DescriptionXX* 5
,XX5 6
TotalCopiesYY 
=YY  !
bookDtoYY" )
.YY) *
TotalCopiesYY* 5
>YY6 7
$numYY8 9
?YY: ;
bookDtoYY< C
.YYC D
TotalCopiesYYD O
:YYP Q
$numYYR S
,YYS T
AvailableCopiesZZ #
=ZZ$ %
bookDtoZZ& -
.ZZ- .
TotalCopiesZZ. 9
>ZZ: ;
$numZZ< =
?ZZ> ?
bookDtoZZ@ G
.ZZG H
TotalCopiesZZH S
:ZZT U
$numZZV W
,ZZW X
	CreatedBy[[ 
=[[ 
	createdBy[[  )
,[[) *
	CreatedAt\\ 
=\\ 
DateTime\\  (
.\\( )
UtcNow\\) /
,\\/ 0
	UpdatedAt]] 
=]] 
DateTime]]  (
.]]( )
UtcNow]]) /
,]]/ 0
IsActive^^ 
=^^ 
true^^ #
}__ 
;__ 
awaitaa 
_booksaa 
.aa 
InsertOneAsyncaa +
(aa+ ,
bookaa, 0
)aa0 1
;aa1 2
awaitbb 
_logServicebb !
.bb! "
LogAsyncbb" *
(bb* +
LogInfobb+ 2
,bb2 3
$"bb4 6
$strbb6 Q
{bbQ R
bookbbR V
.bbV W
TitlebbW \
}bb\ ]
$strbb] f
{bbf g
bookbbg k
.bbk l
Idbbl n
}bbn o
"bbo p
)bbp q
;bbq r
returndd 
bookdd 
;dd 
}ee 
catchff 
(ff 
	Exceptionff 
exff 
)ff  
{gg 
awaithh 
_logServicehh !
.hh! "
LogAsynchh" *
(hh* +
LogErrorhh, 4
,hh4 5
$"hh6 8
$strhh8 N
{hhN O
bookDtohhO V
.hhV W
TitlehhW \
}hh\ ]
"hh] ^
,hh^ _
exhh` b
)hhb c
;hhc d
throwii 
;ii 
}jj 
}kk 	
publicmm 
asyncmm 
Taskmm 
<mm 
boolmm 
>mm 
UpdateBookAsyncmm  /
(mm/ 0
stringmm0 6
idmm7 9
,mm9 :
UpdateBookDTOmm; H
updateBookDtommI V
,mmV W
stringmmX ^
	updatedBymm_ h
)mmh i
{nn 	
tryoo 
{pp 
awaitqq 
_logServiceqq !
.qq! "
LogAsyncqq" *
(qq* +
LogInfoqq+ 2
,qq2 3
$"qq4 6
$strqq6 Q
{qqQ R
idqqR T
}qqT U
$strqqU c
{qqc d
	updatedByqqd m
}qqm n
"qqn o
)qqo p
;qqp q
varss 
updatess 
=ss 
Buildersss %
<ss% &
Bookss& *
>ss* +
.ss+ ,
Updatess, 2
.tt 
Settt 
(tt 
btt 
=>tt 
btt 
.tt  
Titlett  %
,tt% &
updateBookDtott' 4
.tt4 5
Titlett5 :
)tt: ;
.uu 
Setuu 
(uu 
buu 
=>uu 
buu 
.uu  
Authoruu  &
,uu& '
updateBookDtouu( 5
.uu5 6
Authoruu6 <
)uu< =
.vv 
Setvv 
(vv 
bvv 
=>vv 
bvv 
.vv  
	Publishervv  )
,vv) *
updateBookDtovv+ 8
.vv8 9
	Publishervv9 B
)vvB C
.ww 
Setww 
(ww 
bww 
=>ww 
bww 
.ww  
PublicationYearww  /
,ww/ 0
updateBookDtoww1 >
.ww> ?
PublicationYearww? N
)wwN O
.xx 
Setxx 
(xx 
bxx 
=>xx 
bxx 
.xx  
Categoryxx  (
,xx( )
updateBookDtoxx* 7
.xx7 8
Categoryxx8 @
)xx@ A
.yy 
Setyy 
(yy 
byy 
=>yy 
byy 
.yy  
Descriptionyy  +
,yy+ ,
updateBookDtoyy- :
.yy: ;
Descriptionyy; F
)yyF G
.zz 
Setzz 
(zz 
bzz 
=>zz 
bzz 
.zz  
	UpdatedAtzz  )
,zz) *
DateTimezz+ 3
.zz3 4
UtcNowzz4 :
)zz: ;
;zz; <
if}} 
(}} 
updateBookDto}} !
.}}! "
TotalCopies}}" -
>}}. /
$num}}0 1
)}}1 2
{~~ 
var 
currentBook #
=$ %
await& +
GetBookByIdAsync, <
(< =
id= ?
)? @
;@ A
if
ÄÄ 
(
ÄÄ 
currentBook
ÄÄ #
!=
ÄÄ$ &
null
ÄÄ' +
)
ÄÄ+ ,
{
ÅÅ 
var
ÇÇ 

difference
ÇÇ &
=
ÇÇ' (
updateBookDto
ÇÇ) 6
.
ÇÇ6 7
TotalCopies
ÇÇ7 B
-
ÇÇC D
currentBook
ÇÇE P
.
ÇÇP Q
TotalCopies
ÇÇQ \
;
ÇÇ\ ]
var
ÉÉ  
newAvailableCopies
ÉÉ .
=
ÉÉ/ 0
currentBook
ÉÉ1 <
.
ÉÉ< =
AvailableCopies
ÉÉ= L
+
ÉÉM N

difference
ÉÉO Y
;
ÉÉY Z
if
ÖÖ 
(
ÖÖ  
newAvailableCopies
ÖÖ .
>=
ÖÖ/ 1
$num
ÖÖ2 3
)
ÖÖ3 4
{
ÜÜ 
update
áá "
=
áá# $
update
áá% +
.
àà  !
Set
àà! $
(
àà$ %
b
àà% &
=>
àà' )
b
àà* +
.
àà+ ,
TotalCopies
àà, 7
,
àà7 8
updateBookDto
àà9 F
.
ààF G
TotalCopies
ààG R
)
ààR S
.
ââ  !
Set
ââ! $
(
ââ$ %
b
ââ% &
=>
ââ' )
b
ââ* +
.
ââ+ ,
AvailableCopies
ââ, ;
,
ââ; < 
newAvailableCopies
ââ= O
)
ââO P
;
ââP Q
}
ää 
}
ãã 
}
åå 
var
éé 
result
éé 
=
éé 
await
éé "
_books
éé# )
.
éé) *
UpdateOneAsync
éé* 8
(
éé8 9
b
èè 
=>
èè 
b
èè 
.
èè 
Id
èè 
==
èè  
id
èè! #
&&
èè$ &
b
èè' (
.
èè( )
IsActive
èè) 1
,
èè1 2
update
êê 
)
êê 
;
êê 
if
íí 
(
íí 
result
íí 
.
íí 
ModifiedCount
íí (
>
íí) *
$num
íí+ ,
)
íí, -
{
ìì 
await
îî 
_logService
îî %
.
îî% &
LogAsync
îî& .
(
îî. /
LogInfo
îî/ 6
,
îî6 7
$"
îî8 :
$str
îî: ]
{
îî] ^
id
îî^ `
}
îî` a
"
îîa b
)
îîb c
;
îîc d
return
ïï 
true
ïï 
;
ïï  
}
ññ 
await
òò 
_logService
òò !
.
òò! "
LogAsync
òò" *
(
òò* +

LogWarning
òò+ 5
,
òò5 6
$"
òò7 9
$str
òò9 `
{
òò` a
id
òòa c
}
òòc d
"
òòd e
)
òòe f
;
òòf g
return
ôô 
false
ôô 
;
ôô 
}
öö 
catch
õõ 
(
õõ 
	Exception
õõ 
ex
õõ 
)
õõ  
{
úú 
await
ùù 
_logService
ùù !
.
ùù! "
LogAsync
ùù" *
(
ùù* +
LogError
ùù+ 3
,
ùù3 4
$"
ùù5 7
$str
ùù7 Y
{
ùùY Z
id
ùùZ \
}
ùù\ ]
"
ùù] ^
,
ùù^ _
ex
ùù` b
)
ùùb c
;
ùùc d
throw
ûû 
;
ûû 
}
üü 
}
†† 	
public
¢¢ 
async
¢¢ 
Task
¢¢ 
<
¢¢ 
bool
¢¢ 
>
¢¢ 
DeleteBookAsync
¢¢  /
(
¢¢/ 0
string
¢¢0 6
id
¢¢7 9
,
¢¢9 :
string
¢¢; A
	deletedBy
¢¢B K
)
¢¢K L
{
££ 	
try
§§ 
{
•• 
await
¶¶ 
_logService
¶¶ !
.
¶¶! "
LogAsync
¶¶" *
(
¶¶* +
LogInfo
¶¶+ 2
,
¶¶2 3
$"
¶¶4 6
$str
¶¶6 O
{
¶¶O P
id
¶¶P R
}
¶¶R S
$str
¶¶S a
{
¶¶a b
	deletedBy
¶¶b k
}
¶¶k l
"
¶¶l m
)
¶¶m n
;
¶¶n o
var
©© 
update
©© 
=
©© 
Builders
©© %
<
©©% &
Book
©©& *
>
©©* +
.
©©+ ,
Update
©©, 2
.
™™ 
Set
™™ 
(
™™ 
b
™™ 
=>
™™ 
b
™™ 
.
™™  
IsActive
™™  (
,
™™( )
false
™™* /
)
™™/ 0
.
´´ 
Set
´´ 
(
´´ 
b
´´ 
=>
´´ 
b
´´ 
.
´´  
	UpdatedAt
´´  )
,
´´) *
DateTime
´´+ 3
.
´´3 4
UtcNow
´´4 :
)
´´: ;
;
´´; <
var
≠≠ 
result
≠≠ 
=
≠≠ 
await
≠≠ "
_books
≠≠# )
.
≠≠) *
UpdateOneAsync
≠≠* 8
(
≠≠8 9
b
ÆÆ 
=>
ÆÆ 
b
ÆÆ 
.
ÆÆ 
Id
ÆÆ 
==
ÆÆ  
id
ÆÆ! #
&&
ÆÆ$ &
b
ÆÆ' (
.
ÆÆ( )
IsActive
ÆÆ) 1
,
ÆÆ1 2
update
ØØ 
)
ØØ 
;
ØØ 
if
±± 
(
±± 
result
±± 
.
±± 
ModifiedCount
±± (
>
±±) *
$num
±±+ ,
)
±±, -
{
≤≤ 
await
≥≥ 
_logService
≥≥ %
.
≥≥% &
LogAsync
≥≥& .
(
≥≥. /
LogInfo
≥≥/ 6
,
≥≥6 7
$"
≥≥8 :
$str
≥≥: [
{
≥≥[ \
id
≥≥\ ^
}
≥≥^ _
"
≥≥_ `
)
≥≥` a
;
≥≥a b
return
¥¥ 
true
¥¥ 
;
¥¥  
}
µµ 
await
∑∑ 
_logService
∑∑ !
.
∑∑! "
LogAsync
∑∑" *
(
∑∑* +

LogWarning
∑∑+ 5
,
∑∑5 6
$"
∑∑7 9
$str
∑∑9 ^
{
∑∑^ _
id
∑∑_ a
}
∑∑a b
"
∑∑b c
)
∑∑c d
;
∑∑d e
return
∏∏ 
false
∏∏ 
;
∏∏ 
}
ππ 
catch
∫∫ 
(
∫∫ 
	Exception
∫∫ 
ex
∫∫ 
)
∫∫  
{
ªª 
await
ºº 
_logService
ºº !
.
ºº! "
LogAsync
ºº" *
(
ºº* +
LogError
ºº+ 3
,
ºº3 4
$"
ºº5 7
$str
ºº7 W
{
ººW X
id
ººX Z
}
ººZ [
"
ºº[ \
,
ºº\ ]
ex
ºº^ `
)
ºº` a
;
ººa b
throw
ΩΩ 
;
ΩΩ 
}
ææ 
}
øø 	
public
¡¡ 
async
¡¡ 
Task
¡¡ 
<
¡¡ 
bool
¡¡ 
>
¡¡ )
UpdateBookAvailabilityAsync
¡¡  ;
(
¡¡; <
string
¡¡< B
bookId
¡¡C I
,
¡¡I J
int
¡¡K N
change
¡¡O U
)
¡¡U V
{
¬¬ 	
try
√√ 
{
ƒƒ 
var
≈≈ 
update
≈≈ 
=
≈≈ 
Builders
≈≈ %
<
≈≈% &
Book
≈≈& *
>
≈≈* +
.
≈≈+ ,
Update
≈≈, 2
.
∆∆ 
Inc
∆∆ 
(
∆∆ 
b
∆∆ 
=>
∆∆ 
b
∆∆ 
.
∆∆  
AvailableCopies
∆∆  /
,
∆∆/ 0
change
∆∆1 7
)
∆∆7 8
.
«« 
Set
«« 
(
«« 
b
«« 
=>
«« 
b
«« 
.
««  
	UpdatedAt
««  )
,
««) *
DateTime
««+ 3
.
««3 4
UtcNow
««4 :
)
««: ;
;
««; <
var
…… 
result
…… 
=
…… 
await
…… "
_books
……# )
.
……) *
UpdateOneAsync
……* 8
(
……8 9
b
   
=>
   
b
   
.
   
Id
   
==
    
bookId
  ! '
&&
  ( *
b
  + ,
.
  , -
IsActive
  - 5
,
  5 6
update
ÀÀ 
)
ÀÀ 
;
ÀÀ 
await
ÕÕ 
_logService
ÕÕ !
.
ÕÕ! "
LogAsync
ÕÕ" *
(
ÕÕ* +
LogInfo
ÕÕ+ 2
,
ÕÕ2 3
$"
ŒŒ 
$str
ŒŒ ;
{
ŒŒ; <
bookId
ŒŒ< B
}
ŒŒB C
$str
ŒŒC O
{
ŒŒO P
change
ŒŒP V
}
ŒŒV W
$str
ŒŒW ^
"
ŒŒ^ _
)
ŒŒ_ `
;
ŒŒ` a
return
–– 
result
–– 
.
–– 
ModifiedCount
–– +
>
––, -
$num
––. /
;
––/ 0
}
—— 
catch
““ 
(
““ 
	Exception
““ 
ex
““ 
)
““  
{
”” 
await
‘‘ 
_logService
‘‘ !
.
‘‘! "
LogAsync
‘‘" *
(
‘‘* +
LogError
‘‘+ 3
,
‘‘3 4
$"
‘‘5 7
$str
‘‘7 d
{
‘‘d e
bookId
‘‘e k
}
‘‘k l
"
‘‘l m
,
‘‘m n
ex
‘‘o q
)
‘‘q r
;
‘‘r s
throw
’’ 
;
’’ 
}
÷÷ 
}
◊◊ 	
public
ŸŸ 
async
ŸŸ 
Task
ŸŸ 
<
ŸŸ 
bool
ŸŸ 
>
ŸŸ "
IsBookAvailableAsync
ŸŸ  4
(
ŸŸ4 5
string
ŸŸ5 ;
bookId
ŸŸ< B
)
ŸŸB C
{
⁄⁄ 	
var
€€ 
book
€€ 
=
€€ 
await
€€ 
GetBookByIdAsync
€€ -
(
€€- .
bookId
€€. 4
)
€€4 5
;
€€5 6
return
‹‹ 
book
‹‹ 
!=
‹‹ 
null
‹‹ 
&&
‹‹  "
book
‹‹# '
.
‹‹' (
AvailableCopies
‹‹( 7
>
‹‹8 9
$num
‹‹: ;
;
‹‹; <
}
›› 	
}
ﬁﬁ 
}ﬂﬂ À›
AC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
AddControllers 
(  
)  !
. 
AddJsonOptions 
( 
options 
=> 
{ 
options 
. !
JsonSerializerOptions %
.% &

Converters& 0
.0 1
Add1 4
(4 5
new5 8#
JsonStringEnumConverter9 P
(P Q
)Q R
)R S
;S T
options 
. !
JsonSerializerOptions %
.% & 
PropertyNamingPolicy& :
=; <
System= C
.C D
TextD H
.H I
JsonI M
.M N
JsonNamingPolicyN ^
.^ _
	CamelCase_ h
;h i
} 
) 
; 
builder 
. 
Services 
. 
AddSingleton 
< 
MongoDBService ,
>, -
(- .
). /
;/ 0
builder 
. 
Services 
. 
	AddScoped 
< 
UserService &
>& '
(' (
)( )
;) *
builder 
. 
Services 
. 
	AddScoped 
< 

Logservice %
>% &
(& '
)' (
;( )
builder 
. 
Services 
. 
	AddScoped 
< 
BookService &
>& '
(' (
)( )
;) *
builder 
. 
Services 
. 
	AddScoped 
< 
LoanService &
>& '
(' (
)( )
;) *
builder   
.   
Services   
.   "
AddHttpContextAccessor   '
(  ' (
)  ( )
;  ) *
var## 
jwtSettings## 
=## 
builder## 
.## 
Configuration## '
.##' (

GetSection##( 2
(##2 3
$str##3 8
)##8 9
;##9 :
var$$ 
jwtKey$$ 

=$$ 
jwtSettings$$ 
.$$ 
GetValue$$ !
<$$! "
string$$" (
>$$( )
($$) *
$str$$* /
)$$/ 0
;$$0 1
var%% 
	jwtIssuer%% 
=%% 
jwtSettings%% 
.%% 
GetValue%% $
<%%$ %
string%%% +
>%%+ ,
(%%, -
$str%%- 5
)%%5 6
;%%6 7
var&& 
jwtAudience&& 
=&& 
jwtSettings&& 
.&& 
GetValue&& &
<&&& '
string&&' -
>&&- .
(&&. /
$str&&/ 9
)&&9 :
;&&: ;
if(( 
((( 
string(( 

.((
 
IsNullOrEmpty(( 
((( 
jwtKey(( 
)((  
)((  !
{)) 
throw** 	
new**
 %
InvalidOperationException** '
(**' (
$str**( T
)**T U
;**U V
}++ 
builder-- 
.-- 
Services-- 
.-- 
AddAuthentication-- "
(--" #
JwtBearerDefaults--# 4
.--4 5 
AuthenticationScheme--5 I
)--I J
... 
AddJwtBearer.. 
(.. 
options.. 
=>.. 
{// 
options00 
.00 %
TokenValidationParameters00 )
=00* +
new00, /%
TokenValidationParameters000 I
{11 	
ValidateIssuer22 
=22 
true22 !
,22! "
ValidateAudience33 
=33 
true33 #
,33# $
ValidateLifetime44 
=44 
true44 #
,44# $$
ValidateIssuerSigningKey55 $
=55% &
true55' +
,55+ ,
ValidIssuer66 
=66 
	jwtIssuer66 #
,66# $
ValidAudience77 
=77 
jwtAudience77 '
,77' (
IssuerSigningKey88 
=88 
new88 " 
SymmetricSecurityKey88# 7
(887 8
Encoding888 @
.88@ A
UTF888A E
.88E F
GetBytes88F N
(88N O
jwtKey88O U
)88U V
)88V W
,88W X
	ClockSkew99 
=99 
TimeSpan99  
.99  !
Zero99! %
}:: 	
;::	 

};; 
);; 
;;; 
builder>> 
.>> 
Services>> 
.>> 
AddAuthorization>> !
(>>! "
options>>" )
=>>>* ,
{?? 
optionsAA 
.AA 
	AddPolicyAA 
(AA 
$strAA !
,AA! "
policyAA# )
=>AA* ,
policyBB 
.BB 
RequireRoleBB 
(BB 
$strBB *
)BB* +
)BB+ ,
;BB, -
optionsEE 
.EE 
	AddPolicyEE 
(EE 
$strEE (
,EE( )
policyEE* 0
=>EE1 3
policyFF 
.FF 
RequireRoleFF 
(FF 
$strFF *
,FF* +
$strFF, ;
)FF; <
)FF< =
;FF= >
optionsII 
.II 
	AddPolicyII 
(II 
$strII &
,II& '
policyII( .
=>II/ 1
policyJJ 
.JJ 
RequireRoleJJ 
(JJ 
$strJJ .
,JJ. /
$strJJ0 ?
,JJ? @
$strJJA P
)JJP Q
)JJQ R
;JJR S
optionsMM 
.MM 
	AddPolicyMM 
(MM 
$strMM *
,MM* +
policyMM, 2
=>MM3 5
policyNN 
.NN $
RequireAuthenticatedUserNN '
(NN' (
)NN( )
)NN) *
;NN* +
}OO 
)OO 
;OO 
builderRR 
.RR 
ServicesRR 
.RR 
AddRateLimiterRR 
(RR  
optionsRR  '
=>RR( *
{SS 
optionsUU 
.UU 
GlobalLimiterUU 
=UU "
PartitionedRateLimiterUU 2
.UU2 3
CreateUU3 9
<UU9 :
HttpContextUU: E
,UUE F
stringUUG M
>UUM N
(UUN O
httpContextUUO Z
=>UU[ ]
RateLimitPartitionVV 
.VV !
GetFixedWindowLimiterVV 0
(VV0 1
partitionKeyWW 
:WW 
httpContextWW %
.WW% &

ConnectionWW& 0
.WW0 1
RemoteIpAddressWW1 @
?WW@ A
.WWA B
ToStringWWB J
(WWJ K
)WWK L
??WWM O
$strWWP Y
,WWY Z
factoryXX 
:XX 
	partitionXX 
=>XX !
newXX" %)
FixedWindowRateLimiterOptionsXX& C
{YY 
AutoReplenishmentZZ !
=ZZ" #
trueZZ$ (
,ZZ( )
PermitLimit[[ 
=[[ 
$num[[ !
,[[! "
Window\\ 
=\\ 
TimeSpan\\ !
.\\! "
FromMinutes\\" -
(\\- .
$num\\. /
)\\/ 0
}]] 
)]] 
)]] 
;]] 
options`` 
.`` 
	AddPolicy`` 
(`` 
$str`` "
,``" #
httpContext``$ /
=>``0 2
RateLimitPartitionaa 
.aa !
GetFixedWindowLimiteraa 0
(aa0 1
partitionKeybb 
:bb 
httpContextbb %
.bb% &

Connectionbb& 0
.bb0 1
RemoteIpAddressbb1 @
?bb@ A
.bbA B
ToStringbbB J
(bbJ K
)bbK L
??bbM O
$strbbP Y
,bbY Z
factorycc 
:cc 
	partitioncc 
=>cc !
newcc" %)
FixedWindowRateLimiterOptionscc& C
{dd 
AutoReplenishmentee !
=ee" #
trueee$ (
,ee( )
PermitLimitff 
=ff 
$numff  
,ff  !
Windowgg 
=gg 
TimeSpangg !
.gg! "
FromMinutesgg" -
(gg- .
$numgg. /
)gg/ 0
}hh 
)hh 
)hh 
;hh 
optionskk 
.kk 
	AddPolicykk 
(kk 
$strkk "
,kk" #
httpContextkk$ /
=>kk0 2
RateLimitPartitionll 
.ll !
GetFixedWindowLimiterll 0
(ll0 1
partitionKeymm 
:mm 
httpContextmm %
.mm% &

Connectionmm& 0
.mm0 1
RemoteIpAddressmm1 @
?mm@ A
.mmA B
ToStringmmB J
(mmJ K
)mmK L
??mmM O
$strmmP Y
,mmY Z
factorynn 
:nn 
	partitionnn 
=>nn !
newnn" %)
FixedWindowRateLimiterOptionsnn& C
{oo 
AutoReplenishmentpp !
=pp" #
truepp$ (
,pp( )
PermitLimitqq 
=qq 
$numqq !
,qq! "
Windowrr 
=rr 
TimeSpanrr !
.rr! "
FromMinutesrr" -
(rr- .
$numrr. /
)rr/ 0
}ss 
)ss 
)ss 
;ss 
optionsvv 
.vv 
	AddPolicyvv 
(vv 
$strvv #
,vv# $
httpContextvv% 0
=>vv1 3
RateLimitPartitionww 
.ww !
GetFixedWindowLimiterww 0
(ww0 1
partitionKeyxx 
:xx 
httpContextxx %
.xx% &

Connectionxx& 0
.xx0 1
RemoteIpAddressxx1 @
?xx@ A
.xxA B
ToStringxxB J
(xxJ K
)xxK L
??xxM O
$strxxP Y
,xxY Z
factoryyy 
:yy 
	partitionyy 
=>yy !
newyy" %)
FixedWindowRateLimiterOptionsyy& C
{zz 
AutoReplenishment{{ !
={{" #
true{{$ (
,{{( )
PermitLimit|| 
=|| 
$num||  
,||  !
Window}} 
=}} 
TimeSpan}} !
.}}! "
FromMinutes}}" -
(}}- .
$num}}. /
)}}/ 0
}~~ 
)~~ 
)~~ 
;~~ 
options
ÅÅ 
.
ÅÅ 

OnRejected
ÅÅ 
=
ÅÅ 
async
ÅÅ 
(
ÅÅ  
context
ÅÅ  '
,
ÅÅ' (
token
ÅÅ) .
)
ÅÅ. /
=>
ÅÅ0 2
{
ÇÇ 
context
ÉÉ 
.
ÉÉ 
HttpContext
ÉÉ 
.
ÉÉ 
Response
ÉÉ $
.
ÉÉ$ %

StatusCode
ÉÉ% /
=
ÉÉ0 1
$num
ÉÉ2 5
;
ÉÉ5 6
context
ÑÑ 
.
ÑÑ 
HttpContext
ÑÑ 
.
ÑÑ 
Response
ÑÑ $
.
ÑÑ$ %
ContentType
ÑÑ% 0
=
ÑÑ1 2
$str
ÑÑ3 E
;
ÑÑE F
var
ÜÜ 
response
ÜÜ 
=
ÜÜ 
new
ÜÜ 
{
áá 	
error
àà 
=
àà 
$str
àà )
,
àà) *
message
ââ 
=
ââ 
$str
ââ B
,
ââB C

retryAfter
ää 
=
ää 
context
ää  
.
ää  !
Lease
ää! &
.
ää& '
TryGetMetadata
ää' 5
(
ää5 6
MetadataName
ää6 B
.
ääB C

RetryAfter
ääC M
,
ääM N
out
ääO R
var
ääS V

retryAfter
ääW a
)
ääa b
?
ääc d

retryAfter
ääe o
.
ääo p
TotalSeconds
ääp |
:
ää} ~
$numää Å
,ääÅ Ç
	timestamp
ãã 
=
ãã 
DateTime
ãã  
.
ãã  !
UtcNow
ãã! '
}
åå 	
;
åå	 

await
éé 
context
éé 
.
éé 
HttpContext
éé !
.
éé! "
Response
éé" *
.
èè 

WriteAsync
èè 
(
èè 
System
èè 
.
èè 
Text
èè 
.
èè 
Json
èè  
.
èè  !
JsonSerializer
èè! /
.
èè/ 0
	Serialize
èè0 9
(
èè9 :
response
èè: B
)
èèB C
,
èèC D
token
èèE J
)
èèJ K
;
èèK L
}
ëë 
;
ëë 
}íí 
)
íí 
;
íí 
builderïï 
.
ïï 
Services
ïï 
.
ïï %
AddEndpointsApiExplorer
ïï (
(
ïï( )
)
ïï) *
;
ïï* +
builderññ 
.
ññ 
Services
ññ 
.
ññ 
AddSwaggerGen
ññ 
(
ññ 
c
ññ  
=>
ññ! #
{óó 
c
òò 
.
òò 

SwaggerDoc
òò 
(
òò 
$str
òò 
,
òò 
new
òò 
OpenApiInfo
òò &
{
ôô 
Title
öö 
=
öö 
$str
öö (
,
öö( )
Version
õõ 
=
õõ 
$str
õõ 
,
õõ 
Description
úú 
=
úú 
$str
úú E
}
ùù 
)
ùù 
;
ùù 
c
üü 
.
üü #
AddSecurityDefinition
üü 
(
üü 
$str
üü $
,
üü$ %
new
üü& )#
OpenApiSecurityScheme
üü* ?
{
†† 
Name
°° 
=
°° 
$str
°° 
,
°° 
Type
¢¢ 
=
¢¢  
SecuritySchemeType
¢¢ !
.
¢¢! "
Http
¢¢" &
,
¢¢& '
Scheme
££ 
=
££ 
$str
££ 
,
££ 
BearerFormat
§§ 
=
§§ 
$str
§§ 
,
§§ 
In
•• 

=
•• 
ParameterLocation
•• 
.
•• 
Header
•• %
,
••% &
Description
¶¶ 
=
¶¶ 
$str
¶¶ M
}
ßß 
)
ßß 
;
ßß 
c
©© 
.
©© $
AddSecurityRequirement
©© 
(
©© 
new
©©  (
OpenApiSecurityRequirement
©©! ;
{
™™ 
{
´´ 	
new
¨¨ #
OpenApiSecurityScheme
¨¨ %
{
≠≠ 
	Reference
ÆÆ 
=
ÆÆ 
new
ÆÆ 
OpenApiReference
ÆÆ  0
{
ØØ 
Type
∞∞ 
=
∞∞ 
ReferenceType
∞∞ (
.
∞∞( )
SecurityScheme
∞∞) 7
,
∞∞7 8
Id
±± 
=
±± 
$str
±± !
}
≤≤ 
}
≥≥ 
,
≥≥ 
Array
¥¥ 
.
¥¥ 
Empty
¥¥ 
<
¥¥ 
string
¥¥ 
>
¥¥ 
(
¥¥  
)
¥¥  !
}
µµ 	
}
∂∂ 
)
∂∂ 
;
∂∂ 
}∑∑ 
)
∑∑ 
;
∑∑ 
var∫∫ 
allowedOrigins
∫∫ 
=
∫∫ 
builder
∫∫ 
.
∫∫ 
Configuration
∫∫ *
.
∫∫* +

GetSection
∫∫+ 5
(
∫∫5 6
$str
∫∫6 O
)
∫∫O P
.
∫∫P Q
Get
∫∫Q T
<
∫∫T U
string
∫∫U [
[
∫∫[ \
]
∫∫\ ]
>
∫∫] ^
(
∫∫^ _
)
∫∫_ `
??
∫∫a c
new
ªª 
[
ªª 
]
ªª 	
{
ªª
 
$str
ªª #
,
ªª# $
$str
ªª% =
}
ªª> ?
;
ªª? @
builderΩΩ 
.
ΩΩ 
Services
ΩΩ 
.
ΩΩ 
AddCors
ΩΩ 
(
ΩΩ 
options
ΩΩ  
=>
ΩΩ! #
{ææ 
options
øø 
.
øø 
	AddPolicy
øø 
(
øø 
$str
øø $
,
øø$ %
policy
øø& ,
=>
øø- /
{
¿¿ 
policy
¡¡ 
.
¬¬ 
WithOrigins
¬¬ 
(
¬¬ 
allowedOrigins
¬¬ '
)
¬¬' (
.
√√ 
WithMethods
√√ 
(
√√ 
$str
√√ 
,
√√ 
$str
√√  &
,
√√& '
$str
√√( -
,
√√- .
$str
√√/ 7
)
√√7 8
.
ƒƒ 
WithHeaders
ƒƒ 
(
ƒƒ 
$str
ƒƒ '
,
ƒƒ' (
$str
ƒƒ) 8
,
ƒƒ8 9
$str
ƒƒ: F
,
ƒƒF G
$str
ƒƒH T
)
ƒƒT U
.
≈≈ 
AllowCredentials
≈≈ 
(
≈≈ 
)
≈≈ 
.
∆∆  
SetPreflightMaxAge
∆∆ 
(
∆∆  
TimeSpan
∆∆  (
.
∆∆( )
FromMinutes
∆∆) 4
(
∆∆4 5
$num
∆∆5 6
)
∆∆6 7
)
∆∆7 8
;
∆∆8 9
}
«« 
)
«« 
;
«« 
}»» 
)
»» 
;
»» 
var   
app
   
=
   	
builder
  
 
.
   
Build
   
(
   
)
   
;
   
app—— 
.
—— 
Use
—— 
(
—— 
async
—— 
(
—— 
context
—— 
,
—— 
next
—— 
)
—— 
=>
——  
{““ 
context
”” 
.
”” 
Response
”” 
.
”” 
Headers
”” 
.
”” !
XContentTypeOptions
”” 0
=
””1 2
$str
””3 <
;
””< =
context
‘‘ 
.
‘‘ 
Response
‘‘ 
.
‘‘ 
Headers
‘‘ 
.
‘‘ 
XFrameOptions
‘‘ *
=
‘‘+ ,
$str
‘‘- 3
;
‘‘3 4
context
’’ 
.
’’ 
Response
’’ 
.
’’ 
Headers
’’ 
.
’’ 
XXSSProtection
’’ +
=
’’, -
$str
’’. =
;
’’= >
context
÷÷ 
.
÷÷ 
Response
÷÷ 
.
÷÷ 
Headers
÷÷ 
[
÷÷ 
$str
÷÷ .
]
÷÷. /
=
÷÷0 1
$str
÷÷2 S
;
÷÷S T
context
◊◊ 
.
◊◊ 
Response
◊◊ 
.
◊◊ 
Headers
◊◊ 
.
◊◊ #
ContentSecurityPolicy
◊◊ 2
=
◊◊3 4
$str
◊◊5 I
;
◊◊I J
if
ŸŸ 
(
ŸŸ 
app
ŸŸ 
.
ŸŸ 
Environment
ŸŸ 
.
ŸŸ 
IsProduction
ŸŸ $
(
ŸŸ$ %
)
ŸŸ% &
)
ŸŸ& '
{
⁄⁄ 
context
€€ 
.
€€ 
Response
€€ 
.
€€ 
Headers
€€  
.
€€  !%
StrictTransportSecurity
€€! 8
=
€€9 :
$str
€€; `
;
€€` a
}
‹‹ 
await
ﬁﬁ 	
next
ﬁﬁ
 
(
ﬁﬁ 
)
ﬁﬁ 
;
ﬁﬁ 
}ﬂﬂ 
)
ﬂﬂ 
;
ﬂﬂ 
app‰‰ 
.
‰‰ !
UseExceptionHandler
‰‰ 
(
‰‰ 

appBuilder
‰‰ "
=>
‰‰# %
{ÂÂ 

appBuilder
ÊÊ 
.
ÊÊ 
Run
ÊÊ 
(
ÊÊ 
async
ÊÊ 
context
ÊÊ  
=>
ÊÊ! #
{
ÁÁ 
context
ËË 
.
ËË 
Response
ËË 
.
ËË 

StatusCode
ËË #
=
ËË$ %
$num
ËË& )
;
ËË) *
context
ÈÈ 
.
ÈÈ 
Response
ÈÈ 
.
ÈÈ 
ContentType
ÈÈ $
=
ÈÈ% &
$str
ÈÈ' 9
;
ÈÈ9 :
var
ÎÎ 
response
ÎÎ 
=
ÎÎ 
new
ÎÎ 
{
ÏÏ 	
error
ÌÌ 
=
ÌÌ 
$str
ÌÌ 0
,
ÌÌ0 1
	timestamp
ÓÓ 
=
ÓÓ 
DateTime
ÓÓ  
.
ÓÓ  !
UtcNow
ÓÓ! '
}
ÔÔ 	
;
ÔÔ	 

await
ÒÒ 
context
ÒÒ 
.
ÒÒ 
Response
ÒÒ 
.
ÒÒ 

WriteAsync
ÒÒ )
(
ÒÒ) *
System
ÒÒ* 0
.
ÒÒ0 1
Text
ÒÒ1 5
.
ÒÒ5 6
Json
ÒÒ6 :
.
ÒÒ: ;
JsonSerializer
ÒÒ; I
.
ÒÒI J
	Serialize
ÒÒJ S
(
ÒÒS T
response
ÒÒT \
)
ÒÒ\ ]
)
ÒÒ] ^
;
ÒÒ^ _
}
ÚÚ 
)
ÚÚ 
;
ÚÚ 
}ÛÛ 
)
ÛÛ 
;
ÛÛ 
ifıı 
(
ıı 
app
ıı 
.
ıı 
Environment
ıı 
.
ıı 
IsDevelopment
ıı !
(
ıı! "
)
ıı" #
)
ıı# $
{ˆˆ 
app
˜˜ 
.
˜˜ 

UseSwagger
˜˜ 
(
˜˜ 
)
˜˜ 
;
˜˜ 
app
¯¯ 
.
¯¯ 
UseSwaggerUI
¯¯ 
(
¯¯ 
c
¯¯ 
=>
¯¯ 
{
˘˘ 
c
˙˙ 	
.
˙˙	 

SwaggerEndpoint
˙˙
 
(
˙˙ 
$str
˙˙ 4
,
˙˙4 5
$str
˙˙6 F
)
˙˙F G
;
˙˙G H
c
˚˚ 	
.
˚˚	 

RoutePrefix
˚˚
 
=
˚˚ 
string
˚˚ 
.
˚˚ 
Empty
˚˚ $
;
˚˚$ %
}
¸¸ 
)
¸¸ 
;
¸¸ 
}˝˝ 
appÄÄ 
.
ÄÄ !
UseHttpsRedirection
ÄÄ 
(
ÄÄ 
)
ÄÄ 
;
ÄÄ 
appÉÉ 
.
ÉÉ 
UseCors
ÉÉ 
(
ÉÉ 
$str
ÉÉ 
)
ÉÉ 
;
ÉÉ 
appÜÜ 
.
ÜÜ 
UseRateLimiter
ÜÜ 
(
ÜÜ 
)
ÜÜ 
;
ÜÜ 
ifââ 
(
ââ 
app
ââ 
.
ââ 
Environment
ââ 
.
ââ 
IsDevelopment
ââ !
(
ââ! "
)
ââ" #
)
ââ# $
{ää 
app
ãã 
.
ãã 
Use
ãã 
(
ãã 
async
ãã 
(
ãã 
context
ãã 
,
ãã 
next
ãã  
)
ãã  !
=>
ãã" $
{
åå 
var
çç 
logger
çç 
=
çç 
context
çç 
.
çç 
RequestServices
çç ,
.
çç, - 
GetRequiredService
çç- ?
<
çç? @
ILogger
çç@ G
<
ççG H
Program
ççH O
>
ççO P
>
ççP Q
(
ççQ R
)
ççR S
;
ççS T
var
éé 
	stopwatch
éé 
=
éé 
System
éé 
.
éé 
Diagnostics
éé *
.
éé* +
	Stopwatch
éé+ 4
.
éé4 5
StartNew
éé5 =
(
éé= >
)
éé> ?
;
éé? @
await
êê 
next
êê 
(
êê 
)
êê 
;
êê 
	stopwatch
íí 
.
íí 
Stop
íí 
(
íí 
)
íí 
;
íí 
logger
ìì 
.
ìì 
LogInformation
ìì 
(
ìì 
$str
îî A
,
îîA B
context
ïï 
.
ïï 
Request
ïï 
.
ïï 
Method
ïï "
,
ïï" #
context
ññ 
.
ññ 
Request
ññ 
.
ññ 
Path
ññ  
,
ññ  !
context
óó 
.
óó 
Response
óó 
.
óó 

StatusCode
óó '
,
óó' (
	stopwatch
òò 
.
òò !
ElapsedMilliseconds
òò )
)
òò) *
;
òò* +
}
ôô 
)
ôô 
;
ôô 
}öö 
appùù 
.
ùù 
UseAuthentication
ùù 
(
ùù 
)
ùù 
;
ùù 
appûû 
.
ûû 
UseAuthorization
ûû 
(
ûû 
)
ûû 
;
ûû 
app†† 
.
†† 
MapControllers
†† 
(
†† 
)
†† 
;
†† 
app££ 
.
££ 
MapGet
££ 

(
££
 
$str
££ 
,
££ 
(
££ 
)
££ 
=>
££ 
new
££ 
{§§ 
Status
•• 

=
•• 
$str
•• 
,
•• 
	Timestamp
¶¶ 
=
¶¶ 
DateTime
¶¶ 
.
¶¶ 
UtcNow
¶¶ 
,
¶¶  
Environment
ßß 
=
ßß 
app
ßß 
.
ßß 
Environment
ßß !
.
ßß! "
EnvironmentName
ßß" 1
}®® 
)
®® 
.
®® 
AllowAnonymous
®® 
(
®® 
)
®® 
.
®® !
RequireRateLimiting
®® '
(
®®' (
$str
®®( 4
)
®®4 5
;
®®5 6
using´´ 
(
´´ 
var
´´ 

scope
´´ 
=
´´ 
app
´´ 
.
´´ 
Services
´´ 
.
´´  
CreateScope
´´  +
(
´´+ ,
)
´´, -
)
´´- .
{¨¨ 
try
≠≠ 
{
ÆÆ 
var
ØØ 
mongoService
ØØ 
=
ØØ 
scope
ØØ  
.
ØØ  !
ServiceProvider
ØØ! 0
.
ØØ0 1 
GetRequiredService
ØØ1 C
<
ØØC D
MongoDBService
ØØD R
>
ØØR S
(
ØØS T
)
ØØT U
;
ØØU V
await
∞∞ 
mongoService
∞∞ 
.
∞∞  
CreateIndexesAsync
∞∞ -
(
∞∞- .
)
∞∞. /
;
∞∞/ 0
var
≤≤ 
logger
≤≤ 
=
≤≤ 
scope
≤≤ 
.
≤≤ 
ServiceProvider
≤≤ *
.
≤≤* + 
GetRequiredService
≤≤+ =
<
≤≤= >
ILogger
≤≤> E
<
≤≤E F
Program
≤≤F M
>
≤≤M N
>
≤≤N O
(
≤≤O P
)
≤≤P Q
;
≤≤Q R
logger
≥≥ 
.
≥≥ 
LogInformation
≥≥ 
(
≥≥ 
$str
≥≥ D
)
≥≥D E
;
≥≥E F
var
∂∂ 
userService
∂∂ 
=
∂∂ 
scope
∂∂ 
.
∂∂  
ServiceProvider
∂∂  /
.
∂∂/ 0 
GetRequiredService
∂∂0 B
<
∂∂B C
UserService
∂∂C N
>
∂∂N O
(
∂∂O P
)
∂∂P Q
;
∂∂Q R
var
∑∑ 
	adminUser
∑∑ 
=
∑∑ 
await
∑∑ 
userService
∑∑ )
.
∑∑) *$
GetUserByUserNameAsync
∑∑* @
(
∑∑@ A
$str
∑∑A H
)
∑∑H I
;
∑∑I J
if
ππ 

(
ππ 
	adminUser
ππ 
==
ππ 
null
ππ 
)
ππ 
{
∫∫ 	
var
ªª 
defaultAdmin
ªª 
=
ªª 
new
ªª "
User
ªª# '
{
ºº 
Username
ΩΩ 
=
ΩΩ 
$str
ΩΩ "
,
ΩΩ" #
Email
ææ 
=
ææ 
$str
ææ .
,
ææ. /
Role
øø 
=
øø 
$str
øø &
}
¿¿ 
;
¿¿ 
await
¬¬ 
userService
¬¬ 
.
¬¬ 
CreateUserAsync
¬¬ -
(
¬¬- .
defaultAdmin
¬¬. :
,
¬¬: ;
$str
¬¬< G
)
¬¬G H
;
¬¬H I
logger
√√ 
.
√√ 
LogInformation
√√ !
(
√√! "
$str
√√" L
)
√√L M
;
√√M N
}
ƒƒ 	
}
≈≈ 
catch
∆∆ 	
(
∆∆
 
	Exception
∆∆ 
ex
∆∆ 
)
∆∆ 
{
«« 
var
»» 
logger
»» 
=
»» 
scope
»» 
.
»» 
ServiceProvider
»» *
.
»»* + 
GetRequiredService
»»+ =
<
»»= >
ILogger
»»> E
<
»»E F
Program
»»F M
>
»»M N
>
»»N O
(
»»O P
)
»»P Q
;
»»Q R
logger
…… 
.
…… 
LogError
…… 
(
…… 
ex
…… 
,
…… 
$str
…… =
)
……= >
;
……> ?
throw
   
;
   
}
ÀÀ 
}ÃÃ 
awaitŒŒ 
app
ŒŒ 	
.
ŒŒ	 

RunAsync
ŒŒ
 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ ˇ
EC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Models\User.cs
	namespace 	

LibraryApp
 
. 
Models 
{ 
public 

class 
User 
{ 
[ 	
BsonId	 
] 
[ 	
BsonRepresentation	 
( 
BsonType $
.$ %
ObjectId% -
)- .
]. /
public		 
string		 
Id		 
{		 
get		 
;		 
set		  #
;		# $
}		% &
=		' (
null		) -
!		- .
;		. /
public

 
string

 
Username

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
=

- .
string

/ 5
.

5 6
Empty

6 ;
;

; <
public 
string 
PasswordHash "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
string3 9
.9 :
Empty: ?
;? @
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
=* +
string, 2
.2 3
Empty3 8
;8 9
public 
DateTime 
	CreatedAt !
{" #
get$ '
;' (
set) ,
;, -
}. /
=0 1
DateTime2 :
.: ;
UtcNow; A
;A B
public 
bool 
IsActive 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
true- 1
;1 2
public 
string 
Role 
{ 
get  
;  !
set" %
;% &
}' (
=) *
$str+ >
;> ?
} 
} Ó
IC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Models\LogEntry.cs
	namespace 	

LibraryApp
 
. 
Models 
{ 
public 

class 
LogEntry 
{ 
[		 	
BsonId			 
]		 
[

 	
BsonRepresentation

	 
(

 
BsonType

 $
.

$ %
ObjectId

% -
)

- .
]

. /
public 
string 
Id 
{ 
get 
; 
set  #
;# $
}% &
public 
DateTime 
	Timestamp !
{" #
get$ '
;' (
set) ,
;, -
}. /
=0 1
DateTime2 :
.: ;
UtcNow; A
;A B
public 
string 
Level 
{ 
get !
;! "
set# &
;& '
}( )
=* +
string, 2
.2 3
Empty3 8
;8 9
public 
string 
Message 
{ 
get  #
;# $
set% (
;( )
}* +
=, -
string. 4
.4 5
Empty5 :
;: ;
public 
string 
? 
	Exception  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
? 
Username 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
? 
Action 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
? 

Controller !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ÉG
EC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Models\Loan.cs
	namespace 	

LibraryApp
 
. 
Models 
{ 
public 

class 
Loan 
{ 
[ 	
BsonId	 
] 
[		 	
BsonRepresentation			 
(		 
BsonType		 $
.		$ %
ObjectId		% -
)		- .
]		. /
public

 
string

 
Id

 
{

 
get

 
;

 
set

  #
;

# $
}

% &
=

' (
null

) -
!

- .
;

. /
[ 	
BsonRequired	 
] 
public 
string 
BookId 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
string- 3
.3 4
Empty4 9
;9 :
[ 	
BsonRequired	 
] 
public 
string 
UserId 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
string- 3
.3 4
Empty4 9
;9 :
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
public 
string 
	BookTitle 
{  !
get" %
;% &
set' *
;* +
}, -
=. /
string0 6
.6 7
Empty7 <
;< =
public 
string 

BookAuthor  
{! "
get# &
;& '
set( +
;+ ,
}- .
=/ 0
string1 7
.7 8
Empty8 =
;= >
public 
DateTime 
LoanDate  
{! "
get# &
;& '
set( +
;+ ,
}- .
=/ 0
DateTime1 9
.9 :
UtcNow: @
;@ A
public 
DateTime 
DueDate 
{  !
get" %
;% &
set' *
;* +
}, -
=. /
DateTime0 8
.8 9
UtcNow9 ?
.? @
AddDays@ G
(G H
$numH J
)J K
;K L
public 
DateTime 
? 

ReturnDate #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 

LoanStatus 
Status  
{! "
get# &
;& '
set( +
;+ ,
}- .
=/ 0

LoanStatus1 ;
.; <
Active< B
;B C
public   
string   
Notes   
{   
get   !
;  ! "
set  # &
;  & '
}  ( )
=  * +
string  , 2
.  2 3
Empty  3 8
;  8 9
public## 
string## 
ProcessedBy## !
{##" #
get##$ '
;##' (
set##) ,
;##, -
}##. /
=##0 1
string##2 8
.##8 9
Empty##9 >
;##> ?
public%% 
DateTime%% 
	CreatedAt%% !
{%%" #
get%%$ '
;%%' (
set%%) ,
;%%, -
}%%. /
=%%0 1
DateTime%%2 :
.%%: ;
UtcNow%%; A
;%%A B
public'' 
DateTime'' 
	UpdatedAt'' !
{''" #
get''$ '
;''' (
set'') ,
;'', -
}''. /
=''0 1
DateTime''2 :
.'': ;
UtcNow''; A
;''A B
}(( 
public** 

enum** 

LoanStatus** 
{++ 
Active,, 
,,, 
Returned-- 
,-- 
Overdue.. 
,.. 
Lost// 
}00 
public22 

class22 
LoanRequestDTO22 
{33 
public44 
string44 
BookId44 
{44 
get44 "
;44" #
set44$ '
;44' (
}44) *
=44+ ,
string44- 3
.443 4
Empty444 9
;449 :
public55 
int55 
LoanDays55 
{55 
get55 !
;55! "
set55# &
;55& '
}55( )
=55* +
$num55, .
;55. /
public66 
string66 
Notes66 
{66 
get66 !
;66! "
set66# &
;66& '
}66( )
=66* +
string66, 2
.662 3
Empty663 8
;668 9
public88 
string88 
?88 
Username88 
{88  !
get88" %
;88% &
set88' *
;88* +
}88, -
}99 
public;; 

class;; 
ReturnBookDTO;; 
{<< 
public== 
string== 
LoanId== 
{== 
get== "
;==" #
set==$ '
;==' (
}==) *
===+ ,
string==- 3
.==3 4
Empty==4 9
;==9 :
public>> 
string>> 
Notes>> 
{>> 
get>> !
;>>! "
set>># &
;>>& '
}>>( )
=>>* +
string>>, 2
.>>2 3
Empty>>3 8
;>>8 9
public?? 

LoanStatus?? 
Status??  
{??! "
get??# &
;??& '
set??( +
;??+ ,
}??- .
=??/ 0

LoanStatus??1 ;
.??; <
Returned??< D
;??D E
}@@ 
publicBB 

classBB 
UpdateLoanDTOBB 
{CC 
publicDD 
DateTimeDD 
?DD 
DueDateDD  
{DD! "
getDD# &
;DD& '
setDD( +
;DD+ ,
}DD- .
publicEE 
stringEE 
?EE 
NotesEE 
{EE 
getEE "
;EE" #
setEE$ '
;EE' (
}EE) *
}FF 
publicII 

classII 
LoanResponseDTOII  
{JJ 
publicKK 
stringKK 
IdKK 
{KK 
getKK 
;KK 
setKK  #
;KK# $
}KK% &
=KK' (
stringKK) /
.KK/ 0
EmptyKK0 5
;KK5 6
publicLL 
stringLL 
BookIdLL 
{LL 
getLL "
;LL" #
setLL$ '
;LL' (
}LL) *
=LL+ ,
stringLL- 3
.LL3 4
EmptyLL4 9
;LL9 :
publicMM 
stringMM 
	BookTitleMM 
{MM  !
getMM" %
;MM% &
setMM' *
;MM* +
}MM, -
=MM. /
stringMM0 6
.MM6 7
EmptyMM7 <
;MM< =
publicNN 
stringNN 

BookAuthorNN  
{NN! "
getNN# &
;NN& '
setNN( +
;NN+ ,
}NN- .
=NN/ 0
stringNN1 7
.NN7 8
EmptyNN8 =
;NN= >
publicOO 
stringOO 
UsernameOO 
{OO  
getOO! $
;OO$ %
setOO& )
;OO) *
}OO+ ,
=OO- .
stringOO/ 5
.OO5 6
EmptyOO6 ;
;OO; <
publicPP 
DateTimePP 
LoanDatePP  
{PP! "
getPP# &
;PP& '
setPP( +
;PP+ ,
}PP- .
publicQQ 
DateTimeQQ 
DueDateQQ 
{QQ  !
getQQ" %
;QQ% &
setQQ' *
;QQ* +
}QQ, -
publicRR 
DateTimeRR 
?RR 

ReturnDateRR #
{RR$ %
getRR& )
;RR) *
setRR+ .
;RR. /
}RR0 1
publicSS 

LoanStatusSS 
StatusSS  
{SS! "
getSS# &
;SS& '
setSS( +
;SS+ ,
}SS- .
publicTT 
stringTT 
NotesTT 
{TT 
getTT !
;TT! "
setTT# &
;TT& '
}TT( )
=TT* +
stringTT, 2
.TT2 3
EmptyTT3 8
;TT8 9
publicUU 
stringUU 
ProcessedByUU !
{UU" #
getUU$ '
;UU' (
setUU) ,
;UU, -
}UU. /
=UU0 1
stringUU2 8
.UU8 9
EmptyUU9 >
;UU> ?
publicVV 
boolVV 
	IsOverdueVV 
=>VV  
StatusVV! '
==VV( *

LoanStatusVV+ 5
.VV5 6
ActiveVV6 <
&&VV= ?
DateTimeVV@ H
.VVH I
UtcNowVVI O
>VVP Q
DueDateVVR Y
;VVY Z
}WW 
}XX ∑9
EC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Models\Book.cs
	namespace 	

LibraryApp
 
. 
Models 
{ 
public 

class 
Book 
{		 
[

 	
BsonId

	 
]

 
[ 	
BsonRepresentation	 
( 
BsonType $
.$ %
ObjectId% -
)- .
]. /
public 
string 
Id 
{ 
get 
; 
set  #
;# $
}% &
=' (
null) -
!- .
;. /
[ 	
BsonRequired	 
] 
public 
string 
Title 
{ 
get !
;! "
set# &
;& '
}( )
=* +
string, 2
.2 3
Empty3 8
;8 9
[ 	
BsonRequired	 
] 
public 
string 
Author 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
string- 3
.3 4
Empty4 9
;9 :
public 
string 
ISBN 
{ 
get  
;  !
set" %
;% &
}' (
=) *
string+ 1
.1 2
Empty2 7
;7 8
public 
string 
	Publisher 
{  !
get" %
;% &
set' *
;* +
}, -
=. /
string0 6
.6 7
Empty7 <
;< =
public 
int 
PublicationYear "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
string 
Category 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
=0 1
string2 8
.8 9
Empty9 >
;> ?
public 
int 
AvailableCopies "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
$num3 4
;4 5
public   
int   
TotalCopies   
{    
get  ! $
;  $ %
set  & )
;  ) *
}  + ,
=  - .
$num  / 0
;  0 1
public"" 
DateTime"" 
	CreatedAt"" !
{""" #
get""$ '
;""' (
set"") ,
;"", -
}"". /
=""0 1
DateTime""2 :
."": ;
UtcNow""; A
;""A B
public$$ 
DateTime$$ 
	UpdatedAt$$ !
{$$" #
get$$$ '
;$$' (
set$$) ,
;$$, -
}$$. /
=$$0 1
DateTime$$2 :
.$$: ;
UtcNow$$; A
;$$A B
public&& 
bool&& 
IsActive&& 
{&& 
get&& "
;&&" #
set&&$ '
;&&' (
}&&) *
=&&+ ,
true&&- 1
;&&1 2
public)) 
string)) 
	CreatedBy)) 
{))  !
get))" %
;))% &
set))' *
;))* +
})), -
=)). /
string))0 6
.))6 7
Empty))7 <
;))< =
}** 
public,, 

class,, 
BookDTO,, 
{-- 
public.. 
string.. 
Title.. 
{.. 
get.. !
;..! "
set..# &
;..& '
}..( )
=..* +
string.., 2
...2 3
Empty..3 8
;..8 9
public// 
string// 
Author// 
{// 
get// "
;//" #
set//$ '
;//' (
}//) *
=//+ ,
string//- 3
.//3 4
Empty//4 9
;//9 :
public00 
string00 
ISBN00 
{00 
get00  
;00  !
set00" %
;00% &
}00' (
=00) *
string00+ 1
.001 2
Empty002 7
;007 8
public11 
string11 
	Publisher11 
{11  !
get11" %
;11% &
set11' *
;11* +
}11, -
=11. /
string110 6
.116 7
Empty117 <
;11< =
[22 	
Required22	 
]22 
public33 
int33 
PublicationYear33 "
{33# $
get33% (
;33( )
set33* -
;33- .
}33/ 0
public44 
string44 
Category44 
{44  
get44! $
;44$ %
set44& )
;44) *
}44+ ,
=44- .
string44/ 5
.445 6
Empty446 ;
;44; <
public55 
string55 
Description55 !
{55" #
get55$ '
;55' (
set55) ,
;55, -
}55. /
=550 1
string552 8
.558 9
Empty559 >
;55> ?
public66 
int66 
TotalCopies66 
{66  
get66! $
;66$ %
set66& )
;66) *
}66+ ,
=66- .
$num66/ 0
;660 1
}77 
public99 

class99 
UpdateBookDTO99 
{:: 
public;; 
string;; 
Title;; 
{;; 
get;; !
;;;! "
set;;# &
;;;& '
};;( )
=;;* +
string;;, 2
.;;2 3
Empty;;3 8
;;;8 9
public<< 
string<< 
Author<< 
{<< 
get<< "
;<<" #
set<<$ '
;<<' (
}<<) *
=<<+ ,
string<<- 3
.<<3 4
Empty<<4 9
;<<9 :
public== 
string== 
	Publisher== 
{==  !
get==" %
;==% &
set==' *
;==* +
}==, -
===. /
string==0 6
.==6 7
Empty==7 <
;==< =
[?? 	
Required??	 
]?? 
public@@ 
int@@ 
PublicationYear@@ "
{@@# $
get@@% (
;@@( )
set@@* -
;@@- .
}@@/ 0
publicAA 
stringAA 
CategoryAA 
{AA  
getAA! $
;AA$ %
setAA& )
;AA) *
}AA+ ,
=AA- .
stringAA/ 5
.AA5 6
EmptyAA6 ;
;AA; <
publicBB 
stringBB 
DescriptionBB !
{BB" #
getBB$ '
;BB' (
setBB) ,
;BB, -
}BB. /
=BB0 1
stringBB2 8
.BB8 9
EmptyBB9 >
;BB> ?
publicCC 
intCC 
?CC 
TotalCopiesCC 
{CC  !
getCC" %
;CC% &
setCC' *
;CC* +
}CC, -
}DD 
}EE £Ê
TC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Controllers\BookController.cs
	namespace		 	

LibraryApp		
 
.		 
Controllers		  
{

 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
[ 
	Authorize 
] 
public 

class 
BooksController  
:! "
ControllerBase# 1
{ 
private 
readonly 
BookService $
_bookService% 1
;1 2
private 
readonly 

Logservice #
_logService$ /
;/ 0
private 
const 
string 
LogError %
=& '
$str( /
;/ 0
private 
const 
string 

LogWarning '
=( )
$str* 3
;3 4
private 
const 
string 
LogInfo $
=% &
$str' 4
;4 5
private 
const 
string 
ErrInternalServer .
=/ 0
$str1 M
;M N
private 
const 
string 
UnknownValue )
=* +
$str, ;
;; <
private 
const 
string 
BookNotFound )
=* +
$str, A
;A B
private 
const 
string  
BadRequestIdRequired 1
=2 3
$str4 O
;O P
public 
BooksController 
( 
BookService *
bookService+ 6
,6 7

Logservice8 B

logServiceC M
)M N
{ 	
_bookService 
= 
bookService &
;& '
_logService 
= 

logService $
;$ %
} 	
[!! 	
HttpGet!!	 
]!! 
["" 	
	Authorize""	 
]"" 
[## 	
EnableRateLimiting##	 
(## 
$str## (
)##( )
]##) *
public$$ 
async$$ 
Task$$ 
<$$ 
ActionResult$$ &
<$$& '
IEnumerable$$' 2
<$$2 3
Book$$3 7
>$$7 8
>$$8 9
>$$9 :
GetBooks$$; C
($$C D
)$$D E
{%% 	
try&& 
{'' 
var(( 
username(( 
=(( 
User(( #
.((# $
Identity(($ ,
?((, -
.((- .
Name((. 2
??((3 5
UnknownValue((6 B
;((B C
var)) 
role)) 
=)) 
User)) 
.))  
	FindFirst))  )
())) *

ClaimTypes))* 4
.))4 5
Role))5 9
)))9 :
?)): ;
.)); <
Value))< A
??))B D
UnknownValue))E Q
;))Q R
await** 
_logService** !
.**! "
LogAsync**" *
(*** +
LogInfo**+ 2
,**2 3
$"**4 6
$str**6 >
{**> ?
username**? G
}**G H
$str**H O
{**O P
role**P T
}**T U
$str**U i
"**i j
)**j k
;**k l
var,, 
books,, 
=,, 
await,, !
_bookService,," .
.,,. /
GetAllBooksAsync,,/ ?
(,,? @
),,@ A
;,,A B
return-- 
Ok-- 
(-- 
books-- 
)--  
;--  !
}.. 
catch// 
(// 
	Exception// 
ex// 
)//  
{00 
await11 
_logService11 !
.11! "
LogAsync11" *
(11* +
LogError11+ 3
,113 4
$str115 N
,11N O
ex11P R
)11R S
;11S T
return22 

StatusCode22 !
(22! "
$num22" %
,22% &
ErrInternalServer22' 8
)228 9
;229 :
}33 
}44 	
[77 	
HttpGet77	 
(77 
$str77 
)77 
]77 
[88 	
	Authorize88	 
]88 
[99 	
EnableRateLimiting99	 
(99 
$str99 (
)99( )
]99) *
public:: 
async:: 
Task:: 
<:: 
ActionResult:: &
<::& '
Book::' +
>::+ ,
>::, -
GetBook::. 5
(::5 6
string::6 <
id::= ?
)::? @
{;; 	
try<< 
{== 
if>> 
(>> 
string>> 
.>> 
IsNullOrEmpty>> (
(>>( )
id>>) +
)>>+ ,
)>>, -
{?? 
await@@ 
_logService@@ %
.@@% &
LogAsync@@& .
(@@. /

LogWarning@@/ 9
,@@9 :
$str@@; f
)@@f g
;@@g h
returnAA 

BadRequestAA %
(AA% & 
BadRequestIdRequiredAA& :
)AA: ;
;AA; <
}BB 
varDD 
usernameDD 
=DD 
UserDD #
.DD# $
IdentityDD$ ,
?DD, -
.DD- .
NameDD. 2
??DD3 5
UnknownValueDD6 B
;DDB C
varEE 
roleEE 
=EE 
UserEE 
.EE  
	FindFirstEE  )
(EE) *

ClaimTypesEE* 4
.EE4 5
RoleEE5 9
)EE9 :
?EE: ;
.EE; <
ValueEE< A
??EEB D
UnknownValueEEE Q
;EEQ R
awaitFF 
_logServiceFF !
.FF! "
LogAsyncFF" *
(FF* +
LogInfoFF+ 2
,FF2 3
$"FF4 6
$strFF6 >
{FF> ?
usernameFF? G
}FFG H
$strFFH O
{FFO P
roleFFP T
}FFT U
$strFFU i
{FFi j
idFFj l
}FFl m
"FFm n
)FFn o
;FFo p
varHH 
bookHH 
=HH 
awaitHH  
_bookServiceHH! -
.HH- .
GetBookByIdAsyncHH. >
(HH> ?
idHH? A
)HHA B
;HHB C
ifII 
(II 
bookII 
==II 
nullII  
)II  !
{JJ 
awaitKK 
_logServiceKK %
.KK% &
LogAsyncKK& .
(KK. /

LogWarningKK/ 9
,KK9 :
$"KK; =
$strKK= R
{KKR S
idKKS U
}KKU V
"KKV W
)KKW X
;KKX Y
returnLL 
NotFoundLL #
(LL# $
BookNotFoundLL$ 0
)LL0 1
;LL1 2
}MM 
returnOO 
OkOO 
(OO 
bookOO 
)OO 
;OO  
}PP 
catchQQ 
(QQ 
	ExceptionQQ 
exQQ 
)QQ  
{RR 
awaitSS 
_logServiceSS !
.SS! "
LogAsyncSS" *
(SS* +
LogErrorSS+ 3
,SS3 4
$"SS5 7
$strSS7 N
{SSN O
idSSO Q
}SSQ R
"SSR S
,SSS T
exSSU W
)SSW X
;SSX Y
returnTT 

StatusCodeTT !
(TT! "
$numTT" %
,TT% &
ErrInternalServerTT' 8
)TT8 9
;TT9 :
}UU 
}VV 	
[YY 	
HttpGetYY	 
(YY 
$strYY 
)YY 
]YY 
[ZZ 	
	AuthorizeZZ	 
]ZZ 
[[[ 	
EnableRateLimiting[[	 
([[ 
$str[[ (
)[[( )
][[) *
public\\ 
async\\ 
Task\\ 
<\\ 
ActionResult\\ &
<\\& '
IEnumerable\\' 2
<\\2 3
Book\\3 7
>\\7 8
>\\8 9
>\\9 :
SearchBooks\\; F
(\\F G
[\\G H
	FromQuery\\H Q
]\\Q R
string\\S Y

searchTerm\\Z d
)\\d e
{]] 	
try^^ 
{__ 
var`` 
username`` 
=`` 
User`` #
.``# $
Identity``$ ,
?``, -
.``- .
Name``. 2
??``3 5
UnknownValue``6 B
;``B C
varaa 
roleaa 
=aa 
Useraa 
.aa  
	FindFirstaa  )
(aa) *

ClaimTypesaa* 4
.aa4 5
Roleaa5 9
)aa9 :
?aa: ;
.aa; <
Valueaa< A
??aaB D
UnknownValueaaE Q
;aaQ R
awaitbb 
_logServicebb !
.bb! "
LogAsyncbb" *
(bb* +
LogInfobb+ 2
,bb2 3
$"bb4 6
$strbb6 >
{bb> ?
usernamebb? G
}bbG H
$strbbH O
{bbO P
rolebbP T
}bbT U
$strbbU h
{bbh i

searchTermbbi s
}bbs t
"bbt u
)bbu v
;bbv w
vardd 
booksdd 
=dd 
awaitdd !
_bookServicedd" .
.dd. /
SearchBooksAsyncdd/ ?
(dd? @

searchTermdd@ J
)ddJ K
;ddK L
returnee 
Okee 
(ee 
booksee 
)ee  
;ee  !
}ff 
catchgg 
(gg 
	Exceptiongg 
exgg 
)gg  
{hh 
awaitii 
_logServiceii !
.ii! "
LogAsyncii" *
(ii* +
LogErrorii+ 3
,ii3 4
$"ii5 7
$strii7 T
{iiT U

searchTermiiU _
}ii_ `
"ii` a
,iia b
exiic e
)iie f
;iif g
returnjj 

StatusCodejj !
(jj! "
$numjj" %
,jj% &
ErrInternalServerjj' 8
)jj8 9
;jj9 :
}kk 
}ll 	
[oo 	
HttpPostoo	 
]oo 
[pp 	
	Authorizepp	 
(pp 
Rolespp 
=pp 
$strpp 8
)pp8 9
]pp9 :
[qq 	
EnableRateLimitingqq	 
(qq 
$strqq )
)qq) *
]qq* +
publicrr 
asyncrr 
Taskrr 
<rr 
ActionResultrr &
<rr& '
Bookrr' +
>rr+ ,
>rr, -

CreateBookrr. 8
(rr8 9
[rr9 :
FromBodyrr: B
]rrB C
BookDTOrrD K
bookDtorrL S
)rrS T
{ss 	
trytt 
{uu 
ifvv 
(vv 
!vv 

ModelStatevv 
.vv  
IsValidvv  '
)vv' (
{ww 
awaitxx 
_logServicexx %
.xx% &
LogAsyncxx& .
(xx. /

LogWarningxx/ 9
,xx9 :
$strxx; ]
)xx] ^
;xx^ _
returnyy 

BadRequestyy %
(yy% &

ModelStateyy& 0
)yy0 1
;yy1 2
}zz 
if|| 
(|| 
string|| 
.|| 
IsNullOrEmpty|| (
(||( )
bookDto||) 0
.||0 1
Title||1 6
)||6 7
||||8 :
string||; A
.||A B
IsNullOrEmpty||B O
(||O P
bookDto||P W
.||W X
Author||X ^
)||^ _
)||_ `
{}} 
await~~ 
_logService~~ %
.~~% &
LogAsync~~& .
(~~. /

LogWarning~~/ 9
,~~9 :
$str~~; k
)~~k l
;~~l m
return 

BadRequest %
(% &
$str& E
)E F
;F G
}
ÄÄ 
var
ÇÇ 
username
ÇÇ 
=
ÇÇ 
User
ÇÇ #
.
ÇÇ# $
Identity
ÇÇ$ ,
?
ÇÇ, -
.
ÇÇ- .
Name
ÇÇ. 2
??
ÇÇ3 5
UnknownValue
ÇÇ6 B
;
ÇÇB C
var
ÉÉ 
role
ÉÉ 
=
ÉÉ 
User
ÉÉ 
.
ÉÉ  
	FindFirst
ÉÉ  )
(
ÉÉ) *

ClaimTypes
ÉÉ* 4
.
ÉÉ4 5
Role
ÉÉ5 9
)
ÉÉ9 :
?
ÉÉ: ;
.
ÉÉ; <
Value
ÉÉ< A
??
ÉÉB D
UnknownValue
ÉÉE Q
;
ÉÉQ R
await
ÖÖ 
_logService
ÖÖ !
.
ÖÖ! "
LogAsync
ÖÖ" *
(
ÖÖ* +
LogInfo
ÖÖ+ 2
,
ÖÖ2 3
$"
ÖÖ4 6
$str
ÖÖ6 >
{
ÖÖ> ?
username
ÖÖ? G
}
ÖÖG H
$str
ÖÖH O
{
ÖÖO P
role
ÖÖP T
}
ÖÖT U
$str
ÖÖU f
{
ÖÖf g
bookDto
ÖÖg n
.
ÖÖn o
Title
ÖÖo t
}
ÖÖt u
"
ÖÖu v
)
ÖÖv w
;
ÖÖw x
var
áá 
createdBook
áá 
=
áá  !
await
áá" '
_bookService
áá( 4
.
áá4 5
CreateBookAsync
áá5 D
(
ááD E
bookDto
ááE L
,
ááL M
username
ááN V
)
ááV W
;
ááW X
if
ââ 
(
ââ 
createdBook
ââ 
==
ââ  "
null
ââ# '
)
ââ' (
{
ää 
await
ãã 
_logService
ãã %
.
ãã% &
LogAsync
ãã& .
(
ãã. /

LogWarning
ãã/ 9
,
ãã9 :
$"
ãã; =
$str
ãã= X
{
ããX Y
bookDto
ããY `
.
ãã` a
Title
ããa f
}
ããf g
"
ããg h
)
ããh i
;
ããi j
return
åå 
Conflict
åå #
(
åå# $
$str
åå$ X
)
ååX Y
;
ååY Z
}
çç 
await
èè 
_logService
èè !
.
èè! "
LogAsync
èè" *
(
èè* +
LogInfo
èè+ 2
,
èè2 3
$"
èè4 6
$str
èè6 Q
{
èèQ R
createdBook
èèR ]
.
èè] ^
Title
èè^ c
}
èèc d
$str
èèd i
{
èèi j
username
èèj r
}
èèr s
$str
èès z
{
èèz {
role
èè{ 
}èè Ä
$strèèÄ Å
"èèÅ Ç
)èèÇ É
;èèÉ Ñ
return
êê 
CreatedAtAction
êê &
(
êê& '
nameof
êê' -
(
êê- .
GetBook
êê. 5
)
êê5 6
,
êê6 7
new
êê8 ;
{
êê< =
id
êê> @
=
êêA B
createdBook
êêC N
.
êêN O
Id
êêO Q
}
êêR S
,
êêS T
createdBook
êêU `
)
êê` a
;
êêa b
}
ëë 
catch
íí 
(
íí 
	Exception
íí 
ex
íí 
)
íí  
{
ìì 
await
îî 
_logService
îî !
.
îî! "
LogAsync
îî" *
(
îî* +
LogError
îî+ 3
,
îî3 4
$"
îî5 7
$str
îî7 M
{
îîM N
bookDto
îîN U
?
îîU V
.
îîV W
Title
îîW \
}
îî\ ]
"
îî] ^
,
îî^ _
ex
îî` b
)
îîb c
;
îîc d
return
ïï 

StatusCode
ïï !
(
ïï! "
$num
ïï" %
,
ïï% &
ErrInternalServer
ïï' 8
)
ïï8 9
;
ïï9 :
}
ññ 
}
óó 	
[
öö 	
HttpPut
öö	 
(
öö 
$str
öö 
)
öö 
]
öö 
[
õõ 	
	Authorize
õõ	 
(
õõ 
Roles
õõ 
=
õõ 
$str
õõ 8
)
õõ8 9
]
õõ9 :
[
úú 	 
EnableRateLimiting
úú	 
(
úú 
$str
úú )
)
úú) *
]
úú* +
public
ùù 
async
ùù 
Task
ùù 
<
ùù 
IActionResult
ùù '
>
ùù' (

UpdateBook
ùù) 3
(
ùù3 4
string
ùù4 :
id
ùù; =
,
ùù= >
[
ùù? @
FromBody
ùù@ H
]
ùùH I
UpdateBookDTO
ùùJ W
updateBookDto
ùùX e
)
ùùe f
{
ûû 	
try
üü 
{
†† 
if
°° 
(
°° 
string
°° 
.
°° 
IsNullOrEmpty
°° (
(
°°( )
id
°°) +
)
°°+ ,
)
°°, -
{
¢¢ 
await
££ 
_logService
££ %
.
££% &
LogAsync
££& .
(
££. /

LogWarning
££/ 9
,
££9 :
$str
££; _
)
££_ `
;
££` a
return
§§ 

BadRequest
§§ %
(
§§% &"
BadRequestIdRequired
§§& :
)
§§: ;
;
§§; <
}
•• 
if
ßß 
(
ßß 
!
ßß 

ModelState
ßß 
.
ßß  
IsValid
ßß  '
)
ßß' (
{
®® 
await
©© 
_logService
©© %
.
©©% &
LogAsync
©©& .
(
©©. /

LogWarning
©©/ 9
,
©©9 :
$"
©©; =
$str
©©= c
{
©©c d
id
©©d f
}
©©f g
"
©©g h
)
©©h i
;
©©i j
return
™™ 

BadRequest
™™ %
(
™™% &

ModelState
™™& 0
)
™™0 1
;
™™1 2
}
´´ 
if
≠≠ 
(
≠≠ 
string
≠≠ 
.
≠≠ 
IsNullOrEmpty
≠≠ (
(
≠≠( )
updateBookDto
≠≠) 6
.
≠≠6 7
Title
≠≠7 <
)
≠≠< =
||
≠≠> @
string
≠≠A G
.
≠≠G H
IsNullOrEmpty
≠≠H U
(
≠≠U V
updateBookDto
≠≠V c
.
≠≠c d
Author
≠≠d j
)
≠≠j k
)
≠≠k l
{
ÆÆ 
await
ØØ 
_logService
ØØ %
.
ØØ% &
LogAsync
ØØ& .
(
ØØ. /

LogWarning
ØØ/ 9
,
ØØ9 :
$str
ØØ; p
)
ØØp q
;
ØØq r
return
∞∞ 

BadRequest
∞∞ %
(
∞∞% &
$str
∞∞& E
)
∞∞E F
;
∞∞F G
}
±± 
var
≥≥ 
username
≥≥ 
=
≥≥ 
User
≥≥ #
.
≥≥# $
Identity
≥≥$ ,
?
≥≥, -
.
≥≥- .
Name
≥≥. 2
??
≥≥3 5
UnknownValue
≥≥6 B
;
≥≥B C
var
¥¥ 
role
¥¥ 
=
¥¥ 
User
¥¥ 
.
¥¥  
	FindFirst
¥¥  )
(
¥¥) *

ClaimTypes
¥¥* 4
.
¥¥4 5
Role
¥¥5 9
)
¥¥9 :
?
¥¥: ;
.
¥¥; <
Value
¥¥< A
??
¥¥B D
UnknownValue
¥¥E Q
;
¥¥Q R
await
∂∂ 
_logService
∂∂ !
.
∂∂! "
LogAsync
∂∂" *
(
∂∂* +
LogInfo
∂∂+ 2
,
∂∂2 3
$"
∂∂4 6
$str
∂∂6 >
{
∂∂> ?
username
∂∂? G
}
∂∂G H
$str
∂∂H O
{
∂∂O P
role
∂∂P T
}
∂∂T U
$str
∂∂U j
{
∂∂j k
id
∂∂k m
}
∂∂m n
"
∂∂n o
)
∂∂o p
;
∂∂p q
var
∏∏ 
updated
∏∏ 
=
∏∏ 
await
∏∏ #
_bookService
∏∏$ 0
.
∏∏0 1
UpdateBookAsync
∏∏1 @
(
∏∏@ A
id
∏∏A C
,
∏∏C D
updateBookDto
∏∏E R
,
∏∏R S
username
∏∏T \
)
∏∏\ ]
;
∏∏] ^
if
∫∫ 
(
∫∫ 
!
∫∫ 
updated
∫∫ 
)
∫∫ 
{
ªª 
await
ºº 
_logService
ºº %
.
ºº% &
LogAsync
ºº& .
(
ºº. /

LogWarning
ºº/ 9
,
ºº9 :
$"
ºº; =
$str
ºº= b
{
ººb c
id
ººc e
}
ººe f
"
ººf g
)
ººg h
;
ººh i
return
ΩΩ 
NotFound
ΩΩ #
(
ΩΩ# $
BookNotFound
ΩΩ$ 0
)
ΩΩ0 1
;
ΩΩ1 2
}
ææ 
await
¿¿ 
_logService
¿¿ !
.
¿¿! "
LogAsync
¿¿" *
(
¿¿* +
LogInfo
¿¿+ 2
,
¿¿2 3
$"
¿¿4 6
$str
¿¿6 I
{
¿¿I J
id
¿¿J L
}
¿¿L M
$str
¿¿M R
{
¿¿R S
username
¿¿S [
}
¿¿[ \
$str
¿¿\ c
{
¿¿c d
role
¿¿d h
}
¿¿h i
$str
¿¿i j
"
¿¿j k
)
¿¿k l
;
¿¿l m
return
¡¡ 
	NoContent
¡¡  
(
¡¡  !
)
¡¡! "
;
¡¡" #
}
¬¬ 
catch
√√ 
(
√√ 
	Exception
√√ 
ex
√√ 
)
√√  
{
ƒƒ 
await
≈≈ 
_logService
≈≈ !
.
≈≈! "
LogAsync
≈≈" *
(
≈≈* +
LogError
≈≈+ 3
,
≈≈3 4
$"
≈≈5 7
$str
≈≈7 Q
{
≈≈Q R
id
≈≈R T
}
≈≈T U
"
≈≈U V
,
≈≈V W
ex
≈≈X Z
)
≈≈Z [
;
≈≈[ \
return
∆∆ 

StatusCode
∆∆ !
(
∆∆! "
$num
∆∆" %
,
∆∆% &
ErrInternalServer
∆∆' 8
)
∆∆8 9
;
∆∆9 :
}
«« 
}
»» 	
[
ÀÀ 	

HttpDelete
ÀÀ	 
(
ÀÀ 
$str
ÀÀ 
)
ÀÀ 
]
ÀÀ 
[
ÃÃ 	
	Authorize
ÃÃ	 
(
ÃÃ 
Roles
ÃÃ 
=
ÃÃ 
$str
ÃÃ *
)
ÃÃ* +
]
ÃÃ+ ,
[
ÕÕ 	 
EnableRateLimiting
ÕÕ	 
(
ÕÕ 
$str
ÕÕ )
)
ÕÕ) *
]
ÕÕ* +
public
ŒŒ 
async
ŒŒ 
Task
ŒŒ 
<
ŒŒ 
IActionResult
ŒŒ '
>
ŒŒ' (

DeleteBook
ŒŒ) 3
(
ŒŒ3 4
string
ŒŒ4 :
id
ŒŒ; =
)
ŒŒ= >
{
œœ 	
try
–– 
{
—— 
if
““ 
(
““ 
string
““ 
.
““ 
IsNullOrEmpty
““ (
(
““( )
id
““) +
)
““+ ,
)
““, -
{
”” 
await
‘‘ 
_logService
‘‘ %
.
‘‘% &
LogAsync
‘‘& .
(
‘‘. /

LogWarning
‘‘/ 9
,
‘‘9 :
$str
‘‘; ]
)
‘‘] ^
;
‘‘^ _
return
’’ 

BadRequest
’’ %
(
’’% &"
BadRequestIdRequired
’’& :
)
’’: ;
;
’’; <
}
÷÷ 
var
ÿÿ 
username
ÿÿ 
=
ÿÿ 
User
ÿÿ #
.
ÿÿ# $
Identity
ÿÿ$ ,
?
ÿÿ, -
.
ÿÿ- .
Name
ÿÿ. 2
??
ÿÿ3 5
UnknownValue
ÿÿ6 B
;
ÿÿB C
var
ŸŸ 
role
ŸŸ 
=
ŸŸ 
User
ŸŸ 
.
ŸŸ  
	FindFirst
ŸŸ  )
(
ŸŸ) *

ClaimTypes
ŸŸ* 4
.
ŸŸ4 5
Role
ŸŸ5 9
)
ŸŸ9 :
?
ŸŸ: ;
.
ŸŸ; <
Value
ŸŸ< A
??
ŸŸB D
UnknownValue
ŸŸE Q
;
ŸŸQ R
await
€€ 
_logService
€€ !
.
€€! "
LogAsync
€€" *
(
€€* +
LogInfo
€€+ 2
,
€€2 3
$"
€€4 6
$str
€€6 >
{
€€> ?
username
€€? G
}
€€G H
$str
€€H O
{
€€O P
role
€€P T
}
€€T U
$str
€€U h
{
€€h i
id
€€i k
}
€€k l
"
€€l m
)
€€m n
;
€€n o
var
›› 
deleted
›› 
=
›› 
await
›› #
_bookService
››$ 0
.
››0 1
DeleteBookAsync
››1 @
(
››@ A
id
››A C
,
››C D
username
››E M
)
››M N
;
››N O
if
ﬂﬂ 
(
ﬂﬂ 
!
ﬂﬂ 
deleted
ﬂﬂ 
)
ﬂﬂ 
{
‡‡ 
await
·· 
_logService
·· %
.
··% &
LogAsync
··& .
(
··. /

LogWarning
··/ 9
,
··9 :
$"
··; =
$str
··= `
{
··` a
id
··a c
}
··c d
"
··d e
)
··e f
;
··f g
return
‚‚ 
NotFound
‚‚ #
(
‚‚# $
BookNotFound
‚‚$ 0
)
‚‚0 1
;
‚‚1 2
}
„„ 
await
ÂÂ 
_logService
ÂÂ !
.
ÂÂ! "
LogAsync
ÂÂ" *
(
ÂÂ* +
LogInfo
ÂÂ+ 2
,
ÂÂ2 3
$"
ÂÂ4 6
$str
ÂÂ6 G
{
ÂÂG H
id
ÂÂH J
}
ÂÂJ K
$str
ÂÂK P
{
ÂÂP Q
username
ÂÂQ Y
}
ÂÂY Z
$str
ÂÂZ a
{
ÂÂa b
role
ÂÂb f
}
ÂÂf g
$str
ÂÂg h
"
ÂÂh i
)
ÂÂi j
;
ÂÂj k
return
ÊÊ 
	NoContent
ÊÊ  
(
ÊÊ  !
)
ÊÊ! "
;
ÊÊ" #
}
ÁÁ 
catch
ËË 
(
ËË 
	Exception
ËË 
ex
ËË 
)
ËË  
{
ÈÈ 
await
ÍÍ 
_logService
ÍÍ !
.
ÍÍ! "
LogAsync
ÍÍ" *
(
ÍÍ* +
LogError
ÍÍ+ 3
,
ÍÍ3 4
$"
ÍÍ5 7
$str
ÍÍ7 O
{
ÍÍO P
id
ÍÍP R
}
ÍÍR S
"
ÍÍS T
,
ÍÍT U
ex
ÍÍV X
)
ÍÍX Y
;
ÍÍY Z
return
ÎÎ 

StatusCode
ÎÎ !
(
ÎÎ! "
$num
ÎÎ" %
,
ÎÎ% &
ErrInternalServer
ÎÎ' 8
)
ÎÎ8 9
;
ÎÎ9 :
}
ÏÏ 
}
ÌÌ 	
[
 	
HttpGet
	 
(
 
$str
 $
)
$ %
]
% &
[
ÒÒ 	
	Authorize
ÒÒ	 
]
ÒÒ 
[
ÚÚ 	 
EnableRateLimiting
ÚÚ	 
(
ÚÚ 
$str
ÚÚ )
)
ÚÚ) *
]
ÚÚ* +
public
ÛÛ 
async
ÛÛ 
Task
ÛÛ 
<
ÛÛ 
ActionResult
ÛÛ &
<
ÛÛ& '
object
ÛÛ' -
>
ÛÛ- .
>
ÛÛ. /
CheckAvailability
ÛÛ0 A
(
ÛÛA B
string
ÛÛB H
id
ÛÛI K
)
ÛÛK L
{
ÙÙ 	
try
ıı 
{
ˆˆ 
if
˜˜ 
(
˜˜ 
string
˜˜ 
.
˜˜ 
IsNullOrEmpty
˜˜ (
(
˜˜( )
id
˜˜) +
)
˜˜+ ,
)
˜˜, -
{
¯¯ 
return
˘˘ 

BadRequest
˘˘ %
(
˘˘% &"
BadRequestIdRequired
˘˘& :
)
˘˘: ;
;
˘˘; <
}
˙˙ 
var
¸¸ 
username
¸¸ 
=
¸¸ 
User
¸¸ #
.
¸¸# $
Identity
¸¸$ ,
?
¸¸, -
.
¸¸- .
Name
¸¸. 2
??
¸¸3 5
UnknownValue
¸¸6 B
;
¸¸B C
var
˝˝ 
role
˝˝ 
=
˝˝ 
User
˝˝ 
.
˝˝  
	FindFirst
˝˝  )
(
˝˝) *

ClaimTypes
˝˝* 4
.
˝˝4 5
Role
˝˝5 9
)
˝˝9 :
?
˝˝: ;
.
˝˝; <
Value
˝˝< A
??
˝˝B D
UnknownValue
˝˝E Q
;
˝˝Q R
await
˛˛ 
_logService
˛˛ !
.
˛˛! "
LogAsync
˛˛" *
(
˛˛* +
LogInfo
˛˛+ 2
,
˛˛2 3
$"
˛˛4 6
$str
˛˛6 >
{
˛˛> ?
username
˛˛? G
}
˛˛G H
$str
˛˛H O
{
˛˛O P
role
˛˛P T
}
˛˛T U
$str
˛˛U |
{
˛˛| }
id
˛˛} 
}˛˛ Ä
"˛˛Ä Å
)˛˛Å Ç
;˛˛Ç É
var
ÄÄ 
book
ÄÄ 
=
ÄÄ 
await
ÄÄ  
_bookService
ÄÄ! -
.
ÄÄ- .
GetBookByIdAsync
ÄÄ. >
(
ÄÄ> ?
id
ÄÄ? A
)
ÄÄA B
;
ÄÄB C
if
ÅÅ 
(
ÅÅ 
book
ÅÅ 
==
ÅÅ 
null
ÅÅ  
)
ÅÅ  !
{
ÇÇ 
return
ÉÉ 
NotFound
ÉÉ #
(
ÉÉ# $
BookNotFound
ÉÉ$ 0
)
ÉÉ0 1
;
ÉÉ1 2
}
ÑÑ 
var
ÜÜ 
result
ÜÜ 
=
ÜÜ 
new
ÜÜ  
{
áá 
BookId
àà 
=
àà 
book
àà !
.
àà! "
Id
àà" $
,
àà$ %
Title
ââ 
=
ââ 
book
ââ  
.
ââ  !
Title
ââ! &
,
ââ& '
IsAvailable
ää 
=
ää  !
book
ää" &
.
ää& '
AvailableCopies
ää' 6
>
ää7 8
$num
ää9 :
,
ää: ;
AvailableCopies
ãã #
=
ãã$ %
book
ãã& *
.
ãã* +
AvailableCopies
ãã+ :
,
ãã: ;
TotalCopies
åå 
=
åå  !
book
åå" &
.
åå& '
TotalCopies
åå' 2
}
çç 
;
çç 
return
èè 
Ok
èè 
(
èè 
result
èè  
)
èè  !
;
èè! "
}
êê 
catch
ëë 
(
ëë 
	Exception
ëë 
ex
ëë 
)
ëë  
{
íí 
await
ìì 
_logService
ìì !
.
ìì! "
LogAsync
ìì" *
(
ìì* +
LogError
ìì+ 3
,
ìì3 4
$"
ìì5 7
$str
ìì7 c
{
ììc d
id
ììd f
}
ììf g
"
ììg h
,
ììh i
ex
ììj l
)
ììl m
;
ììm n
return
îî 

StatusCode
îî !
(
îî! "
$num
îî" %
,
îî% &
ErrInternalServer
îî' 8
)
îî8 9
;
îî9 :
}
ïï 
}
ññ 	
}
óó 
}òò ™
TC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Controllers\UserController.cs
	namespace 	

LibraryApp
 
. 
Controllers  
{		 
[

 
ApiController

 
]

 
[ 
Route 

(
 
$str 
) 
] 
[ 
	Authorize 
( 
Roles 
= 
$str 4
)4 5
]5 6
[ 
EnableRateLimiting 
( 
$str $
)$ %
]% &
public 

class 
UsersController  
:! "
ControllerBase# 1
{ 
private 
readonly 
UserService $
_userService% 1
;1 2
public 
UsersController 
( 
UserService *
userService+ 6
)6 7
{ 	
_userService 
= 
userService &
;& '
} 	
[ 	
HttpGet	 
] 
public 
async 
Task 
< 
ActionResult &
<& '
IEnumerable' 2
<2 3
UserLookupDto3 @
>@ A
>A B
>B C
GetAllD J
(J K
)K L
{ 	
var 
users 
= 
await 
_userService *
.* +
GetAllUsersAsync+ ;
(; <
)< =
;= >
var 
dto 
= 
users 
. 
Select "
(" #
u# $
=>% '
new( +
UserLookupDto, 9
{ 
Id 
= 
u 
. 
Id 
, 
Username 
= 
u 
. 
Username %
}   
)   
;   
return!! 
Ok!! 
(!! 
dto!! 
)!! 
;!! 
}"" 	
}## 
public%% 

class%% 
UserLookupDto%% 
{&& 
public'' 
string'' 
Id'' 
{'' 
get'' 
;'' 
set''  #
;''# $
}''% &
=''' (
string'') /
.''/ 0
Empty''0 5
;''5 6
public(( 
string(( 
Username(( 
{((  
get((! $
;(($ %
set((& )
;(() *
}((+ ,
=((- .
string((/ 5
.((5 6
Empty((6 ;
;((; <
})) 
}** ã•
TC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Controllers\LoanController.cs
	namespace 	

LibraryApp
 
. 
Controllers  
{ 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
[ 
	Authorize 
] 
public 

class 
LoansController  
:! "
ControllerBase# 1
{ 
private 
readonly 
LoanService $
_loanService% 1
;1 2
private 
readonly 

Logservice #
_logService$ /
;/ 0
private 
const 
string 
LogError %
=& '
$str( /
;/ 0
private 
const 
string 

LogWarning '
=( )
$str* 3
;3 4
private 
const 
string 
LogInfo $
=% &
$str' 4
;4 5
private 
const 
string 
ErrInternalServer .
=/ 0
$str1 M
;M N
private 
const 
string 
UnknownValue )
=* +
$str, 5
;5 6
private 
const 
string 
LoanNotFound )
=* +
$str, D
;D E
private 
const 
string  
BadRequestIdRequired 1
=2 3
$str4 O
;O P
public 
LoansController 
( 
LoanService *
loanService+ 6
,6 7

Logservice8 B

logServiceC M
)M N
{ 	
_loanService   
=   
loanService   &
;  & '
_logService!! 
=!! 

logService!! $
;!!$ %
}"" 	
[&& 	

HttpDelete&&	 
(&& 
$str&& 
)&& 
]&& 
['' 	
	Authorize''	 
('' 
Roles'' 
='' 
$str'' *
)''* +
]''+ ,
[(( 	
EnableRateLimiting((	 
((( 
$str(( )
)(() *
]((* +
public)) 
async)) 
Task)) 
<)) 
IActionResult)) '
>))' (

DeleteLoan))) 3
())3 4
string))4 :
id)); =
)))= >
{** 	
if++ 
(++ 
string++ 
.++ 
IsNullOrWhiteSpace++ )
(++) *
id++* ,
)++, -
)++- .
{,, 
await-- 
_logService-- !
.--! "
LogAsync--" *
(--* +

LogWarning--+ 5
,--5 6
$str--7 _
)--_ `
;--` a
return.. 

BadRequest.. !
(..! " 
BadRequestIdRequired.." 6
)..6 7
;..7 8
}// 
try11 
{22 
var33 
username33 
=33 
User33 #
.33# $
Identity33$ ,
?33, -
.33- .
Name33. 2
??333 5
UnknownValue336 B
;33B C
var44 
role44 
=44 
User44 
.44  
	FindFirst44  )
(44) *
System44* 0
.440 1
Security441 9
.449 :
Claims44: @
.44@ A

ClaimTypes44A K
.44K L
Role44L P
)44P Q
?44Q R
.44R S
Value44S X
??44Y [
UnknownValue44\ h
;44h i
await55 
_logService55 !
.55! "
LogAsync55" *
(55* +
LogInfo55+ 2
,552 3
$"66 
$str66 
{66 
username66 '
}66' (
$str66( /
{66/ 0
role660 4
}664 5
$str665 R
{66R S
id66S U
}66U V
"66V W
)66W X
;66X Y
var88 
ok88 
=88 
await88 
_loanService88 +
.88+ ,
DeleteLoanAsync88, ;
(88; <
id88< >
)88> ?
;88? @
if:: 
(:: 
!:: 
ok:: 
):: 
{;; 
await<< 
_logService<< %
.<<% &
LogAsync<<& .
(<<. /

LogWarning<</ 9
,<<9 :
$"<<; =
$str<<= ]
{<<] ^
id<<^ `
}<<` a
$str<<a u
"<<u v
)<<v w
;<<w x
return== 
NotFound== #
(==# $
LoanNotFound==$ 0
)==0 1
;==1 2
}>> 
await@@ 
_logService@@ !
.@@! "
LogAsync@@" *
(@@* +

LogWarning@@+ 5
,@@5 6
$"@@7 9
$str@@9 B
{@@B C
id@@C E
}@@E F
$str@@F ^
"@@^ _
)@@_ `
;@@` a
returnAA 
	NoContentAA  
(AA  !
)AA! "
;AA" #
}BB 
catchCC 
(CC 
	ExceptionCC 
exCC 
)CC  
{DD 
awaitEE 
_logServiceEE !
.EE! "
LogAsyncEE" *
(EE* +
LogErrorEE+ 3
,EE3 4
$"EE5 7
$strEE7 R
{EER S
idEES U
}EEU V
"EEV W
,EEW X
exEEY [
)EE[ \
;EE\ ]
returnFF 

StatusCodeFF !
(FF! "
$numFF" %
,FF% &
ErrInternalServerFF' 8
)FF8 9
;FF9 :
}GG 
}HH 	
[KK 	
HttpPutKK	 
(KK 
$strKK 
)KK 
]KK 
[LL 	
	AuthorizeLL	 
(LL 
RolesLL 
=LL 
$strLL *
)LL* +
]LL+ ,
[MM 	
EnableRateLimitingMM	 
(MM 
$strMM )
)MM) *
]MM* +
publicNN 
asyncNN 
TaskNN 
<NN 
IActionResultNN '
>NN' (

UpdateLoanNN) 3
(NN3 4
stringNN4 :
idNN; =
,NN= >
[NN? @
FromBodyNN@ H
]NNH I
UpdateLoanDTONNJ W
dtoNNX [
)NN[ \
{OO 	
ifPP 
(PP 
stringPP 
.PP 
IsNullOrWhiteSpacePP )
(PP) *
idPP* ,
)PP, -
)PP- .
{QQ 
awaitRR 
_logServiceRR !
.RR! "
LogAsyncRR" *
(RR* +

LogWarningRR+ 5
,RR5 6
$strRR7 a
)RRa b
;RRb c
returnSS 

BadRequestSS !
(SS! " 
BadRequestIdRequiredSS" 6
)SS6 7
;SS7 8
}TT 
ifVV 
(VV 
!VV 

ModelStateVV 
.VV 
IsValidVV #
)VV# $
{WW 
awaitXX 
_logServiceXX !
.XX! "
LogAsyncXX" *
(XX* +

LogWarningXX+ 5
,XX5 6
$"XX7 9
$strXX9 b
{XXb c
idXXc e
}XXe f
"XXf g
)XXg h
;XXh i
returnYY 

BadRequestYY !
(YY! "

ModelStateYY" ,
)YY, -
;YY- .
}ZZ 
try\\ 
{]] 
var^^ 
username^^ 
=^^ 
User^^ #
.^^# $
Identity^^$ ,
?^^, -
.^^- .
Name^^. 2
??^^3 5
UnknownValue^^6 B
;^^B C
var__ 
role__ 
=__ 
User__ 
.__  
	FindFirst__  )
(__) *

ClaimTypes__* 4
.__4 5
Role__5 9
)__9 :
?__: ;
.__; <
Value__< A
??__B D
UnknownValue__E Q
;__Q R
await`` 
_logService`` !
.``! "
LogAsync``" *
(``* +
LogInfo``+ 2
,``2 3
$"aa 
$straa 
{aa 
usernameaa '
}aa' (
$straa( /
{aa/ 0
roleaa0 4
}aa4 5
$straa5 M
{aaM N
idaaN P
}aaP Q
"aaQ R
)aaR S
;aaS T
varcc 
okcc 
=cc 
awaitcc 
_loanServicecc +
.cc+ ,
UpdateLoanAsynccc, ;
(cc; <
idcc< >
,cc> ?
dtocc@ C
,ccC D
$"ccE G
{ccG H
usernameccH P
}ccP Q
$strccQ S
{ccS T
roleccT X
}ccX Y
$strccY Z
"ccZ [
)cc[ \
;cc\ ]
ifdd 
(dd 
!dd 
okdd 
)dd 
{ee 
awaitff 
_logServiceff %
.ff% &
LogAsyncff& .
(ff. /

LogWarningff/ 9
,ff9 :
$"ff; =
$strff= _
{ff_ `
idff` b
}ffb c
"ffc d
)ffd e
;ffe f
returngg 
NotFoundgg #
(gg# $
LoanNotFoundgg$ 0
)gg0 1
;gg1 2
}hh 
awaitjj 
_logServicejj !
.jj! "
LogAsyncjj" *
(jj* +
LogInfojj+ 2
,jj2 3
$"jj4 6
$strjj6 ?
{jj? @
idjj@ B
}jjB C
$strjjC ]
"jj] ^
)jj^ _
;jj_ `
returnkk 
	NoContentkk  
(kk  !
)kk! "
;kk" #
}ll 
catchmm 
(mm 
	Exceptionmm 
exmm 
)mm  
{nn 
awaitoo 
_logServiceoo !
.oo! "
LogAsyncoo" *
(oo* +
LogErroroo+ 3
,oo3 4
$"oo5 7
$stroo7 T
{ooT U
idooU W
}ooW X
"ooX Y
,ooY Z
exoo[ ]
)oo] ^
;oo^ _
returnpp 

StatusCodepp !
(pp! "
$numpp" %
,pp% &
ErrInternalServerpp' 8
)pp8 9
;pp9 :
}qq 
}rr 	
[tt 	
HttpGettt	 
]tt 
[uu 	
	Authorizeuu	 
(uu 
Rolesuu 
=uu 
$struu 8
)uu8 9
]uu9 :
[vv 	
EnableRateLimitingvv	 
(vv 
$strvv (
)vv( )
]vv) *
publicww 
asyncww 
Taskww 
<ww 
ActionResultww &
<ww& '
IEnumerableww' 2
<ww2 3
LoanResponseDTOww3 B
>wwB C
>wwC D
>wwD E
GetAllLoanswwF Q
(wwQ R
)wwR S
{xx 	
tryyy 
{zz 
var{{ 
username{{ 
={{ 
User{{ #
.{{# $
Identity{{$ ,
?{{, -
.{{- .
Name{{. 2
??{{3 5
UnknownValue{{6 B
;{{B C
var|| 
role|| 
=|| 
User|| 
.||  
	FindFirst||  )
(||) *

ClaimTypes||* 4
.||4 5
Role||5 9
)||9 :
?||: ;
.||; <
Value||< A
??||B D
UnknownValue||E Q
;||Q R
await}} 
_logService}} !
.}}! "
LogAsync}}" *
(}}* +
LogInfo}}+ 2
,}}2 3
$"}}4 6
$str}}6 >
{}}> ?
username}}? G
}}}G H
$str}}H O
{}}O P
role}}P T
}}}T U
$str}}U v
"}}v w
)}}w x
;}}x y
var 
loans 
= 
await !
_loanService" .
.. /
GetAllLoansAsync/ ?
(? @
)@ A
;A B
return
ÄÄ 
Ok
ÄÄ 
(
ÄÄ 
loans
ÄÄ 
)
ÄÄ  
;
ÄÄ  !
}
ÅÅ 
catch
ÇÇ 
(
ÇÇ 
	Exception
ÇÇ 
ex
ÇÇ 
)
ÇÇ  
{
ÉÉ 
await
ÑÑ 
_logService
ÑÑ !
.
ÑÑ! "
LogAsync
ÑÑ" *
(
ÑÑ* +
LogError
ÑÑ+ 3
,
ÑÑ3 4
$str
ÑÑ5 Q
,
ÑÑQ R
ex
ÑÑS U
)
ÑÑU V
;
ÑÑV W
return
ÖÖ 

StatusCode
ÖÖ !
(
ÖÖ! "
$num
ÖÖ" %
,
ÖÖ% &
ErrInternalServer
ÖÖ' 8
)
ÖÖ8 9
;
ÖÖ9 :
}
ÜÜ 
}
áá 	
[
ää 	
HttpGet
ää	 
(
ää 
$str
ää 
)
ää 
]
ää 
[
ãã 	
	Authorize
ãã	 
]
ãã 
[
åå 	 
EnableRateLimiting
åå	 
(
åå 
$str
åå (
)
åå( )
]
åå) *
public
çç 
async
çç 
Task
çç 
<
çç 
ActionResult
çç &
<
çç& '
IEnumerable
çç' 2
<
çç2 3
LoanResponseDTO
çç3 B
>
ççB C
>
ççC D
>
ççD E

GetMyLoans
ççF P
(
ççP Q
)
ççQ R
{
éé 	
try
èè 
{
êê 
var
ëë 
username
ëë 
=
ëë 
User
ëë #
.
ëë# $
Identity
ëë$ ,
?
ëë, -
.
ëë- .
Name
ëë. 2
??
ëë3 5
UnknownValue
ëë6 B
;
ëëB C
var
íí 
role
íí 
=
íí 
User
íí 
.
íí  
	FindFirst
íí  )
(
íí) *

ClaimTypes
íí* 4
.
íí4 5
Role
íí5 9
)
íí9 :
?
íí: ;
.
íí; <
Value
íí< A
??
ííB D
UnknownValue
ííE Q
;
ííQ R
await
ìì 
_logService
ìì !
.
ìì! "
LogAsync
ìì" *
(
ìì* +
LogInfo
ìì+ 2
,
ìì2 3
$"
ìì4 6
$str
ìì6 >
{
ìì> ?
username
ìì? G
}
ììG H
$str
ììH O
{
ììO P
role
ììP T
}
ììT U
$str
ììU p
"
ììp q
)
ììq r
;
ììr s
var
ïï 
loans
ïï 
=
ïï 
await
ïï !
_loanService
ïï" .
.
ïï. /!
GetLoansByUserAsync
ïï/ B
(
ïïB C
username
ïïC K
)
ïïK L
;
ïïL M
return
ññ 
Ok
ññ 
(
ññ 
loans
ññ 
)
ññ  
;
ññ  !
}
óó 
catch
òò 
(
òò 
	Exception
òò 
ex
òò 
)
òò  
{
ôô 
await
öö 
_logService
öö !
.
öö! "
LogAsync
öö" *
(
öö* +
LogError
öö+ 3
,
öö3 4
$"
öö5 7
$str
öö7 ^
{
öö^ _
User
öö_ c
.
ööc d
Identity
ööd l
?
ööl m
.
ööm n
Name
öön r
}
öör s
"
öös t
,
ööt u
ex
ööv x
)
ööx y
;
ööy z
return
õõ 

StatusCode
õõ !
(
õõ! "
$num
õõ" %
,
õõ% &
ErrInternalServer
õõ' 8
)
õõ8 9
;
õõ9 :
}
úú 
}
ùù 	
[
†† 	
HttpGet
††	 
(
†† 
$str
†† "
)
††" #
]
††# $
[
°° 	
	Authorize
°°	 
]
°° 
[
¢¢ 	 
EnableRateLimiting
¢¢	 
(
¢¢ 
$str
¢¢ (
)
¢¢( )
]
¢¢) *
public
££ 
async
££ 
Task
££ 
<
££ 
ActionResult
££ &
<
££& '
IEnumerable
££' 2
<
££2 3
LoanResponseDTO
££3 B
>
££B C
>
££C D
>
££D E
GetMyActiveLoans
££F V
(
££V W
)
££W X
{
§§ 	
try
•• 
{
¶¶ 
var
ßß 
username
ßß 
=
ßß 
User
ßß #
.
ßß# $
Identity
ßß$ ,
?
ßß, -
.
ßß- .
Name
ßß. 2
??
ßß3 5
UnknownValue
ßß6 B
;
ßßB C
var
®® 
role
®® 
=
®® 
User
®® 
.
®®  
	FindFirst
®®  )
(
®®) *

ClaimTypes
®®* 4
.
®®4 5
Role
®®5 9
)
®®9 :
?
®®: ;
.
®®; <
Value
®®< A
??
®®B D
UnknownValue
®®E Q
;
®®Q R
await
©© 
_logService
©© !
.
©©! "
LogAsync
©©" *
(
©©* +
LogInfo
©©+ 2
,
©©2 3
$"
©©4 6
$str
©©6 >
{
©©> ?
username
©©? G
}
©©G H
$str
©©H O
{
©©O P
role
©©P T
}
©©T U
$str
©©U x
"
©©x y
)
©©y z
;
©©z {
var
´´ 
loans
´´ 
=
´´ 
await
´´ !
_loanService
´´" .
.
´´. /'
GetActiveLoansByUserAsync
´´/ H
(
´´H I
username
´´I Q
)
´´Q R
;
´´R S
return
¨¨ 
Ok
¨¨ 
(
¨¨ 
loans
¨¨ 
)
¨¨  
;
¨¨  !
}
≠≠ 
catch
ÆÆ 
(
ÆÆ 
	Exception
ÆÆ 
ex
ÆÆ 
)
ÆÆ  
{
ØØ 
await
∞∞ 
_logService
∞∞ !
.
∞∞! "
LogAsync
∞∞" *
(
∞∞* +
LogError
∞∞+ 3
,
∞∞3 4
$"
∞∞5 7
$str
∞∞7 f
{
∞∞f g
User
∞∞g k
.
∞∞k l
Identity
∞∞l t
?
∞∞t u
.
∞∞u v
Name
∞∞v z
}
∞∞z {
"
∞∞{ |
,
∞∞| }
ex∞∞~ Ä
)∞∞Ä Å
;∞∞Å Ç
return
±± 

StatusCode
±± !
(
±±! "
$num
±±" %
,
±±% &
ErrInternalServer
±±' 8
)
±±8 9
;
±±9 :
}
≤≤ 
}
≥≥ 	
[
∏∏ 	
HttpGet
∏∏	 
(
∏∏ 
$str
∏∏ 
)
∏∏ 
]
∏∏ 
[
ππ 	
	Authorize
ππ	 
(
ππ 
Roles
ππ 
=
ππ 
$str
ππ 8
)
ππ8 9
]
ππ9 :
[
∫∫ 	 
EnableRateLimiting
∫∫	 
(
∫∫ 
$str
∫∫ (
)
∫∫( )
]
∫∫) *
public
ªª 
async
ªª 
Task
ªª 
<
ªª 
ActionResult
ªª &
<
ªª& '
IEnumerable
ªª' 2
<
ªª2 3
LoanResponseDTO
ªª3 B
>
ªªB C
>
ªªC D
>
ªªD E
GetOverdueLoans
ªªF U
(
ªªU V
)
ªªV W
{
ºº 	
try
ΩΩ 
{
ææ 
var
øø 
username
øø 
=
øø 
User
øø #
.
øø# $
Identity
øø$ ,
?
øø, -
.
øø- .
Name
øø. 2
??
øø3 5
UnknownValue
øø6 B
;
øøB C
var
¿¿ 
role
¿¿ 
=
¿¿ 
User
¿¿ 
.
¿¿  
	FindFirst
¿¿  )
(
¿¿) *

ClaimTypes
¿¿* 4
.
¿¿4 5
Role
¿¿5 9
)
¿¿9 :
?
¿¿: ;
.
¿¿; <
Value
¿¿< A
??
¿¿B D
UnknownValue
¿¿E Q
;
¿¿Q R
await
¡¡ 
_logService
¡¡ !
.
¡¡! "
LogAsync
¡¡" *
(
¡¡* +
LogInfo
¡¡+ 2
,
¡¡2 3
$"
¡¡4 6
$str
¡¡6 >
{
¡¡> ?
username
¡¡? G
}
¡¡G H
$str
¡¡H O
{
¡¡O P
role
¡¡P T
}
¡¡T U
$str
¡¡U u
"
¡¡u v
)
¡¡v w
;
¡¡w x
var
√√ 
loans
√√ 
=
√√ 
await
√√ !
_loanService
√√" .
.
√√. /"
GetOverdueLoansAsync
√√/ C
(
√√C D
)
√√D E
;
√√E F
return
ƒƒ 
Ok
ƒƒ 
(
ƒƒ 
loans
ƒƒ 
)
ƒƒ  
;
ƒƒ  !
}
≈≈ 
catch
∆∆ 
(
∆∆ 
	Exception
∆∆ 
ex
∆∆ 
)
∆∆  
{
«« 
await
»» 
_logService
»» !
.
»»! "
LogAsync
»»" *
(
»»* +
LogError
»»+ 3
,
»»3 4
$str
»»5 Z
,
»»Z [
ex
»»\ ^
)
»»^ _
;
»»_ `
return
…… 

StatusCode
…… !
(
……! "
$num
……" %
,
……% &
ErrInternalServer
……' 8
)
……8 9
;
……9 :
}
   
}
ÀÀ 	
[
ŒŒ 	
HttpPost
ŒŒ	 
]
ŒŒ 
[
œœ 	
	Authorize
œœ	 
(
œœ 
Roles
œœ 
=
œœ 
$str
œœ 8
)
œœ8 9
]
œœ9 :
[
–– 	 
EnableRateLimiting
––	 
(
–– 
$str
–– )
)
––) *
]
––* +
public
—— 
async
—— 
Task
—— 
<
—— 
ActionResult
—— &
<
——& '
LoanResponseDTO
——' 6
>
——6 7
>
——7 8

CreateLoan
——9 C
(
——C D
[
——D E
FromBody
——E M
]
——M N
LoanRequestDTO
——O ]
loanRequest
——^ i
)
——i j
{
““ 	
try
”” 
{
‘‘ 
if
’’ 
(
’’ 
!
’’ 

ModelState
’’ 
.
’’  
IsValid
’’  '
)
’’' (
{
÷÷ 
await
◊◊ 
_logService
◊◊ %
.
◊◊% &
LogAsync
◊◊& .
(
◊◊. /

LogWarning
◊◊/ 9
,
◊◊9 :
$str
◊◊; `
)
◊◊` a
;
◊◊a b
return
ÿÿ 

BadRequest
ÿÿ %
(
ÿÿ% &

ModelState
ÿÿ& 0
)
ÿÿ0 1
;
ÿÿ1 2
}
ŸŸ 
if
€€ 
(
€€ 
string
€€ 
.
€€ 
IsNullOrEmpty
€€ (
(
€€( )
loanRequest
€€) 4
.
€€4 5
BookId
€€5 ;
)
€€; <
)
€€< =
{
‹‹ 
await
›› 
_logService
›› %
.
››% &
LogAsync
››& .
(
››. /

LogWarning
››/ 9
,
››9 :
$str
››; j
)
››j k
;
››k l
return
ﬁﬁ 

BadRequest
ﬁﬁ %
(
ﬁﬁ% &
$str
ﬁﬁ& A
)
ﬁﬁA B
;
ﬁﬁB C
}
ﬂﬂ 
var
·· 
username
·· 
=
·· 
User
·· #
.
··# $
Identity
··$ ,
?
··, -
.
··- .
Name
··. 2
??
··3 5
UnknownValue
··6 B
;
··B C
var
‚‚ 
role
‚‚ 
=
‚‚ 
User
‚‚ 
.
‚‚  
	FindFirst
‚‚  )
(
‚‚) *

ClaimTypes
‚‚* 4
.
‚‚4 5
Role
‚‚5 9
)
‚‚9 :
?
‚‚: ;
.
‚‚; <
Value
‚‚< A
??
‚‚B D
UnknownValue
‚‚E Q
;
‚‚Q R
var
„„ 
processedBy
„„ 
=
„„  !
$"
„„" $
{
„„$ %
username
„„% -
}
„„- .
$str
„„. 0
{
„„0 1
role
„„1 5
}
„„5 6
$str
„„6 7
"
„„7 8
;
„„8 9
var
ÊÊ 
loanForUser
ÊÊ 
=
ÊÊ  !
!
ÊÊ" #
string
ÊÊ# )
.
ÊÊ) *
IsNullOrEmpty
ÊÊ* 7
(
ÊÊ7 8
loanRequest
ÊÊ8 C
.
ÊÊC D
Username
ÊÊD L
)
ÊÊL M
?
ÊÊN O
loanRequest
ÊÊP [
.
ÊÊ[ \
Username
ÊÊ\ d
:
ÊÊe f
username
ÊÊg o
;
ÊÊo p
await
ËË 
_logService
ËË !
.
ËË! "
LogAsync
ËË" *
(
ËË* +
LogInfo
ËË+ 2
,
ËË2 3
$"
ÈÈ 
$str
ÈÈ 
{
ÈÈ 
username
ÈÈ '
}
ÈÈ' (
$str
ÈÈ( /
{
ÈÈ/ 0
role
ÈÈ0 4
}
ÈÈ4 5
$str
ÈÈ5 R
{
ÈÈR S
loanRequest
ÈÈS ^
.
ÈÈ^ _
BookId
ÈÈ_ e
}
ÈÈe f
$str
ÈÈf t
{
ÈÈt u
loanForUserÈÈu Ä
}ÈÈÄ Å
"ÈÈÅ Ç
)ÈÈÇ É
;ÈÈÉ Ñ
var
ÎÎ 
loan
ÎÎ 
=
ÎÎ 
await
ÎÎ  
_loanService
ÎÎ! -
.
ÎÎ- .
CreateLoanAsync
ÎÎ. =
(
ÎÎ= >
loanRequest
ÎÎ> I
,
ÎÎI J
loanForUser
ÎÎK V
,
ÎÎV W
processedBy
ÎÎX c
)
ÎÎc d
;
ÎÎd e
if
ÌÌ 
(
ÌÌ 
loan
ÌÌ 
==
ÌÌ 
null
ÌÌ  
)
ÌÌ  !
{
ÓÓ 
await
ÔÔ 
_logService
ÔÔ %
.
ÔÔ% &
LogAsync
ÔÔ& .
(
ÔÔ. /

LogWarning
ÔÔ/ 9
,
ÔÔ9 :
$"
ÔÔ; =
$str
ÔÔ= i
{
ÔÔi j
loanRequest
ÔÔj u
.
ÔÔu v
BookId
ÔÔv |
}
ÔÔ| }
"
ÔÔ} ~
)
ÔÔ~ 
;ÔÔ Ä
return
 

BadRequest
 %
(
% &
$str& ê
)ê ë
;ë í
}
ÒÒ 
await
ÛÛ 
_logService
ÛÛ !
.
ÛÛ! "
LogAsync
ÛÛ" *
(
ÛÛ* +
LogInfo
ÛÛ+ 2
,
ÛÛ2 3
$"
ÛÛ4 6
$str
ÛÛ6 T
{
ÛÛT U
loan
ÛÛU Y
.
ÛÛY Z
Id
ÛÛZ \
}
ÛÛ\ ]
$str
ÛÛ] b
{
ÛÛb c
username
ÛÛc k
}
ÛÛk l
$str
ÛÛl s
{
ÛÛs t
role
ÛÛt x
}
ÛÛx y
$str
ÛÛy z
"
ÛÛz {
)
ÛÛ{ |
;
ÛÛ| }
return
ÙÙ 
CreatedAtAction
ÙÙ &
(
ÙÙ& '
nameof
ÙÙ' -
(
ÙÙ- .

GetMyLoans
ÙÙ. 8
)
ÙÙ8 9
,
ÙÙ9 :
new
ÙÙ; >
{
ÙÙ? @
id
ÙÙA C
=
ÙÙD E
loan
ÙÙF J
.
ÙÙJ K
Id
ÙÙK M
}
ÙÙN O
,
ÙÙO P
loan
ÙÙQ U
)
ÙÙU V
;
ÙÙV W
}
ıı 
catch
ˆˆ 
(
ˆˆ 
	Exception
ˆˆ 
ex
ˆˆ 
)
ˆˆ  
{
˜˜ 
await
¯¯ 
_logService
¯¯ !
.
¯¯! "
LogAsync
¯¯" *
(
¯¯* +
LogError
¯¯+ 3
,
¯¯3 4
$"
¯¯5 7
$str
¯¯7 [
{
¯¯[ \
loanRequest
¯¯\ g
?
¯¯g h
.
¯¯h i
BookId
¯¯i o
}
¯¯o p
"
¯¯p q
,
¯¯q r
ex
¯¯s u
)
¯¯u v
;
¯¯v w
return
˘˘ 

StatusCode
˘˘ !
(
˘˘! "
$num
˘˘" %
,
˘˘% &
ErrInternalServer
˘˘' 8
)
˘˘8 9
;
˘˘9 :
}
˙˙ 
}
˚˚ 	
[
˛˛ 	
HttpGet
˛˛	 
(
˛˛ 
$str
˛˛ "
)
˛˛" #
]
˛˛# $
[
ˇˇ 	
	Authorize
ˇˇ	 
]
ˇˇ 
[
ÄÄ 	 
EnableRateLimiting
ÄÄ	 
(
ÄÄ 
$str
ÄÄ (
)
ÄÄ( )
]
ÄÄ) *
public
ÅÅ 
async
ÅÅ 
Task
ÅÅ 
<
ÅÅ 
ActionResult
ÅÅ &
<
ÅÅ& '
LoanResponseDTO
ÅÅ' 6
>
ÅÅ6 7
>
ÅÅ7 8
GetById
ÅÅ9 @
(
ÅÅ@ A
string
ÅÅA G
id
ÅÅH J
)
ÅÅJ K
{
ÇÇ 	
try
ÉÉ 
{
ÑÑ 
var
ÖÖ 
username
ÖÖ 
=
ÖÖ 
User
ÖÖ #
.
ÖÖ# $
Identity
ÖÖ$ ,
?
ÖÖ, -
.
ÖÖ- .
Name
ÖÖ. 2
??
ÖÖ3 5
UnknownValue
ÖÖ6 B
;
ÖÖB C
var
ÜÜ 
role
ÜÜ 
=
ÜÜ 
User
ÜÜ 
.
ÜÜ  
	FindFirst
ÜÜ  )
(
ÜÜ) *

ClaimTypes
ÜÜ* 4
.
ÜÜ4 5
Role
ÜÜ5 9
)
ÜÜ9 :
?
ÜÜ: ;
.
ÜÜ; <
Value
ÜÜ< A
??
ÜÜB D
UnknownValue
ÜÜE Q
;
ÜÜQ R
await
áá 
_logService
áá !
.
áá! "
LogAsync
áá" *
(
áá* +
LogInfo
áá+ 2
,
áá2 3
$"
àà 
$str
àà 
{
àà 
username
àà '
}
àà' (
$str
àà( /
{
àà/ 0
role
àà0 4
}
àà4 5
$str
àà5 I
{
ààI J
id
ààJ L
}
ààL M
"
ààM N
)
ààN O
;
ààO P
var
ää 
loan
ää 
=
ää 
await
ää  
_loanService
ää! -
.
ää- .
GetLoanByIdAsync
ää. >
(
ää> ?
id
ää? A
)
ääA B
;
ääB C
if
ãã 
(
ãã 
loan
ãã 
==
ãã 
null
ãã  
)
ãã  !
{
åå 
await
çç 
_logService
çç %
.
çç% &
LogAsync
çç& .
(
çç. /

LogWarning
çç/ 9
,
çç9 :
$"
çç; =
$str
çç= U
{
ççU V
id
ççV X
}
ççX Y
"
ççY Z
)
ççZ [
;
çç[ \
return
éé 
NotFound
éé #
(
éé# $
LoanNotFound
éé$ 0
)
éé0 1
;
éé1 2
}
èè 
var
íí 
isPrivileged
íí  
=
íí! "
User
íí# '
.
íí' (
IsInRole
íí( 0
(
íí0 1
$str
íí1 @
)
íí@ A
||
ííB D
User
ííE I
.
ííI J
IsInRole
ííJ R
(
ííR S
$str
ííS b
)
ííb c
;
ííc d
if
ìì 
(
ìì 
!
ìì 
isPrivileged
ìì !
&&
ìì" $
!
îî 
string
îî 
.
îî 
Equals
îî "
(
îî" #
loan
îî# '
.
îî' (
Username
îî( 0
,
îî0 1
username
îî2 :
,
îî: ;
StringComparison
îî< L
.
îîL M
OrdinalIgnoreCase
îîM ^
)
îî^ _
)
îî_ `
{
ïï 
await
ññ 
_logService
ññ %
.
ññ% &
LogAsync
ññ& .
(
ññ. /

LogWarning
ññ/ 9
,
ññ9 :
$"
óó 
$str
óó 5
{
óó5 6
id
óó6 8
}
óó8 9
$str
óó9 G
{
óóG H
username
óóH P
}
óóP Q
"
óóQ R
)
óóR S
;
óóS T
return
òò 
Forbid
òò !
(
òò! "
)
òò" #
;
òò# $
}
ôô 
return
õõ 
Ok
õõ 
(
õõ 
loan
õõ 
)
õõ 
;
õõ  
}
úú 
catch
ùù 
(
ùù 
	Exception
ùù 
ex
ùù 
)
ùù  
{
ûû 
await
üü 
_logService
üü !
.
üü! "
LogAsync
üü" *
(
üü* +
LogError
üü+ 3
,
üü3 4
$"
üü5 7
$str
üü7 Q
{
üüQ R
id
üüR T
}
üüT U
"
üüU V
,
üüV W
ex
üüX Z
)
üüZ [
;
üü[ \
return
†† 

StatusCode
†† !
(
††! "
$num
††" %
,
††% &
ErrInternalServer
††' 8
)
††8 9
;
††9 :
}
°° 
}
¢¢ 	
[
•• 	
HttpPost
••	 
(
•• 
$str
•• 
)
•• 
]
•• 
[
¶¶ 	
	Authorize
¶¶	 
]
¶¶ 
[
ßß 	 
EnableRateLimiting
ßß	 
(
ßß 
$str
ßß )
)
ßß) *
]
ßß* +
public
®® 
async
®® 
Task
®® 
<
®® 
ActionResult
®® &
<
®®& '
LoanResponseDTO
®®' 6
>
®®6 7
>
®®7 8
RequestLoan
®®9 D
(
®®D E
[
®®E F
FromBody
®®F N
]
®®N O
LoanRequestDTO
®®P ^
loanRequest
®®_ j
)
®®j k
{
©© 	
try
™™ 
{
´´ 
if
¨¨ 
(
¨¨ 
!
¨¨ 

ModelState
¨¨ 
.
¨¨  
IsValid
¨¨  '
)
¨¨' (
{
≠≠ 
await
ÆÆ 
_logService
ÆÆ %
.
ÆÆ% &
LogAsync
ÆÆ& .
(
ÆÆ. /

LogWarning
ÆÆ/ 9
,
ÆÆ9 :
$str
ÆÆ; d
)
ÆÆd e
;
ÆÆe f
return
ØØ 

BadRequest
ØØ %
(
ØØ% &

ModelState
ØØ& 0
)
ØØ0 1
;
ØØ1 2
}
∞∞ 
if
≤≤ 
(
≤≤ 
string
≤≤ 
.
≤≤ 
IsNullOrEmpty
≤≤ (
(
≤≤( )
loanRequest
≤≤) 4
.
≤≤4 5
BookId
≤≤5 ;
)
≤≤; <
)
≤≤< =
{
≥≥ 
await
¥¥ 
_logService
¥¥ %
.
¥¥% &
LogAsync
¥¥& .
(
¥¥. /

LogWarning
¥¥/ 9
,
¥¥9 :
$str
¥¥; n
)
¥¥n o
;
¥¥o p
return
µµ 

BadRequest
µµ %
(
µµ% &
$str
µµ& A
)
µµA B
;
µµB C
}
∂∂ 
var
∏∏ 
username
∏∏ 
=
∏∏ 
User
∏∏ #
.
∏∏# $
Identity
∏∏$ ,
?
∏∏, -
.
∏∏- .
Name
∏∏. 2
??
∏∏3 5
UnknownValue
∏∏6 B
;
∏∏B C
var
ππ 
role
ππ 
=
ππ 
User
ππ 
.
ππ  
	FindFirst
ππ  )
(
ππ) *

ClaimTypes
ππ* 4
.
ππ4 5
Role
ππ5 9
)
ππ9 :
?
ππ: ;
.
ππ; <
Value
ππ< A
??
ππB D
UnknownValue
ππE Q
;
ππQ R
var
∫∫ 
processedBy
∫∫ 
=
∫∫  !
$"
∫∫" $
$str
∫∫$ 3
{
∫∫3 4
role
∫∫4 8
}
∫∫8 9
$str
∫∫9 :
"
∫∫: ;
;
∫∫; <
await
ºº 
_logService
ºº !
.
ºº! "
LogAsync
ºº" *
(
ºº* +
LogInfo
ºº+ 2
,
ºº2 3
$"
ΩΩ 
$str
ΩΩ 
{
ΩΩ 
username
ΩΩ '
}
ΩΩ' (
$str
ΩΩ( /
{
ΩΩ/ 0
role
ΩΩ0 4
}
ΩΩ4 5
$str
ΩΩ5 V
{
ΩΩV W
loanRequest
ΩΩW b
.
ΩΩb c
BookId
ΩΩc i
}
ΩΩi j
"
ΩΩj k
)
ΩΩk l
;
ΩΩl m
var
øø 
loan
øø 
=
øø 
await
øø  
_loanService
øø! -
.
øø- .
CreateLoanAsync
øø. =
(
øø= >
loanRequest
øø> I
,
øøI J
username
øøK S
,
øøS T
processedBy
øøU `
)
øø` a
;
øøa b
if
¡¡ 
(
¡¡ 
loan
¡¡ 
==
¡¡ 
null
¡¡  
)
¡¡  !
{
¬¬ 
await
√√ 
_logService
√√ %
.
√√% &
LogAsync
√√& .
(
√√. /

LogWarning
√√/ 9
,
√√9 :
$"
ƒƒ 
$str
ƒƒ S
{
ƒƒS T
loanRequest
ƒƒT _
.
ƒƒ_ `
BookId
ƒƒ` f
}
ƒƒf g
"
ƒƒg h
)
ƒƒh i
;
ƒƒi j
return
≈≈ 

BadRequest
≈≈ %
(
≈≈% &
$str≈≈& à
)≈≈à â
;≈≈â ä
}
∆∆ 
await
»» 
_logService
»» !
.
»»! "
LogAsync
»»" *
(
»»* +
LogInfo
»»+ 2
,
»»2 3
$"
…… 
$str
…… A
{
……A B
loan
……B F
.
……F G
Id
……G I
}
……I J
$str
……J X
{
……X Y
username
……Y a
}
……a b
$str
……b i
{
……i j
role
……j n
}
……n o
$str
……o p
"
……p q
)
……q r
;
……r s
return
   
Ok
   
(
   
loan
   
)
   
;
    
}
ÀÀ 
catch
ÃÃ 
(
ÃÃ 
	Exception
ÃÃ 
ex
ÃÃ 
)
ÃÃ  
{
ÕÕ 
await
ŒŒ 
_logService
ŒŒ !
.
ŒŒ! "
LogAsync
ŒŒ" *
(
ŒŒ* +
LogError
ŒŒ+ 3
,
ŒŒ3 4
$"
ŒŒ5 7
$str
ŒŒ7 _
{
ŒŒ_ `
loanRequest
ŒŒ` k
?
ŒŒk l
.
ŒŒl m
BookId
ŒŒm s
}
ŒŒs t
"
ŒŒt u
,
ŒŒu v
ex
ŒŒw y
)
ŒŒy z
;
ŒŒz {
return
œœ 

StatusCode
œœ !
(
œœ! "
$num
œœ" %
,
œœ% &
ErrInternalServer
œœ' 8
)
œœ8 9
;
œœ9 :
}
–– 
}
—— 	
[
‘‘ 	
HttpPut
‘‘	 
(
‘‘ 
$str
‘‘ 
)
‘‘ 
]
‘‘  
[
’’ 	
	Authorize
’’	 
(
’’ 
Roles
’’ 
=
’’ 
$str
’’ 8
)
’’8 9
]
’’9 :
[
÷÷ 	 
EnableRateLimiting
÷÷	 
(
÷÷ 
$str
÷÷ )
)
÷÷) *
]
÷÷* +
public
◊◊ 
async
◊◊ 
Task
◊◊ 
<
◊◊ 
IActionResult
◊◊ '
>
◊◊' (

ReturnBook
◊◊) 3
(
◊◊3 4
string
◊◊4 :
id
◊◊; =
,
◊◊= >
[
◊◊? @
FromBody
◊◊@ H
]
◊◊H I
ReturnBookDTO
◊◊J W
	returnDto
◊◊X a
)
◊◊a b
{
ÿÿ 	
try
ŸŸ 
{
⁄⁄ 
if
€€ 
(
€€ 
string
€€ 
.
€€ 
IsNullOrEmpty
€€ (
(
€€( )
id
€€) +
)
€€+ ,
)
€€, -
{
‹‹ 
await
›› 
_logService
›› %
.
››% &
LogAsync
››& .
(
››. /

LogWarning
››/ 9
,
››9 :
$str
››; e
)
››e f
;
››f g
return
ﬁﬁ 

BadRequest
ﬁﬁ %
(
ﬁﬁ% &"
BadRequestIdRequired
ﬁﬁ& :
)
ﬁﬁ: ;
;
ﬁﬁ; <
}
ﬂﬂ 
if
·· 
(
·· 
!
·· 

ModelState
·· 
.
··  
IsValid
··  '
)
··' (
{
‚‚ 
await
„„ 
_logService
„„ %
.
„„% &
LogAsync
„„& .
(
„„. /

LogWarning
„„/ 9
,
„„9 :
$"
„„; =
$str
„„= n
{
„„n o
id
„„o q
}
„„q r
"
„„r s
)
„„s t
;
„„t u
return
‰‰ 

BadRequest
‰‰ %
(
‰‰% &

ModelState
‰‰& 0
)
‰‰0 1
;
‰‰1 2
}
ÂÂ 
var
ÁÁ 
username
ÁÁ 
=
ÁÁ 
User
ÁÁ #
.
ÁÁ# $
Identity
ÁÁ$ ,
?
ÁÁ, -
.
ÁÁ- .
Name
ÁÁ. 2
??
ÁÁ3 5
UnknownValue
ÁÁ6 B
;
ÁÁB C
var
ËË 
role
ËË 
=
ËË 
User
ËË 
.
ËË  
	FindFirst
ËË  )
(
ËË) *

ClaimTypes
ËË* 4
.
ËË4 5
Role
ËË5 9
)
ËË9 :
?
ËË: ;
.
ËË; <
Value
ËË< A
??
ËËB D
UnknownValue
ËËE Q
;
ËËQ R
await
ÍÍ 
_logService
ÍÍ !
.
ÍÍ! "
LogAsync
ÍÍ" *
(
ÍÍ* +
LogInfo
ÍÍ+ 2
,
ÍÍ2 3
$"
ÎÎ 
$str
ÎÎ 
{
ÎÎ 
username
ÎÎ '
}
ÎÎ' (
$str
ÎÎ( /
{
ÎÎ/ 0
role
ÎÎ0 4
}
ÎÎ4 5
$str
ÎÎ5 Z
{
ÎÎZ [
id
ÎÎ[ ]
}
ÎÎ] ^
"
ÎÎ^ _
)
ÎÎ_ `
;
ÎÎ` a
var
ÌÌ 
success
ÌÌ 
=
ÌÌ 
await
ÌÌ #
_loanService
ÌÌ$ 0
.
ÌÌ0 1
ReturnBookAsync
ÌÌ1 @
(
ÌÌ@ A
id
ÌÌA C
,
ÌÌC D
	returnDto
ÌÌE N
,
ÌÌN O
$"
ÌÌP R
{
ÌÌR S
username
ÌÌS [
}
ÌÌ[ \
$str
ÌÌ\ ^
{
ÌÌ^ _
role
ÌÌ_ c
}
ÌÌc d
$str
ÌÌd e
"
ÌÌe f
)
ÌÌf g
;
ÌÌg h
if
ÔÔ 
(
ÔÔ 
!
ÔÔ 
success
ÔÔ 
)
ÔÔ 
{
 
await
ÒÒ 
_logService
ÒÒ %
.
ÒÒ% &
LogAsync
ÒÒ& .
(
ÒÒ. /

LogWarning
ÒÒ/ 9
,
ÒÒ9 :
$"
ÒÒ; =
$str
ÒÒ= m
{
ÒÒm n
id
ÒÒn p
}
ÒÒp q
"
ÒÒq r
)
ÒÒr s
;
ÒÒs t
return
ÚÚ 
NotFound
ÚÚ #
(
ÚÚ# $
$str
ÚÚ$ J
)
ÚÚJ K
;
ÚÚK L
}
ÛÛ 
await
ıı 
_logService
ıı !
.
ıı! "
LogAsync
ıı" *
(
ıı* +
LogInfo
ıı+ 2
,
ıı2 3
$"
ˆˆ 
$str
ˆˆ 9
{
ˆˆ9 :
id
ˆˆ: <
}
ˆˆ< =
$str
ˆˆ= B
{
ˆˆB C
username
ˆˆC K
}
ˆˆK L
$str
ˆˆL S
{
ˆˆS T
role
ˆˆT X
}
ˆˆX Y
$str
ˆˆY Z
"
ˆˆZ [
)
ˆˆ[ \
;
ˆˆ\ ]
return
˜˜ 
	NoContent
˜˜  
(
˜˜  !
)
˜˜! "
;
˜˜" #
}
¯¯ 
catch
˘˘ 
(
˘˘ 
	Exception
˘˘ 
ex
˘˘ 
)
˘˘  
{
˙˙ 
await
˚˚ 
_logService
˚˚ !
.
˚˚! "
LogAsync
˚˚" *
(
˚˚* +
LogError
˚˚+ 3
,
˚˚3 4
$"
˚˚5 7
$str
˚˚7 a
{
˚˚a b
id
˚˚b d
}
˚˚d e
"
˚˚e f
,
˚˚f g
ex
˚˚h j
)
˚˚j k
;
˚˚k l
return
¸¸ 

StatusCode
¸¸ !
(
¸¸! "
$num
¸¸" %
,
¸¸% &
ErrInternalServer
¸¸' 8
)
¸¸8 9
;
¸¸9 :
}
˝˝ 
}
˛˛ 	
[
ÅÅ 	
HttpPut
ÅÅ	 
(
ÅÅ 
$str
ÅÅ 
)
ÅÅ 
]
ÅÅ  
[
ÇÇ 	
	Authorize
ÇÇ	 
(
ÇÇ 
Roles
ÇÇ 
=
ÇÇ 
$str
ÇÇ *
)
ÇÇ* +
]
ÇÇ+ ,
[
ÉÉ 	 
EnableRateLimiting
ÉÉ	 
(
ÉÉ 
$str
ÉÉ )
)
ÉÉ) *
]
ÉÉ* +
public
ÑÑ 
async
ÑÑ 
Task
ÑÑ 
<
ÑÑ 
IActionResult
ÑÑ '
>
ÑÑ' (
UpdateLoanStatus
ÑÑ) 9
(
ÑÑ9 :
string
ÑÑ: @
id
ÑÑA C
,
ÑÑC D
[
ÑÑE F
FromBody
ÑÑF N
]
ÑÑN O!
UpdateLoanStatusDto
ÑÑP c
	statusDto
ÑÑd m
)
ÑÑm n
{
ÖÖ 	
try
ÜÜ 
{
áá 
if
àà 
(
àà 
string
àà 
.
àà 
IsNullOrEmpty
àà (
(
àà( )
id
àà) +
)
àà+ ,
)
àà, -
{
ââ 
await
ää 
_logService
ää %
.
ää% &
LogAsync
ää& .
(
ää. /

LogWarning
ää/ 9
,
ää9 :
$str
ää; l
)
ääl m
;
ääm n
return
ãã 

BadRequest
ãã %
(
ãã% &"
BadRequestIdRequired
ãã& :
)
ãã: ;
;
ãã; <
}
åå 
if
éé 
(
éé 
!
éé 

ModelState
éé 
.
éé  
IsValid
éé  '
)
éé' (
{
èè 
await
êê 
_logService
êê %
.
êê% &
LogAsync
êê& .
(
êê. /

LogWarning
êê/ 9
,
êê9 :
$"
êê; =
$str
êê= q
{
êêq r
id
êêr t
}
êêt u
"
êêu v
)
êêv w
;
êêw x
return
ëë 

BadRequest
ëë %
(
ëë% &

ModelState
ëë& 0
)
ëë0 1
;
ëë1 2
}
íí 
var
îî 
username
îî 
=
îî 
User
îî #
.
îî# $
Identity
îî$ ,
?
îî, -
.
îî- .
Name
îî. 2
??
îî3 5
UnknownValue
îî6 B
;
îîB C
var
ïï 
role
ïï 
=
ïï 
User
ïï 
.
ïï  
	FindFirst
ïï  )
(
ïï) *

ClaimTypes
ïï* 4
.
ïï4 5
Role
ïï5 9
)
ïï9 :
?
ïï: ;
.
ïï; <
Value
ïï< A
??
ïïB D
UnknownValue
ïïE Q
;
ïïQ R
await
óó 
_logService
óó !
.
óó! "
LogAsync
óó" *
(
óó* +
LogInfo
óó+ 2
,
óó2 3
$"
òò 
$str
òò 
{
òò 
username
òò '
}
òò' (
$str
òò( /
{
òò/ 0
role
òò0 4
}
òò4 5
$str
òò5 X
{
òòX Y
id
òòY [
}
òò[ \
$str
òò\ _
{
òò_ `
	statusDto
òò` i
.
òòi j
Status
òòj p
}
òòp q
"
òòq r
)
òòr s
;
òòs t
var
öö 
success
öö 
=
öö 
await
öö #
_loanService
öö$ 0
.
öö0 1#
UpdateLoanStatusAsync
öö1 F
(
ööF G
id
ööG I
,
ööI J
	statusDto
ööK T
.
ööT U
Status
ööU [
)
öö[ \
;
öö\ ]
if
úú 
(
úú 
!
úú 
success
úú 
)
úú 
{
ùù 
await
ûû 
_logService
ûû %
.
ûû% &
LogAsync
ûû& .
(
ûû. /

LogWarning
ûû/ 9
,
ûû9 :
$"
ûû; =
$str
ûû= k
{
ûûk l
id
ûûl n
}
ûûn o
"
ûûo p
)
ûûp q
;
ûûq r
return
üü 
NotFound
üü #
(
üü# $
LoanNotFound
üü$ 0
)
üü0 1
;
üü1 2
}
†† 
await
¢¢ 
_logService
¢¢ !
.
¢¢! "
LogAsync
¢¢" *
(
¢¢* +
LogInfo
¢¢+ 2
,
¢¢2 3
$"
££ 
$str
££ 7
{
££7 8
id
££8 :
}
££: ;
$str
££; >
{
££> ?
	statusDto
££? H
.
££H I
Status
££I O
}
££O P
$str
££P U
{
££U V
username
££V ^
}
££^ _
$str
££_ f
{
££f g
role
££g k
}
££k l
$str
££l m
"
££m n
)
££n o
;
££o p
return
§§ 
	NoContent
§§  
(
§§  !
)
§§! "
;
§§" #
}
•• 
catch
¶¶ 
(
¶¶ 
	Exception
¶¶ 
ex
¶¶ 
)
¶¶  
{
ßß 
await
®® 
_logService
®® !
.
®®! "
LogAsync
®®" *
(
®®* +
LogError
®®+ 3
,
®®3 4
$"
®®5 7
$str
®®7 _
{
®®_ `
id
®®` b
}
®®b c
"
®®c d
,
®®d e
ex
®®f h
)
®®h i
;
®®i j
return
©© 

StatusCode
©© !
(
©©! "
$num
©©" %
,
©©% &
ErrInternalServer
©©' 8
)
©©8 9
;
©©9 :
}
™™ 
}
´´ 	
[
ÆÆ 	
HttpGet
ÆÆ	 
(
ÆÆ 
$str
ÆÆ 
)
ÆÆ 
]
ÆÆ 
[
ØØ 	
	Authorize
ØØ	 
(
ØØ 
Roles
ØØ 
=
ØØ 
$str
ØØ 8
)
ØØ8 9
]
ØØ9 :
[
∞∞ 	 
EnableRateLimiting
∞∞	 
(
∞∞ 
$str
∞∞ (
)
∞∞( )
]
∞∞) *
public
±± 
async
±± 
Task
±± 
<
±± 
ActionResult
±± &
<
±±& '
object
±±' -
>
±±- .
>
±±. /
GetLoanStatistics
±±0 A
(
±±A B
)
±±B C
{
≤≤ 	
try
≥≥ 
{
¥¥ 
var
µµ 
username
µµ 
=
µµ 
User
µµ #
.
µµ# $
Identity
µµ$ ,
?
µµ, -
.
µµ- .
Name
µµ. 2
??
µµ3 5
UnknownValue
µµ6 B
;
µµB C
var
∂∂ 
role
∂∂ 
=
∂∂ 
User
∂∂ 
.
∂∂  
	FindFirst
∂∂  )
(
∂∂) *

ClaimTypes
∂∂* 4
.
∂∂4 5
Role
∂∂5 9
)
∂∂9 :
?
∂∂: ;
.
∂∂; <
Value
∂∂< A
??
∂∂B D
UnknownValue
∂∂E Q
;
∂∂Q R
await
∑∑ 
_logService
∑∑ !
.
∑∑! "
LogAsync
∑∑" *
(
∑∑* +
LogInfo
∑∑+ 2
,
∑∑2 3
$"
∏∏ 
$str
∏∏ 
{
∏∏ 
username
∏∏ '
}
∏∏' (
$str
∏∏( /
{
∏∏/ 0
role
∏∏0 4
}
∏∏4 5
$str
∏∏5 \
"
∏∏\ ]
)
∏∏] ^
;
∏∏^ _
var
∫∫ 
totalActive
∫∫ 
=
∫∫  !
await
∫∫" '
_loanService
∫∫( 4
.
∫∫4 5&
GetTotalActiveLoansAsync
∫∫5 M
(
∫∫M N
)
∫∫N O
;
∫∫O P
var
ªª 
totalOverdue
ªª  
=
ªª! "
await
ªª# (
_loanService
ªª) 5
.
ªª5 6'
GetTotalOverdueLoansAsync
ªª6 O
(
ªªO P
)
ªªP Q
;
ªªQ R
var
ΩΩ 

statistics
ΩΩ 
=
ΩΩ  
new
ΩΩ! $
{
ææ 
TotalActiveLoans
øø $
=
øø% &
totalActive
øø' 2
,
øø2 3
TotalOverdueLoans
¿¿ %
=
¿¿& '
totalOverdue
¿¿( 4
,
¿¿4 5
	Timestamp
¡¡ 
=
¡¡ 
DateTime
¡¡  (
.
¡¡( )
UtcNow
¡¡) /
}
¬¬ 
;
¬¬ 
return
ƒƒ 
Ok
ƒƒ 
(
ƒƒ 

statistics
ƒƒ $
)
ƒƒ$ %
;
ƒƒ% &
}
≈≈ 
catch
∆∆ 
(
∆∆ 
	Exception
∆∆ 
ex
∆∆ 
)
∆∆  
{
«« 
await
»» 
_logService
»» !
.
»»! "
LogAsync
»»" *
(
»»* +
LogError
»»+ 3
,
»»3 4
$str
»»5 a
,
»»a b
ex
»»c e
)
»»e f
;
»»f g
return
…… 

StatusCode
…… !
(
……! "
$num
……" %
,
……% &
ErrInternalServer
……' 8
)
……8 9
;
……9 :
}
   
}
ÀÀ 	
[
ŒŒ 	
HttpGet
ŒŒ	 
(
ŒŒ 
$str
ŒŒ (
)
ŒŒ( )
]
ŒŒ) *
[
œœ 	
	Authorize
œœ	 
(
œœ 
Roles
œœ 
=
œœ 
$str
œœ *
)
œœ* +
]
œœ+ ,
[
–– 	 
EnableRateLimiting
––	 
(
–– 
$str
–– (
)
––( )
]
––) *
public
““ 
async
““ 
Task
““ 
<
““ 
ActionResult
““ &
<
““& '
IEnumerable
““' 2
<
““2 3
LoanResponseDTO
““3 B
>
““B C
>
““C D
>
““D E
GetUserLoans
““F R
(
““R S
string
““S Y
targetUsername
““Z h
)
““h i
{
”” 	
try
‘‘ 
{
’’ 
if
÷÷ 
(
÷÷ 
string
÷÷ 
.
÷÷ 
IsNullOrEmpty
÷÷ (
(
÷÷( )
targetUsername
÷÷) 7
)
÷÷7 8
)
÷÷8 9
{
◊◊ 
await
ÿÿ 
_logService
ÿÿ %
.
ÿÿ% &
LogAsync
ÿÿ& .
(
ÿÿ. /

LogWarning
ÿÿ/ 9
,
ÿÿ9 :
$str
ÿÿ; h
)
ÿÿh i
;
ÿÿi j
return
ŸŸ 

BadRequest
ŸŸ %
(
ŸŸ% &
$str
ŸŸ& =
)
ŸŸ= >
;
ŸŸ> ?
}
⁄⁄ 
var
‹‹ 
username
‹‹ 
=
‹‹ 
User
‹‹ #
.
‹‹# $
Identity
‹‹$ ,
?
‹‹, -
.
‹‹- .
Name
‹‹. 2
??
‹‹3 5
UnknownValue
‹‹6 B
;
‹‹B C
var
›› 
role
›› 
=
›› 
User
›› 
.
››  
	FindFirst
››  )
(
››) *

ClaimTypes
››* 4
.
››4 5
Role
››5 9
)
››9 :
?
››: ;
.
››; <
Value
››< A
??
››B D
UnknownValue
››E Q
;
››Q R
await
ﬁﬁ 
_logService
ﬁﬁ !
.
ﬁﬁ! "
LogAsync
ﬁﬁ" *
(
ﬁﬁ* +
LogInfo
ﬁﬁ+ 2
,
ﬁﬁ2 3
$"
ﬂﬂ 
$str
ﬂﬂ 
{
ﬂﬂ 
username
ﬂﬂ '
}
ﬂﬂ' (
$str
ﬂﬂ( /
{
ﬂﬂ/ 0
role
ﬂﬂ0 4
}
ﬂﬂ4 5
$str
ﬂﬂ5 Y
{
ﬂﬂY Z
targetUsername
ﬂﬂZ h
}
ﬂﬂh i
"
ﬂﬂi j
)
ﬂﬂj k
;
ﬂﬂk l
var
·· 
loans
·· 
=
·· 
await
·· !
_loanService
··" .
.
··. /!
GetLoansByUserAsync
··/ B
(
··B C
targetUsername
··C Q
)
··Q R
;
··R S
return
‚‚ 
Ok
‚‚ 
(
‚‚ 
loans
‚‚ 
)
‚‚  
;
‚‚  !
}
„„ 
catch
‰‰ 
(
‰‰ 
	Exception
‰‰ 
ex
‰‰ 
)
‰‰  
{
ÂÂ 
await
ÊÊ 
_logService
ÊÊ !
.
ÊÊ! "
LogAsync
ÊÊ" *
(
ÊÊ* +
LogError
ÊÊ+ 3
,
ÊÊ3 4
$"
ÊÊ5 7
$str
ÊÊ7 ^
{
ÊÊ^ _
targetUsername
ÊÊ_ m
}
ÊÊm n
"
ÊÊn o
,
ÊÊo p
ex
ÊÊq s
)
ÊÊs t
;
ÊÊt u
return
ÁÁ 

StatusCode
ÁÁ !
(
ÁÁ! "
$num
ÁÁ" %
,
ÁÁ% &
ErrInternalServer
ÁÁ' 8
)
ÁÁ8 9
;
ÁÁ9 :
}
ËË 
}
ÈÈ 	
}
ÍÍ 
public
ÏÏ 

class
ÏÏ !
UpdateLoanStatusDto
ÏÏ $
{
ÌÌ 
public
ÓÓ 

LoanStatus
ÓÓ 
Status
ÓÓ  
{
ÓÓ! "
get
ÓÓ# &
;
ÓÓ& '
set
ÓÓ( +
;
ÓÓ+ ,
}
ÓÓ- .
}
ÔÔ 
} ıø
SC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Controllers\LogController.cs
	namespace		 	

LibraryApp		
 
.		 
Controllers		  
{

 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
[ 
	Authorize 
( 
Roles 
= 
$str &
)& '
]' (
public 

class 
LogController 
:  
ControllerBase! /
{ 
private 
readonly 
MongoDBService '
_mongoService( 5
;5 6
private 
readonly 

Logservice #
_logService$ /
;/ 0
private 
const 
string 
LogError %
=& '
$str( /
;/ 0
private 
const 
string 

LogWarning '
=( )
$str* 3
;3 4
private 
const 
string 
LogInfo $
=% &
$str' 4
;4 5
private 
const 
string 
ErrInternalServer .
=/ 0
$str1 M
;M N
private 
const 
string 
UnknownValue )
=* +
$str, ;
;; <
public 
LogController 
( 
MongoDBService +
mongoService, 8
,8 9

Logservice: D

logServiceE O
)O P
{ 	
_mongoService 
= 
mongoService (
;( )
_logService 
= 

logService $
;$ %
} 	
[!! 	
HttpGet!!	 
(!! 
$str!! 
)!! 
]!! 
["" 	
EnableRateLimiting""	 
("" 
$str"" (
)""( )
]"") *
public## 
async## 
Task## 
<## 
ActionResult## &
<##& '
IEnumerable##' 2
<##2 3
LogEntry##3 ;
>##; <
>##< =
>##= >
GetRecentLogs##? L
(##L M
[##M N
	FromQuery##N W
]##W X
int##Y \
limit##] b
=##c d
$num##e h
)##h i
{$$ 	
try%% 
{&& 
var'' 
username'' 
='' 
User'' #
.''# $
Identity''$ ,
?'', -
.''- .
Name''. 2
??''3 5
UnknownValue''6 B
;''B C
await(( 
_logService(( !
.((! "
LogAsync((" *
(((* +
LogInfo((+ 2
,((2 3
$"((4 6
$str((6 >
{((> ?
username((? G
}((G H
$str((H c
"((c d
)((d e
;((e f
if++ 
(++ 
limit++ 
<=++ 
$num++ 
||++ !
limit++" '
>++( )
$num++* .
)++. /
limit,, 
=,, 
$num,, 
;,,  
var.. 
logs.. 
=.. 
await..  
_mongoService..! .
.... /

LogEntries../ 9
.// 
Find// 
(// 
_// 
=>// 
true// #
)//# $
.00 
SortByDescending00 %
(00% &
l00& '
=>00( *
l00+ ,
.00, -
	Timestamp00- 6
)006 7
.11 
Limit11 
(11 
limit11  
)11  !
.22 
ToListAsync22  
(22  !
)22! "
;22" #
return44 
Ok44 
(44 
logs44 
)44 
;44  
}55 
catch66 
(66 
	Exception66 
ex66 
)66  
{77 
await88 
_logService88 !
.88! "
LogAsync88" *
(88* +
LogError88+ 3
,883 4
$str885 V
,88V W
ex88X Z
)88Z [
;88[ \
return99 

StatusCode99 !
(99! "
$num99" %
,99% &
new99' *
{99+ ,
message99- 4
=995 6
ErrInternalServer997 H
}99I J
)99J K
;99K L
}:: 
};; 	
[@@ 	
HttpGet@@	 
(@@ 
$str@@  
)@@  !
]@@! "
[AA 	
EnableRateLimitingAA	 
(AA 
$strAA (
)AA( )
]AA) *
publicBB 
asyncBB 
TaskBB 
<BB 
ActionResultBB &
<BB& '
objectBB' -
>BB- .
>BB. /
GetLogCountByLevelBB0 B
(BBB C
stringBBC I
levelBBJ O
)BBO P
{CC 	
tryDD 
{EE 
ifFF 
(FF 
stringFF 
.FF 
IsNullOrWhiteSpaceFF -
(FF- .
levelFF. 3
)FF3 4
)FF4 5
{GG 
returnHH 

BadRequestHH %
(HH% &
newHH& )
{HH* +
messageHH, 3
=HH4 5
$strHH6 T
}HHU V
)HHV W
;HHW X
}II 
varKK 
usernameKK 
=KK 
UserKK #
.KK# $
IdentityKK$ ,
?KK, -
.KK- .
NameKK. 2
??KK3 5
UnknownValueKK6 B
;KKB C
awaitLL 
_logServiceLL !
.LL! "
LogAsyncLL" *
(LL* +
LogInfoLL+ 2
,LL2 3
$"LL4 6
$strLL6 >
{LL> ?
usernameLL? G
}LLG H
$strLLH o
{LLo p
levelLLp u
}LLu v
"LLv w
)LLw x
;LLx y
varNN 
countNN 
=NN 
awaitNN !
_mongoServiceNN" /
.NN/ 0

LogEntriesNN0 :
.OO 
CountDocumentsAsyncOO 
(OO 
lOO 
=>OO 
stringOO $
.OO$ %
EqualsOO% +
(OO+ ,
lOO, -
.OO- .
LevelOO. 3
,OO3 4
levelOO5 :
,OO: ;
StringComparisonOO< L
.OOL M
OrdinalIgnoreCaseOOM ^
)OO^ _
)OO_ `
;OO` a
returnQQ 
OkQQ 
(QQ 
newQQ 
{RR 
levelSS 
=SS 
levelSS !
,SS! "
countTT 
=TT 
countTT !
,TT! "
	timestampUU 
=UU 
DateTimeUU  (
.UU( )
UtcNowUU) /
}VV 
)VV 
;VV 
}WW 
catchXX 
(XX 
	ExceptionXX 
exXX 
)XX  
{YY 
awaitZZ 
_logServiceZZ !
.ZZ! "
LogAsyncZZ" *
(ZZ* +
LogErrorZZ+ 3
,ZZ3 4
$"ZZ5 7
$strZZ7 b
{ZZb c
levelZZc h
}ZZh i
"ZZi j
,ZZj k
exZZl n
)ZZn o
;ZZo p
return[[ 

StatusCode[[ !
([[! "
$num[[" %
,[[% &
new[[' *
{[[+ ,
message[[- 4
=[[5 6
ErrInternalServer[[7 H
}[[I J
)[[J K
;[[K L
}\\ 
}]] 	
[bb 	
HttpGetbb	 
(bb 
$strbb 
)bb 
]bb 
[cc 	
EnableRateLimitingcc	 
(cc 
$strcc (
)cc( )
]cc) *
publicdd 
asyncdd 
Taskdd 
<dd 
ActionResultdd &
<dd& '
IEnumerabledd' 2
<dd2 3
LogEntrydd3 ;
>dd; <
>dd< =
>dd= >
GetLogsByDateRangedd? Q
(ddQ R
[ee 
	FromQueryee 
]ee 
DateTimeee  
	startDateee! *
,ee* +
[ff 
	FromQueryff 
]ff 
DateTimeff  
endDateff! (
,ff( )
[gg 
	FromQuerygg 
]gg 
intgg 
limitgg !
=gg" #
$numgg$ '
)gg' (
{hh 	
tryii 
{jj 
varkk 
usernamekk 
=kk 
Userkk #
.kk# $
Identitykk$ ,
?kk, -
.kk- .
Namekk. 2
??kk3 5
UnknownValuekk6 B
;kkB C
awaitll 
_logServicell !
.ll! "
LogAsyncll" *
(ll* +
LogInfoll+ 2
,ll2 3
$"mm 
$strmm 
{mm 
usernamemm '
}mm' (
$strmm( O
{mmO P
	startDatemmP Y
}mmY Z
$strmmZ ]
{mm] ^
endDatemm^ e
}mme f
"mmf g
)mmg h
;mmh i
ifpp 
(pp 
	startDatepp 
>=pp  
endDatepp! (
)pp( )
{qq 
returnrr 

BadRequestrr %
(rr% &
newrr& )
{rr* +
messagerr, 3
=rr4 5
$strrr6 k
}rrl m
)rrm n
;rrn o
}ss 
ifvv 
(vv 
limitvv 
<=vv 
$numvv 
||vv !
limitvv" '
>vv( )
$numvv* .
)vv. /
limitww 
=ww 
$numww 
;ww  
varyy 
filteryy 
=yy 
Buildersyy %
<yy% &
LogEntryyy& .
>yy. /
.yy/ 0
Filteryy0 6
.yy6 7
Andyy7 :
(yy: ;
Builderszz 
<zz 
LogEntryzz %
>zz% &
.zz& '
Filterzz' -
.zz- .
Gtezz. 1
(zz1 2
lzz2 3
=>zz4 6
lzz7 8
.zz8 9
	Timestampzz9 B
,zzB C
	startDatezzD M
)zzM N
,zzN O
Builders{{ 
<{{ 
LogEntry{{ %
>{{% &
.{{& '
Filter{{' -
.{{- .
Lte{{. 1
({{1 2
l{{2 3
=>{{4 6
l{{7 8
.{{8 9
	Timestamp{{9 B
,{{B C
endDate{{D K
){{K L
)|| 
;|| 
var~~ 
logs~~ 
=~~ 
await~~  
_mongoService~~! .
.~~. /

LogEntries~~/ 9
. 
Find 
( 
filter  
)  !
.
ÄÄ 
SortByDescending
ÄÄ %
(
ÄÄ% &
l
ÄÄ& '
=>
ÄÄ( *
l
ÄÄ+ ,
.
ÄÄ, -
	Timestamp
ÄÄ- 6
)
ÄÄ6 7
.
ÅÅ 
Limit
ÅÅ 
(
ÅÅ 
limit
ÅÅ  
)
ÅÅ  !
.
ÇÇ 
ToListAsync
ÇÇ  
(
ÇÇ  !
)
ÇÇ! "
;
ÇÇ" #
return
ÑÑ 
Ok
ÑÑ 
(
ÑÑ 
logs
ÑÑ 
)
ÑÑ 
;
ÑÑ  
}
ÖÖ 
catch
ÜÜ 
(
ÜÜ 
	Exception
ÜÜ 
ex
ÜÜ 
)
ÜÜ  
{
áá 
await
àà 
_logService
àà !
.
àà! "
LogAsync
àà" *
(
àà* +
LogError
àà+ 3
,
àà3 4
$"
ââ 
$str
ââ A
{
ââA B
	startDate
ââB K
}
ââK L
$str
ââL O
{
ââO P
endDate
ââP W
}
ââW X
"
ââX Y
,
ââY Z
ex
ââ[ ]
)
ââ] ^
;
ââ^ _
return
ää 

StatusCode
ää !
(
ää! "
$num
ää" %
,
ää% &
new
ää' *
{
ää+ ,
message
ää- 4
=
ää5 6
ErrInternalServer
ää7 H
}
ääI J
)
ääJ K
;
ääK L
}
ãã 
}
åå 	
[
ëë 	
HttpGet
ëë	 
(
ëë 
$str
ëë "
)
ëë" #
]
ëë# $
[
íí 	 
EnableRateLimiting
íí	 
(
íí 
$str
íí (
)
íí( )
]
íí) *
public
ìì 
async
ìì 
Task
ìì 
<
ìì 
ActionResult
ìì &
<
ìì& '
IEnumerable
ìì' 2
<
ìì2 3
LogEntry
ìì3 ;
>
ìì; <
>
ìì< =
>
ìì= >
GetLogsByUser
ìì? L
(
ììL M
string
îî 
username
îî 
,
îî 
[
ïï 
	FromQuery
ïï 
]
ïï 
int
ïï 
limit
ïï !
=
ïï" #
$num
ïï$ '
)
ïï' (
{
ññ 	
try
óó 
{
òò 
if
ôô 
(
ôô 
string
ôô 
.
ôô  
IsNullOrWhiteSpace
ôô -
(
ôô- .
username
ôô. 6
)
ôô6 7
)
ôô7 8
{
öö 
return
õõ 

BadRequest
õõ %
(
õõ% &
new
õõ& )
{
õõ* +
message
õõ, 3
=
õõ4 5
$str
õõ6 Y
}
õõZ [
)
õõ[ \
;
õõ\ ]
}
úú 
var
ûû 
currentUser
ûû 
=
ûû  !
User
ûû" &
.
ûû& '
Identity
ûû' /
?
ûû/ 0
.
ûû0 1
Name
ûû1 5
??
ûû6 8
UnknownValue
ûû9 E
;
ûûE F
await
üü 
_logService
üü !
.
üü! "
LogAsync
üü" *
(
üü* +
LogInfo
üü+ 2
,
üü2 3
$"
†† 
$str
†† 
{
†† 
currentUser
†† *
}
††* +
$str
††+ J
{
††J K
username
††K S
}
††S T
"
††T U
)
††U V
;
††V W
if
££ 
(
££ 
limit
££ 
<=
££ 
$num
££ 
||
££ !
limit
££" '
>
££( )
$num
££* .
)
££. /
limit
§§ 
=
§§ 
$num
§§ 
;
§§  
var
¶¶ 
logs
¶¶ 
=
¶¶ 
await
¶¶  
_mongoService
¶¶! .
.
¶¶. /

LogEntries
¶¶/ 9
.
ßß 
Find
ßß 
(
ßß 
l
ßß 
=>
ßß 
l
ßß  
.
ßß  !
Username
ßß! )
==
ßß* ,
username
ßß- 5
)
ßß5 6
.
®® 
SortByDescending
®® %
(
®®% &
l
®®& '
=>
®®( *
l
®®+ ,
.
®®, -
	Timestamp
®®- 6
)
®®6 7
.
©© 
Limit
©© 
(
©© 
limit
©©  
)
©©  !
.
™™ 
ToListAsync
™™  
(
™™  !
)
™™! "
;
™™" #
return
¨¨ 
Ok
¨¨ 
(
¨¨ 
logs
¨¨ 
)
¨¨ 
;
¨¨  
}
≠≠ 
catch
ÆÆ 
(
ÆÆ 
	Exception
ÆÆ 
ex
ÆÆ 
)
ÆÆ  
{
ØØ 
await
∞∞ 
_logService
∞∞ !
.
∞∞! "
LogAsync
∞∞" *
(
∞∞* +
LogError
∞∞+ 3
,
∞∞3 4
$"
∞∞5 7
$str
∞∞7 Z
{
∞∞Z [
username
∞∞[ c
}
∞∞c d
"
∞∞d e
,
∞∞e f
ex
∞∞g i
)
∞∞i j
;
∞∞j k
return
±± 

StatusCode
±± !
(
±±! "
$num
±±" %
,
±±% &
new
±±' *
{
±±+ ,
message
±±- 4
=
±±5 6
ErrInternalServer
±±7 H
}
±±I J
)
±±J K
;
±±K L
}
≤≤ 
}
≥≥ 	
[
∏∏ 	
HttpGet
∏∏	 
(
∏∏ 
$str
∏∏ 
)
∏∏ 
]
∏∏ 
[
ππ 	 
EnableRateLimiting
ππ	 
(
ππ 
$str
ππ (
)
ππ( )
]
ππ) *
public
∫∫ 
async
∫∫ 
Task
∫∫ 
<
∫∫ 
ActionResult
∫∫ &
<
∫∫& '
object
∫∫' -
>
∫∫- .
>
∫∫. /
GetLogStatistics
∫∫0 @
(
∫∫@ A
)
∫∫A B
{
ªª 	
try
ºº 
{
ΩΩ 
var
ææ 
username
ææ 
=
ææ 
User
ææ #
.
ææ# $
Identity
ææ$ ,
?
ææ, -
.
ææ- .
Name
ææ. 2
??
ææ3 5
UnknownValue
ææ6 B
;
ææB C
await
øø 
_logService
øø !
.
øø! "
LogAsync
øø" *
(
øø* +
LogInfo
øø+ 2
,
øø2 3
$"
øø4 6
$str
øø6 >
{
øø> ?
username
øø? G
}
øøG H
$str
øøH i
"
øøi j
)
øøj k
;
øøk l
var
¡¡ 
	totalLogs
¡¡ 
=
¡¡ 
await
¡¡  %
_mongoService
¡¡& 3
.
¡¡3 4

LogEntries
¡¡4 >
.
¡¡> ?!
CountDocumentsAsync
¡¡? R
(
¡¡R S
_
¡¡S T
=>
¡¡U W
true
¡¡X \
)
¡¡\ ]
;
¡¡] ^
var
¬¬ 
	errorLogs
¬¬ 
=
¬¬ 
await
¬¬  %
_mongoService
¬¬& 3
.
¬¬3 4

LogEntries
¬¬4 >
.
¬¬> ?!
CountDocumentsAsync
¬¬? R
(
¬¬R S
l
¬¬S T
=>
¬¬U W
l
¬¬X Y
.
¬¬Y Z
Level
¬¬Z _
==
¬¬` b
LogError
¬¬c k
)
¬¬k l
;
¬¬l m
var
√√ 
warningLogs
√√ 
=
√√  !
await
√√" '
_mongoService
√√( 5
.
√√5 6

LogEntries
√√6 @
.
√√@ A!
CountDocumentsAsync
√√A T
(
√√T U
l
√√U V
=>
√√W Y
l
√√Z [
.
√√[ \
Level
√√\ a
==
√√b d

LogWarning
√√e o
)
√√o p
;
√√p q
var
ƒƒ 
infoLogs
ƒƒ 
=
ƒƒ 
await
ƒƒ $
_mongoService
ƒƒ% 2
.
ƒƒ2 3

LogEntries
ƒƒ3 =
.
ƒƒ= >!
CountDocumentsAsync
ƒƒ> Q
(
ƒƒQ R
l
ƒƒR S
=>
ƒƒT V
l
ƒƒW X
.
ƒƒX Y
Level
ƒƒY ^
==
ƒƒ_ a
LogInfo
ƒƒb i
)
ƒƒi j
;
ƒƒj k
var
«« 
	yesterday
«« 
=
«« 
DateTime
««  (
.
««( )
UtcNow
««) /
.
««/ 0
AddDays
««0 7
(
««7 8
-
««8 9
$num
««9 :
)
««: ;
;
««; <
var
»» 
recent24hLogs
»» !
=
»»" #
await
»»$ )
_mongoService
»»* 7
.
»»7 8

LogEntries
»»8 B
.
»»B C!
CountDocumentsAsync
»»C V
(
»»V W
l
…… 
=>
…… 
l
…… 
.
…… 
	Timestamp
…… $
>=
……% '
	yesterday
……( 1
)
……1 2
;
……2 3
var
ÀÀ 

statistics
ÀÀ 
=
ÀÀ  
new
ÀÀ! $
{
ÃÃ 
	TotalLogs
ÕÕ 
=
ÕÕ 
	totalLogs
ÕÕ  )
,
ÕÕ) *
	ErrorLogs
ŒŒ 
=
ŒŒ 
	errorLogs
ŒŒ  )
,
ŒŒ) *
WarningLogs
œœ 
=
œœ  !
warningLogs
œœ" -
,
œœ- .
InfoLogs
–– 
=
–– 
infoLogs
–– '
,
––' (
RecentLogs24h
—— !
=
——" #
recent24hLogs
——$ 1
,
——1 2
	Timestamp
““ 
=
““ 
DateTime
““  (
.
““( )
UtcNow
““) /
}
”” 
;
”” 
return
’’ 
Ok
’’ 
(
’’ 

statistics
’’ $
)
’’$ %
;
’’% &
}
÷÷ 
catch
◊◊ 
(
◊◊ 
	Exception
◊◊ 
ex
◊◊ 
)
◊◊  
{
ÿÿ 
await
ŸŸ 
_logService
ŸŸ !
.
ŸŸ! "
LogAsync
ŸŸ" *
(
ŸŸ* +
LogError
ŸŸ+ 3
,
ŸŸ3 4
$str
ŸŸ5 \
,
ŸŸ\ ]
ex
ŸŸ^ `
)
ŸŸ` a
;
ŸŸa b
return
⁄⁄ 

StatusCode
⁄⁄ !
(
⁄⁄! "
$num
⁄⁄" %
,
⁄⁄% &
new
⁄⁄' *
{
⁄⁄+ ,
message
⁄⁄- 4
=
⁄⁄5 6
ErrInternalServer
⁄⁄7 H
}
⁄⁄I J
)
⁄⁄J K
;
⁄⁄K L
}
€€ 
}
‹‹ 	
[
·· 	
HttpGet
··	 
(
·· 
$str
·· 
)
·· 
]
·· 
[
‚‚ 	 
EnableRateLimiting
‚‚	 
(
‚‚ 
$str
‚‚ (
)
‚‚( )
]
‚‚) *
public
„„ 
async
„„ 
Task
„„ 
<
„„ 
ActionResult
„„ &
<
„„& '
IEnumerable
„„' 2
<
„„2 3
LogEntry
„„3 ;
>
„„; <
>
„„< =
>
„„= >

SearchLogs
„„? I
(
„„I J
[
‰‰ 
	FromQuery
‰‰ 
]
‰‰ 
string
‰‰ 

searchTerm
‰‰ )
,
‰‰) *
[
ÂÂ 
	FromQuery
ÂÂ 
]
ÂÂ 
int
ÂÂ 
limit
ÂÂ !
=
ÂÂ" #
$num
ÂÂ$ '
)
ÂÂ' (
{
ÊÊ 	
try
ÁÁ 
{
ËË 
if
ÈÈ 
(
ÈÈ 
string
ÈÈ 
.
ÈÈ  
IsNullOrWhiteSpace
ÈÈ -
(
ÈÈ- .

searchTerm
ÈÈ. 8
)
ÈÈ8 9
)
ÈÈ9 :
{
ÍÍ 
return
ÎÎ 

BadRequest
ÎÎ %
(
ÎÎ% &
new
ÎÎ& )
{
ÎÎ* +
message
ÎÎ, 3
=
ÎÎ4 5
$str
ÎÎ6 X
}
ÎÎY Z
)
ÎÎZ [
;
ÎÎ[ \
}
ÏÏ 
var
ÓÓ 
username
ÓÓ 
=
ÓÓ 
User
ÓÓ #
.
ÓÓ# $
Identity
ÓÓ$ ,
?
ÓÓ, -
.
ÓÓ- .
Name
ÓÓ. 2
??
ÓÓ3 5
UnknownValue
ÓÓ6 B
;
ÓÓB C
await
ÔÔ 
_logService
ÔÔ !
.
ÔÔ! "
LogAsync
ÔÔ" *
(
ÔÔ* +
LogInfo
ÔÔ+ 2
,
ÔÔ2 3
$"
 
$str
 
{
 
username
 '
}
' (
$str
( D
{
D E

searchTerm
E O
}
O P
"
P Q
)
Q R
;
R S
if
ÛÛ 
(
ÛÛ 
limit
ÛÛ 
<=
ÛÛ 
$num
ÛÛ 
||
ÛÛ !
limit
ÛÛ" '
>
ÛÛ( )
$num
ÛÛ* .
)
ÛÛ. /
limit
ÙÙ 
=
ÙÙ 
$num
ÙÙ 
;
ÙÙ  
var
ˆˆ 
filter
ˆˆ 
=
ˆˆ 
Builders
ˆˆ %
<
ˆˆ% &
LogEntry
ˆˆ& .
>
ˆˆ. /
.
ˆˆ/ 0
Filter
ˆˆ0 6
.
ˆˆ6 7
Regex
ˆˆ7 <
(
ˆˆ< =
l
˜˜ 
=>
˜˜ 
l
˜˜ 
.
˜˜ 
Message
˜˜ "
,
˜˜" #
new
¯¯ 
MongoDB
¯¯ 
.
¯¯  
Bson
¯¯  $
.
¯¯$ %#
BsonRegularExpression
¯¯% :
(
¯¯: ;

searchTerm
¯¯; E
,
¯¯E F
$str
¯¯G J
)
¯¯J K
)
¯¯K L
;
¯¯L M
var
˙˙ 
logs
˙˙ 
=
˙˙ 
await
˙˙  
_mongoService
˙˙! .
.
˙˙. /

LogEntries
˙˙/ 9
.
˚˚ 
Find
˚˚ 
(
˚˚ 
filter
˚˚  
)
˚˚  !
.
¸¸ 
SortByDescending
¸¸ %
(
¸¸% &
l
¸¸& '
=>
¸¸( *
l
¸¸+ ,
.
¸¸, -
	Timestamp
¸¸- 6
)
¸¸6 7
.
˝˝ 
Limit
˝˝ 
(
˝˝ 
limit
˝˝  
)
˝˝  !
.
˛˛ 
ToListAsync
˛˛  
(
˛˛  !
)
˛˛! "
;
˛˛" #
return
ÄÄ 
Ok
ÄÄ 
(
ÄÄ 
logs
ÄÄ 
)
ÄÄ 
;
ÄÄ  
}
ÅÅ 
catch
ÇÇ 
(
ÇÇ 
	Exception
ÇÇ 
ex
ÇÇ 
)
ÇÇ  
{
ÉÉ 
await
ÑÑ 
_logService
ÑÑ !
.
ÑÑ! "
LogAsync
ÑÑ" *
(
ÑÑ* +
LogError
ÑÑ+ 3
,
ÑÑ3 4
$"
ÑÑ5 7
$str
ÑÑ7 Y
{
ÑÑY Z

searchTerm
ÑÑZ d
}
ÑÑd e
"
ÑÑe f
,
ÑÑf g
ex
ÑÑh j
)
ÑÑj k
;
ÑÑk l
return
ÖÖ 

StatusCode
ÖÖ !
(
ÖÖ! "
$num
ÖÖ" %
,
ÖÖ% &
new
ÖÖ' *
{
ÖÖ+ ,
message
ÖÖ- 4
=
ÖÖ5 6
ErrInternalServer
ÖÖ7 H
}
ÖÖI J
)
ÖÖJ K
;
ÖÖK L
}
ÜÜ 
}
áá 	
}
àà 
}ââ ≈–
TC:\Users\trans\source\repos\LibrarySolution\LibraryAPI\Controllers\AuthController.cs
	namespace

 	

LibraryApp


 
.

 
Controllers

  
{ 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
[ 
EnableRateLimiting 
( 
$str $
)$ %
]% &
public 

class 
AuthController 
:  !
ControllerBase" 0
{ 
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
UserService $
_userService% 1
;1 2
private 
readonly 

Logservice #
_logService$ /
;/ 0
private 
const 
string 
LogError %
=& '
$str( /
;/ 0
private 
const 
string 

LogWarning '
=( )
$str* 3
;3 4
private 
const 
string 
LogInfo $
=% &
$str' 4
;4 5
private 
const 
string 
ErrInternalServer .
=/ 0
$str1 M
;M N
private 
const 
string 
UnknownValue )
=* +
$str, 5
;5 6
public 
AuthController 
( 
IConfiguration 
configuration (
,( )
UserService 
userService #
,# $

Logservice 

logService !
)! "
{ 	
_configuration   
=   
configuration   *
;  * +
_userService!! 
=!! 
userService!! &
;!!& '
_logService"" 
="" 

logService"" $
;""$ %
}## 	
['' 	
HttpPost''	 
('' 
$str'' 
)'' 
]'' 
public(( 
async(( 
Task(( 
<(( 
IActionResult(( '
>((' (
Register(() 1
(((1 2
[((2 3
FromBody((3 ;
]((; <
RegisterRequest((= L
request((M T
)((T U
{)) 	
try** 
{++ 
await,, 
_logService,, !
.,,! "
LogAsync,," *
(,,* +
LogInfo,,+ 2
,,,2 3
$",,4 6
$str,,6 X
{,,X Y
request,,Y `
.,,` a
Username,,a i
},,i j
",,j k
),,k l
;,,l m
if// 
(// 
string// 
.// 
IsNullOrWhiteSpace// -
(//- .
request//. 5
.//5 6
Username//6 >
)//> ?
||00 
string00 !
.00! "
IsNullOrWhiteSpace00" 4
(004 5
request005 <
.00< =
Password00= E
)00E F
||11 
string11 !
.11! "
IsNullOrWhiteSpace11" 4
(114 5
request115 <
.11< =
Email11= B
)11B C
)11C D
{22 
await33 
_logService33 %
.33% &
LogAsync33& .
(33. /

LogWarning33/ 9
,339 :
$str33; f
)33f g
;33g h
return44 

BadRequest44 %
(44% &
new44& )
{44* +
message44, 3
=444 5
$str446 a
}44b c
)44c d
;44d e
}55 
if88 
(88 
!88 
EmailValidator88 #
.88# $
IsValid88$ +
(88+ ,
request88, 3
.883 4
Email884 9
)889 :
)88: ;
{99 
await:: 
_logService:: %
.::% &
LogAsync::& .
(::. /

LogWarning::/ 9
,::9 :
$"::; =
$str::= p
{::p q
request::q x
.::x y
Email::y ~
}::~ 
"	:: Ä
)
::Ä Å
;
::Å Ç
return;; 

BadRequest;; %
(;;% &
new;;& )
{;;* +
message;;, 3
=;;4 5
$str;;6 L
};;M N
);;N O
;;;O P
}<< 
if?? 
(?? 
!?? 
PasswordValidator?? &
.??& '
IsValid??' .
(??. /
request??/ 6
.??6 7
Password??7 ?
)??? @
)??@ A
{@@ 
awaitAA 
_logServiceAA %
.AA% &
LogAsyncAA& .
(AA. /

LogWarningAA/ 9
,AA9 :
$strAA; |
)AA| }
;AA} ~
returnBB 

BadRequestBB %
(BB% &
newBB& )
{CC 
messageDD 
=DD  !
$str	DD" ú
}EE 
)EE 
;EE 
}FF 
varII 
allowedRolesII  
=II! "
newII# &
[II& '
]II' (
{II) *
$strII+ >
,II> ?
$strII@ O
,IIO P
$strIIQ `
}IIa b
;IIb c
ifLL 
(LL 
stringLL 
.LL 
IsNullOrEmptyLL (
(LL( )
requestLL) 0
.LL0 1
RoleLL1 5
)LL5 6
)LL6 7
{MM 
requestNN 
.NN 
RoleNN  
=NN! "
$strNN# 6
;NN6 7
}OO 
ifQQ 
(QQ 
!QQ 
allowedRolesQQ !
.QQ! "
ContainsQQ" *
(QQ* +
requestQQ+ 2
.QQ2 3
RoleQQ3 7
)QQ7 8
)QQ8 9
{RR 
awaitSS 
_logServiceSS %
.SS% &
LogAsyncSS& .
(SS. /

LogWarningSS/ 9
,SS9 :
$"SS; =
$strSS= c
{SSc d
requestSSd k
.SSk l
RoleSSl p
}SSp q
"SSq r
)SSr s
;SSs t
returnTT 

BadRequestTT %
(TT% &
newTT& )
{UU 
messageVV 
=VV  !
$strVV" z
}WW 
)WW 
;WW 
}XX 
varZZ 
userZZ 
=ZZ 
newZZ 
UserZZ #
{[[ 
Username\\ 
=\\ 
request\\ &
.\\& '
Username\\' /
.\\/ 0
Trim\\0 4
(\\4 5
)\\5 6
,\\6 7
Email]] 
=]] 
request]] #
.]]# $
Email]]$ )
.]]) *
Trim]]* .
(]]. /
)]]/ 0
.]]0 1
ToLowerInvariant]]1 A
(]]A B
)]]B C
,]]C D
Role^^ 
=^^ 
request^^ "
.^^" #
Role^^# '
,^^' (
	CreatedAt__ 
=__ 
DateTime__  (
.__( )
UtcNow__) /
,__/ 0
IsActive`` 
=`` 
true`` #
}aa 
;aa 
varcc 
createdUsercc 
=cc  !
awaitcc" '
_userServicecc( 4
.cc4 5
CreateUserAsynccc5 D
(ccD E
userccE I
,ccI J
requestccK R
.ccR S
PasswordccS [
)cc[ \
;cc\ ]
ifdd 
(dd 
createdUserdd 
==dd  "
nulldd# '
)dd' (
{ee 
awaitff 
_logServiceff %
.ff% &
LogAsyncff& .
(ff. /

LogWarningff/ 9
,ff9 :
$"ff; =
$strff= i
{ffi j
requestffj q
.ffq r
Usernameffr z
}ffz {
"ff{ |
)ff| }
;ff} ~
returngg 
Conflictgg #
(gg# $
newgg$ '
{gg( )
messagegg* 1
=gg2 3
$strgg4 I
}ggJ K
)ggK L
;ggL M
}hh 
awaitjj 
_logServicejj !
.jj! "
LogAsyncjj" *
(jj* +
LogInfojj+ 2
,jj2 3
$"jj4 6
$strjj6 W
{jjW X
requestjjX _
.jj_ `
Usernamejj` h
}jjh i
$strjji r
{jjr s
requestjjs z
.jjz {
Rolejj{ 
}	jj Ä
"
jjÄ Å
)
jjÅ Ç
;
jjÇ É
returnkk 
Okkk 
(kk 
newkk 
{ll 
messagemm 
=mm 
$strmm 9
,mm9 :
usernn 
=nn 
newnn 
{oo 
idpp 
=pp 
createdUserpp (
.pp( )
Idpp) +
,pp+ ,
usernameqq  
=qq! "
createdUserqq# .
.qq. /
Usernameqq/ 7
,qq7 8
emailrr 
=rr 
createdUserrr  +
.rr+ ,
Emailrr, 1
,rr1 2
roless 
=ss 
createdUserss *
.ss* +
Roless+ /
}tt 
}uu 
)uu 
;uu 
}vv 
catchww 
(ww 
	Exceptionww 
exww 
)ww  
{xx 
awaityy 
_logServiceyy !
.yy! "
LogAsyncyy" *
(yy* +
LogErroryy+ 3
,yy3 4
$"yy5 7
$stryy7 ]
{yy] ^
requestyy^ e
.yye f
Usernameyyf n
}yyn o
"yyo p
,yyp q
exyyr t
)yyt u
;yyu v
returnzz 

StatusCodezz !
(zz! "
$numzz" %
,zz% &
newzz' *
{zz+ ,
messagezz- 4
=zz5 6
ErrInternalServerzz7 H
}zzI J
)zzJ K
;zzK L
}{{ 
}|| 	
[
ÅÅ 	
HttpPost
ÅÅ	 
(
ÅÅ 
$str
ÅÅ 
)
ÅÅ 
]
ÅÅ 
public
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
IActionResult
ÇÇ '
>
ÇÇ' (
Login
ÇÇ) .
(
ÇÇ. /
[
ÇÇ/ 0
FromBody
ÇÇ0 8
]
ÇÇ8 9
LoginRequest
ÇÇ: F
request
ÇÇG N
)
ÇÇN O
{
ÉÉ 	
try
ÑÑ 
{
ÖÖ 
await
ÜÜ 
_logService
ÜÜ !
.
ÜÜ! "
LogAsync
ÜÜ" *
(
ÜÜ* +
LogInfo
ÜÜ+ 2
,
ÜÜ2 3
$"
ÜÜ4 6
$str
ÜÜ6 U
{
ÜÜU V
request
ÜÜV ]
.
ÜÜ] ^
Username
ÜÜ^ f
}
ÜÜf g
"
ÜÜg h
)
ÜÜh i
;
ÜÜi j
if
ââ 
(
ââ 
string
ââ 
.
ââ  
IsNullOrWhiteSpace
ââ -
(
ââ- .
request
ââ. 5
.
ââ5 6
Username
ââ6 >
)
ââ> ?
||
ââ@ B
string
ââC I
.
ââI J 
IsNullOrWhiteSpace
ââJ \
(
ââ\ ]
request
ââ] d
.
ââd e
Password
ââe m
)
ââm n
)
âân o
{
ää 
await
ãã 
_logService
ãã %
.
ãã% &
LogAsync
ãã& .
(
ãã. /

LogWarning
ãã/ 9
,
ãã9 :
$str
ãã; j
)
ããj k
;
ããk l
return
åå 

BadRequest
åå %
(
åå% &
new
åå& )
{
åå* +
message
åå, 3
=
åå4 5
$str
åå6 Z
}
åå[ \
)
åå\ ]
;
åå] ^
}
çç 
var
êê 
jwtSettings
êê 
=
êê  !
_configuration
êê" 0
.
êê0 1

GetSection
êê1 ;
(
êê; <
$str
êê< A
)
êêA B
;
êêB C
var
ëë 
jwtKey
ëë 
=
ëë 
jwtSettings
ëë (
.
ëë( )
GetValue
ëë) 1
<
ëë1 2
string
ëë2 8
>
ëë8 9
(
ëë9 :
$str
ëë: ?
)
ëë? @
;
ëë@ A
var
íí 
	jwtIssuer
íí 
=
íí 
jwtSettings
íí  +
.
íí+ ,
GetValue
íí, 4
<
íí4 5
string
íí5 ;
>
íí; <
(
íí< =
$str
íí= E
)
ííE F
;
ííF G
var
ìì 
jwtAudience
ìì 
=
ìì  !
jwtSettings
ìì" -
.
ìì- .
GetValue
ìì. 6
<
ìì6 7
string
ìì7 =
>
ìì= >
(
ìì> ?
$str
ìì? I
)
ììI J
;
ììJ K
if
ïï 
(
ïï 
string
ïï 
.
ïï 
IsNullOrEmpty
ïï (
(
ïï( )
jwtKey
ïï) /
)
ïï/ 0
)
ïï0 1
{
ññ 
await
óó 
_logService
óó %
.
óó% &
LogAsync
óó& .
(
óó. /
LogError
óó/ 7
,
óó7 8
$str
óó9 Q
)
óóQ R
;
óóR S
return
òò 

StatusCode
òò %
(
òò% &
$num
òò& )
,
òò) *
new
òò+ .
{
òò/ 0
message
òò1 8
=
òò9 :
$str
òò; W
}
òòX Y
)
òòY Z
;
òòZ [
}
ôô 
var
úú 
user
úú 
=
úú 
await
úú  
_userService
úú! -
.
úú- .$
GetUserByUserNameAsync
úú. D
(
úúD E
request
úúE L
.
úúL M
Username
úúM U
.
úúU V
Trim
úúV Z
(
úúZ [
)
úú[ \
)
úú\ ]
;
úú] ^
if
ûû 
(
ûû 
user
ûû 
==
ûû 
null
ûû  
||
ûû! #
!
ûû$ %
user
ûû% )
.
ûû) *
IsActive
ûû* 2
||
ûû3 5
!
ûû6 7
PasswordHasher
ûû7 E
.
ûûE F
VerifyPassword
ûûF T
(
ûûT U
request
ûûU \
.
ûû\ ]
Password
ûû] e
,
ûûe f
user
ûûg k
.
ûûk l
PasswordHash
ûûl x
)
ûûx y
)
ûûy z
{
üü 
await
†† 
_logService
†† %
.
††% &
LogAsync
††& .
(
††. /

LogWarning
††/ 9
,
††9 :
$"
††; =
$str
††= d
{
††d e
request
††e l
.
††l m
Username
††m u
}
††u v
"
††v w
)
††w x
;
††x y
return
°° 
Unauthorized
°° '
(
°°' (
new
°°( +
{
°°, -
message
°°. 5
=
°°6 7
$str
°°8 V
}
°°W X
)
°°X Y
;
°°Y Z
}
¢¢ 
var
•• 
key
•• 
=
•• 
new
•• "
SymmetricSecurityKey
•• 2
(
••2 3
Encoding
••3 ;
.
••; <
UTF8
••< @
.
••@ A
GetBytes
••A I
(
••I J
jwtKey
••J P
)
••P Q
)
••Q R
;
••R S
var
¶¶ 
creds
¶¶ 
=
¶¶ 
new
¶¶  
SigningCredentials
¶¶  2
(
¶¶2 3
key
¶¶3 6
,
¶¶6 7 
SecurityAlgorithms
¶¶8 J
.
¶¶J K

HmacSha256
¶¶K U
)
¶¶U V
;
¶¶V W
var
®® 
claims
®® 
=
®® 
new
®®  
[
®®  !
]
®®! "
{
©© 
new
™™ 
Claim
™™ 
(
™™ 

ClaimTypes
™™ (
.
™™( )
Name
™™) -
,
™™- .
user
™™/ 3
.
™™3 4
Username
™™4 <
)
™™< =
,
™™= >
new
´´ 
Claim
´´ 
(
´´ 

ClaimTypes
´´ (
.
´´( )
Role
´´) -
,
´´- .
user
´´/ 3
.
´´3 4
Role
´´4 8
)
´´8 9
,
´´9 :
new
¨¨ 
Claim
¨¨ 
(
¨¨ 

ClaimTypes
¨¨ (
.
¨¨( )
Email
¨¨) .
,
¨¨. /
user
¨¨0 4
.
¨¨4 5
Email
¨¨5 :
)
¨¨: ;
,
¨¨; <
new
≠≠ 
Claim
≠≠ 
(
≠≠ 
$str
≠≠ &
,
≠≠& '
user
≠≠( ,
.
≠≠, -
Id
≠≠- /
)
≠≠/ 0
,
≠≠0 1
new
ÆÆ 
Claim
ÆÆ 
(
ÆÆ 
$str
ÆÆ (
,
ÆÆ( )
user
ÆÆ* .
.
ÆÆ. /
IsActive
ÆÆ/ 7
.
ÆÆ7 8
ToString
ÆÆ8 @
(
ÆÆ@ A
)
ÆÆA B
)
ÆÆB C
}
ØØ 
;
ØØ 
var
±± 
token
±± 
=
±± 
new
±± 
JwtSecurityToken
±±  0
(
±±0 1
issuer
≤≤ 
:
≤≤ 
	jwtIssuer
≤≤ %
,
≤≤% &
audience
≥≥ 
:
≥≥ 
jwtAudience
≥≥ )
,
≥≥) *
claims
¥¥ 
:
¥¥ 
claims
¥¥ "
,
¥¥" #
expires
µµ 
:
µµ 
DateTime
µµ %
.
µµ% &
UtcNow
µµ& ,
.
µµ, -
AddHours
µµ- 5
(
µµ5 6
$num
µµ6 7
)
µµ7 8
,
µµ8 9 
signingCredentials
∂∂ &
:
∂∂& '
creds
∂∂( -
)
∂∂- .
;
∂∂. /
var
∏∏ 
tokenString
∏∏ 
=
∏∏  !
new
∏∏" %%
JwtSecurityTokenHandler
∏∏& =
(
∏∏= >
)
∏∏> ?
.
∏∏? @

WriteToken
∏∏@ J
(
∏∏J K
token
∏∏K P
)
∏∏P Q
;
∏∏Q R
await
∫∫ 
_logService
∫∫ !
.
∫∫! "
LogAsync
∫∫" *
(
∫∫* +
LogInfo
∫∫+ 2
,
∫∫2 3
$"
∫∫4 6
$str
∫∫6 R
{
∫∫R S
request
∫∫S Z
.
∫∫Z [
Username
∫∫[ c
}
∫∫c d
$str
∫∫d m
{
∫∫m n
user
∫∫n r
.
∫∫r s
Role
∫∫s w
}
∫∫w x
"
∫∫x y
)
∫∫y z
;
∫∫z {
return
ºº 
Ok
ºº 
(
ºº 
new
ºº 
{
ΩΩ 
token
ææ 
=
ææ 
tokenString
ææ '
,
ææ' (
expires
øø 
=
øø 
DateTime
øø &
.
øø& '
UtcNow
øø' -
.
øø- .
AddHours
øø. 6
(
øø6 7
$num
øø7 8
)
øø8 9
,
øø9 :
user
¿¿ 
=
¿¿ 
new
¿¿ 
{
¡¡ 
id
¬¬ 
=
¬¬ 
user
¬¬ !
.
¬¬! "
Id
¬¬" $
,
¬¬$ %
username
√√  
=
√√! "
user
√√# '
.
√√' (
Username
√√( 0
,
√√0 1
email
ƒƒ 
=
ƒƒ 
user
ƒƒ  $
.
ƒƒ$ %
Email
ƒƒ% *
,
ƒƒ* +
role
≈≈ 
=
≈≈ 
user
≈≈ #
.
≈≈# $
Role
≈≈$ (
}
∆∆ 
}
«« 
)
«« 
;
«« 
}
»» 
catch
…… 
(
…… 
	Exception
…… 
ex
…… 
)
……  
{
   
await
ÀÀ 
_logService
ÀÀ !
.
ÀÀ! "
LogAsync
ÀÀ" *
(
ÀÀ* +
LogError
ÀÀ+ 3
,
ÀÀ3 4
$"
ÀÀ5 7
$str
ÀÀ7 Z
{
ÀÀZ [
request
ÀÀ[ b
.
ÀÀb c
Username
ÀÀc k
}
ÀÀk l
"
ÀÀl m
,
ÀÀm n
ex
ÀÀo q
)
ÀÀq r
;
ÀÀr s
return
ÃÃ 

StatusCode
ÃÃ !
(
ÃÃ! "
$num
ÃÃ" %
,
ÃÃ% &
new
ÃÃ' *
{
ÃÃ+ ,
message
ÃÃ- 4
=
ÃÃ5 6
ErrInternalServer
ÃÃ7 H
}
ÃÃI J
)
ÃÃJ K
;
ÃÃK L
}
ÕÕ 
}
ŒŒ 	
[
”” 	
HttpGet
””	 
(
”” 
$str
”” 
)
”” 
]
”” 
[
‘‘ 	
	Microsoft
‘‘	 
.
‘‘ 

AspNetCore
‘‘ 
.
‘‘ 
Authorization
‘‘ +
.
‘‘+ ,
	Authorize
‘‘, 5
]
‘‘5 6
public
’’ 
async
’’ 
Task
’’ 
<
’’ 
IActionResult
’’ '
>
’’' (
VerifyToken
’’) 4
(
’’4 5
)
’’5 6
{
÷÷ 	
try
◊◊ 
{
ÿÿ 
var
ŸŸ 
username
ŸŸ 
=
ŸŸ 
User
ŸŸ #
.
ŸŸ# $
Identity
ŸŸ$ ,
?
ŸŸ, -
.
ŸŸ- .
Name
ŸŸ. 2
??
ŸŸ3 5
UnknownValue
ŸŸ6 B
;
ŸŸB C
var
⁄⁄ 
role
⁄⁄ 
=
⁄⁄ 
User
⁄⁄ 
.
⁄⁄  
	FindFirst
⁄⁄  )
(
⁄⁄) *

ClaimTypes
⁄⁄* 4
.
⁄⁄4 5
Role
⁄⁄5 9
)
⁄⁄9 :
?
⁄⁄: ;
.
⁄⁄; <
Value
⁄⁄< A
??
⁄⁄B D
UnknownValue
⁄⁄E Q
;
⁄⁄Q R
await
€€ 
_logService
€€ !
.
€€! "
LogAsync
€€" *
(
€€* +
LogInfo
€€+ 2
,
€€2 3
$"
€€4 6
$str
€€6 Z
{
€€Z [
username
€€[ c
}
€€c d
$str
€€d k
{
€€k l
role
€€l p
}
€€p q
$str
€€q r
"
€€r s
)
€€s t
;
€€t u
var
›› 
userInfo
›› 
=
›› 
new
›› "
{
ﬁﬁ 
username
ﬂﬂ 
=
ﬂﬂ 
User
ﬂﬂ #
.
ﬂﬂ# $
Identity
ﬂﬂ$ ,
?
ﬂﬂ, -
.
ﬂﬂ- .
Name
ﬂﬂ. 2
,
ﬂﬂ2 3
role
‡‡ 
=
‡‡ 
User
‡‡ 
.
‡‡  
	FindFirst
‡‡  )
(
‡‡) *

ClaimTypes
‡‡* 4
.
‡‡4 5
Role
‡‡5 9
)
‡‡9 :
?
‡‡: ;
.
‡‡; <
Value
‡‡< A
,
‡‡A B
email
·· 
=
·· 
User
··  
.
··  !
	FindFirst
··! *
(
··* +

ClaimTypes
··+ 5
.
··5 6
Email
··6 ;
)
··; <
?
··< =
.
··= >
Value
··> C
,
··C D
isAuthenticated
‚‚ #
=
‚‚$ %
User
‚‚& *
.
‚‚* +
Identity
‚‚+ 3
?
‚‚3 4
.
‚‚4 5
IsAuthenticated
‚‚5 D
??
‚‚E G
false
‚‚H M
}
„„ 
;
„„ 
return
ÂÂ 
Ok
ÂÂ 
(
ÂÂ 
userInfo
ÂÂ "
)
ÂÂ" #
;
ÂÂ# $
}
ÊÊ 
catch
ÁÁ 
(
ÁÁ 
	Exception
ÁÁ 
ex
ÁÁ 
)
ÁÁ  
{
ËË 
await
ÈÈ 
_logService
ÈÈ !
.
ÈÈ! "
LogAsync
ÈÈ" *
(
ÈÈ* +
LogError
ÈÈ+ 3
,
ÈÈ3 4
$str
ÈÈ5 ]
,
ÈÈ] ^
ex
ÈÈ_ a
)
ÈÈa b
;
ÈÈb c
return
ÍÍ 

StatusCode
ÍÍ !
(
ÍÍ! "
$num
ÍÍ" %
,
ÍÍ% &
new
ÍÍ' *
{
ÍÍ+ ,
message
ÍÍ- 4
=
ÍÍ5 6
ErrInternalServer
ÍÍ7 H
}
ÍÍI J
)
ÍÍJ K
;
ÍÍK L
}
ÎÎ 
}
ÏÏ 	
[
ÒÒ 	
HttpPost
ÒÒ	 
(
ÒÒ 
$str
ÒÒ 
)
ÒÒ 
]
ÒÒ 
[
ÚÚ 	
	Microsoft
ÚÚ	 
.
ÚÚ 

AspNetCore
ÚÚ 
.
ÚÚ 
Authorization
ÚÚ +
.
ÚÚ+ ,
	Authorize
ÚÚ, 5
]
ÚÚ5 6
public
ÛÛ 
async
ÛÛ 
Task
ÛÛ 
<
ÛÛ 
IActionResult
ÛÛ '
>
ÛÛ' (
Logout
ÛÛ) /
(
ÛÛ/ 0
)
ÛÛ0 1
{
ÙÙ 	
try
ıı 
{
ˆˆ 
var
˜˜ 
username
˜˜ 
=
˜˜ 
User
˜˜ #
.
˜˜# $
Identity
˜˜$ ,
?
˜˜, -
.
˜˜- .
Name
˜˜. 2
??
˜˜3 5
UnknownValue
˜˜6 B
;
˜˜B C
var
¯¯ 
role
¯¯ 
=
¯¯ 
User
¯¯ 
.
¯¯  
	FindFirst
¯¯  )
(
¯¯) *

ClaimTypes
¯¯* 4
.
¯¯4 5
Role
¯¯5 9
)
¯¯9 :
?
¯¯: ;
.
¯¯; <
Value
¯¯< A
??
¯¯B D
UnknownValue
¯¯E Q
;
¯¯Q R
await
˘˘ 
_logService
˘˘ !
.
˘˘! "
LogAsync
˘˘" *
(
˘˘* +
LogInfo
˘˘+ 2
,
˘˘2 3
$"
˘˘4 6
$str
˘˘6 K
{
˘˘K L
username
˘˘L T
}
˘˘T U
$str
˘˘U \
{
˘˘\ ]
role
˘˘] a
}
˘˘a b
$str
˘˘b c
"
˘˘c d
)
˘˘d e
;
˘˘e f
return
˚˚ 
Ok
˚˚ 
(
˚˚ 
new
˚˚ 
{
˚˚ 
message
˚˚  '
=
˚˚( )
$str
˚˚* C
}
˚˚D E
)
˚˚E F
;
˚˚F G
}
¸¸ 
catch
˝˝ 
(
˝˝ 
	Exception
˝˝ 
ex
˝˝ 
)
˝˝  
{
˛˛ 
await
ˇˇ 
_logService
ˇˇ !
.
ˇˇ! "
LogAsync
ˇˇ" *
(
ˇˇ* +
LogError
ˇˇ+ 3
,
ˇˇ3 4
$str
ˇˇ5 N
,
ˇˇN O
ex
ˇˇP R
)
ˇˇR S
;
ˇˇS T
return
ÄÄ 

StatusCode
ÄÄ !
(
ÄÄ! "
$num
ÄÄ" %
,
ÄÄ% &
new
ÄÄ' *
{
ÄÄ+ ,
message
ÄÄ- 4
=
ÄÄ5 6
ErrInternalServer
ÄÄ7 H
}
ÄÄI J
)
ÄÄJ K
;
ÄÄK L
}
ÅÅ 
}
ÇÇ 	
}
ÉÉ 
public
ÖÖ 

class
ÖÖ 
LoginRequest
ÖÖ 
{
ÜÜ 
public
áá 
string
áá 
Username
áá 
{
áá  
get
áá! $
;
áá$ %
set
áá& )
;
áá) *
}
áá+ ,
=
áá- .
string
áá/ 5
.
áá5 6
Empty
áá6 ;
;
áá; <
public
àà 
string
àà 
Password
àà 
{
àà  
get
àà! $
;
àà$ %
set
àà& )
;
àà) *
}
àà+ ,
=
àà- .
string
àà/ 5
.
àà5 6
Empty
àà6 ;
;
àà; <
}
ââ 
public
ãã 

class
ãã 
RegisterRequest
ãã  
:
ãã! "
LoginRequest
ãã# /
{
åå 
public
çç 
string
çç 
Email
çç 
{
çç 
get
çç !
;
çç! "
set
çç# &
;
çç& '
}
çç( )
=
çç* +
string
çç, 2
.
çç2 3
Empty
çç3 8
;
çç8 9
public
éé 
string
éé 
Role
éé 
{
éé 
get
éé  
;
éé  !
set
éé" %
;
éé% &
}
éé' (
=
éé) *
$str
éé+ >
;
éé> ?
}
èè 
}êê 